.\" lumosupgrade(1) manual entry ("manpage") for printing by command-line users
.\" via the man(1) command.  This file also contains hints used by our quick-and-
.\" dirty script which reformats it into the overall Lumos user manual set.  These
.\" are in comments and won't interfere with troff/groff/nroff formatting.
.\" 
.\" Copyright (c) 2013, 2014 by Steven L. Willoughby, Aloha, Oregon, USA.
.\" All Rights Reserved.  Released under the terms and conditions of the
.\" Open Software License (see the LICENSE file which accompanied this software
.\" release for details.)
.\"
.\" <<bold-is-fixed>> <<ital-is-var>>
.TH LUMOSUPGRADE 1 2.0 "Lumos SSR Controller" "Utility Commands"
.SH NAME
lumosupgrade \- Download new firmware image into Lumos controller hardware
.SH SYNOPSIS
.B lumosupgrade
.RB [ \-fhNnRv ]
.B \-a
.I addr
.RB [ \-b
.IR speed ]
.RB [ \-L
.IR txlvl ]
.RB [ \-m
.IR txdelay ]
.RB [ \-p
.IR port ]
.RB [ \-T
.IR mode ]
.I image-file
.SH DESCRIPTION
.LP
This command places the target Lumos controller device into
\*(lqflash program mode\*(rq and downloads a new firmware image
onto it.  This is used in order to upgrade the Lumos firmware
to a new version.
.LP
To upgrade your controller's firmware, perform the following steps:
.\" <<enumerate>>
.TP 3
1.
Connect your Lumos controller board to the host PC (all by itself,
not sharing a serial connection with other devices). The connection
must be bidirectional as the Lumos board needs to be able to acknowledge
receipt of the new image.  (This may require setting your PC's RS-485 
interface appropriately so it may send and receive data.  Pay attention
to whether your Lumos board is full- or half-duplex.)
.TP
2.
Place the Lumos board into configuration mode (previously called
\*(lqprivileged mode\*(rq).
.TP
3. 
Invoke the
.B lumosupgrade
program to load a new firmware image onto it, as explained in
the remainder of this manual page.
.\" <</>>
.LP
Once started, this process must run to successful completion
before the Lumos board may be used for normal operations again.
If anything goes amiss, the Lumos board may be reset and the 
.B lumosupgrade
program restarted using the
.B \-\-resume
option.  (Upon reset, the Lumos board will stay in
flash program mode until a new image has been loaded into it.  Should the
board reset/reboot for any reason during the process, the 
.B lumosupgrade
process must be started over to ensure a complete image is loaded.)
.SH OPTIONS
.LP
Each of the following options may be specified by either a long
option (like
.RB \*(lq \-\-verbose \*(rq)
or a shorter option letter (like
.RB \*(lq \-v \*(rq).
If an option takes a parameter, it may follow the option as
.RB \*(lq \-a12 \*(rq,
.RB \*(lq "\-a 12" \*(rq,
.RB \*(lq "\-\-address 12" \*(rq,
or
.RB \*(lq "\-\-address=12" \*(rq.
.LP
Long option names may be abbreviated to any unambiguous initial substring.
.TP 19 \" <<list>>
.BI \-\-address= addr
.RB ( \-a
.IR addr )
Specifies the address of the target controller unit.  The
.I addr
value is an integer from 0 to 15, inclusive.  
Note that downloading a new firmware image must be done when the
target unit is the
only
device plugged in to the computer.  Once the download operation is
underway, the low-level protocol used to transmit the image to the
device is not necessarily compatible with other units.  This option
is required because the command to place the device into flash program
mode must be addressed to the unit.
.TP
.B \-\-dry\-run
.RB ( \-n )
Do everything except actually burn the new firmware into the unit.
This checks that the 
.I image-file
is reasonably sane-looking (not a thorough check of correctness),
and communicates with the Lumos controller up to the point where
it would put it into flash program mode.
.TP
.B \-\-force
.RB ( \-f )
Force upgrade of the board without asking the user for confirmation.
.TP
.B \-\-help
.RB ( \-h )
Print a summary of these options and exit.
.TP
.B \-\-null\-device
.RB ( \-N )
Don't actually communicate with the serial port, but still carry out the other
actions including sanity checks on 
.IR image-file .
Implies
.BR \-\-dry\-run .
.TP
.BI \-\-port= dev
.RB ( \-p
.IR dev )
Specifies the I/O port the Lumos device is connected to.  This may be a simple integer 0, 1, 2, etc.
to refer to the first, second, third, etc, standard serial port on the system, or a device name appropriate
to the system such as 
.BR COM1 ,
.BR ttys1 ,
or 
.BR /dev/ttys1 .
.TP
.B \-\-resume
.RB ( \-R )
Indicates that the Lumos board was reset prematurely while attempting an upgrade.  Since the
Lumos board will still be in flash programming mode (and therefore won't
be in a position to recognize the Lumos-protocol command to begin a flash
programming operation), this option tells 
.B lumosupgrade
to simply start downloading the image onto it, and to not try to put it 
into programming mode first.
.TP
.BI \-\-speed= rate
.RB ( \-b
.IR rate )
Set the serial port to the given
baud
.IR rate .
This is the speed the Lumos board is already configured to use, and will be used for the initial
command to enter flash programming mode.  Once in flash programming mode, however, a fixed speed of 9600
baud will be used.
[Default is 19200 baud.]
.TP
.BI \-\-txdelay= t
.RB ( \-m
.IR ms )
Delay
.I ms
milliseconds after changing the transmitter control line for half-duplex networks.
.TP
.BR \-\-txlevel= { 0 | 1 }
.RB ( \-L
.RB { 0 | 1 })
Specifies the logic level used to signal transmit mode for half-duplex networks. A 
.B 1
indicates that the DTR or RTS line (as selected by the
.B \-\-txmode
option) is asserted to transmit, while a
.B 0
means the line is deasserted to transmit.
.TP
.BR \-\-txmode= { dtr | rts }
.RB ( \-T
.RB { dtr | rts })
Specifies which I/O line is used to signal transmit mode on half-duplex networks.
.TP
.B \-\-verbose
.RB ( \-v )
Output messages to the standard output.  Additional 
.B \-\-verbose
options increase verbosity.  High levels of verbosity include a dump
of every bit sent or received on the serial network.
.\" <</>>
.SH "FILE FORMAT"
.LP
The firmware
.I image-file
is expected to be in standard Intel Hex format.  Attempts to change memory
addresses outside the supported range will be ignored, including configuration
fuses and EEPROM area.  Actually, only a reasonable subset of the Intel Hex
format is supported; specifically, record types
.B 00
(data record),
.B 01
(end of file),
and
.B 04
(extended address)
are recognized.
.SH AUTHOR
.LP
Steve Willoughby,
support@madscience.zone
.SH COMPATIBILITY
.LP
This version of 
.B lumosupgrade
is compatible with the following boards:
.TP 2 \" <<itemize>> <</ital-is-var>>
*
Lumos 24-channel DC controller version 1.0 (boards with ID markings beginning with
\*(lqLUMOS-24SSR-DC-1.0\*(rq).
.TP
*
Lumos 4-channel DC controller version 1.0 (boards with ID markings beginning with
\*(lqLUMOS-4SSR-DC-1.0\*(rq).
.\" <</>>
.LP
.I "The 48-channel controllers are not compatible with this program."
.I "These boards must be reprogrammed using a microcontroller programmer."
.SH HISTORY
.LP
This program first appeared to support Lumos ROM version 3.0.
.SH "SEE ALSO"
.BR lumosctl (1).
