\documentclass[letterpaper,twoside,onecolumn,openright,final]{memoir}
%    vs.       others...   oneside twocolumn openleft  draft showtrims
%                          twoside onecolumn openany   ms
%                                            openright final 
\input lumos_common
\usepackage{fdsymbol}
\begin{document}
\renewcommand\QSoption{1}
\hypersetup{
	pdftitle={Using the Lumos SSR Controllers},
	pdfkeywords={Lumos Light Orchestration System Hardware User Manual}
}
\newcommand\z[1]{{\ttfamily #1}}
\newcommand{\colorbitbox}[3]{%
  \rlap{\bitbox{#2}{\color{#1}\rule{\width}{\height}}}%
  \bitbox{#2}{#3}}
\newenvironment{BF}{\begin{center}\begin{bytefield}{8}\bitheader{0-7}\\}{\end{bytefield}\end{center}}
\definecolor{lightgray}{gray}{0.8}
\frontmatter
  \def\lightxbase{0}
  \def\light#1#2{%
    % \light{A/G/Y/R/G2/Y2/R2}{on/off/}   at \y
    % A  G  Y  R            -- both 48 AND 24
    % A1 G1 Y1 R1 G2 Y2 R2  -- 48 only
    % A0 G0 Y0 R0           -- 24 only
    \ifthenelse{\equal{#1}{A}}{\def\lightx{0}\def\lightc{yellow}\def\lighty{.3}\def\lightxx{1.8}\def\lightyy{.45}}{%
      \ifthenelse{\equal{#1}{G}}{\def\lightx{.3}\def\lightc{green}\def\lighty{.3}\def\lightxx{1.5}\def\lightyy{.3}}{%
        \ifthenelse{\equal{#1}{Y}}{\def\lightx{.6}\def\lightc{yellow}\def\lighty{.3}\def\lightxx{1.8}\def\lightyy{.15}}{%
          \ifthenelse{\equal{#1}{R}}{\def\lightx{.9}\def\lightc{red}\def\lighty{.3}\def\lightxx{1.5}\def\lightyy{0}}{%
            \ifthenelse{\equal{#1}{G2}}{\def\lightx{.3}\def\lightc{green}\def\lighty{0}\def\lightxx{}\def\lightyy{}}{%
              \ifthenelse{\equal{#1}{Y2}}{\def\lightx{.6}\def\lightc{yellow}\def\lighty{0}\def\lightxx{}\def\lightyy{}}{%
                \ifthenelse{\equal{#1}{R2}}{\def\lightx{.9}\def\lightc{red}\def\lighty{0}\def\lightxx{}\def\lightyy{}}{%
		  \ifthenelse{\equal{#1}{G1}}{\def\lightx{.3}\def\lightc{green}\def\lighty{.3}\def\lightxx{}\def\lightyy{}}{%
		    \ifthenelse{\equal{#1}{Y1}}{\def\lightx{.6}\def\lightc{yellow}\def\lighty{.3}\def\lightxx{}\def\lightyy{}}{%
		      \ifthenelse{\equal{#1}{R1}}{\def\lightx{.9}\def\lightc{red}\def\lighty{.3}\def\lightxx{}\def\lightyy{}}{%
		        \ifthenelse{\equal{#1}{A1}}{\def\lightx{0}\def\lightc{yellow}\def\lighty{.3}\def\lightxx{}\def\lightyy{}}{%
		          \ifthenelse{\equal{#1}{G0}}{\def\lightx{1.5}\def\lightc{green}\def\lighty{.3}\def\lightxx{}\def\lightyy{}}{%
		            \ifthenelse{\equal{#1}{Y0}}{\def\lightx{1.8}\def\lightc{yellow}\def\lighty{.15}\def\lightxx{}\def\lightyy{}}{%
		              \ifthenelse{\equal{#1}{R0}}{\def\lightx{1.5}\def\lightc{red}\def\lighty{0}\def\lightxx{}\def\lightyy{}}{%
		                \ifthenelse{\equal{#1}{A0}}{\def\lightx{1.8}\def\lightc{yellow}\def\lighty{.45}\def\lightxx{}\def\lightyy{}}{%
		                }%
        		      }%
        		    }%
        		  }%
		        }%
		      }%
		    }%
		  }%
		}%
              }%
            }%
          }%
        }%
      }%
    }
    \draw [fill, color=\lightc] (\lightx+\lightxbase,\y+\lighty) circle (.1);
    \lightstate{#2}{\lightx+\lightxbase}{\lighty}
    \ifthenelse{\equal{\lightxx}{}}{}{%
      \draw [fill, color=\lightc] (\lightxx+\lightxbase,\y+\lightyy) circle (.1);
      \lightstate{#2}{\lightxx+\lightxbase}{\lightyy}
    }%
  }%
  \def\lightstate#1#2#3{%
    \ifthenelse{\equal{#1}{on}}{\draw [thick] (#2,\y+#3) circle (.1);}{%
      \ifthenelse{\equal{#1}{off}}{\draw [thick, fill, color=gray] (#2,\y+#3) circle (.1);}{%
        \ifthenelse{\equal{#1}{sfd}}{\draw [thick, dashed] (#2,\y+#3) circle (.1);}{%
          \ifthenelse{\equal{#1}{x}}{\draw [thick, fill, color=white] (#2,\y+#3) circle (.1);\draw (#2,\y+#3) -- +(-.1,-.1) -- +(.1,.1) -- +(0,0) -- +(-.1,.1) -- +(.1,-.1);}{%
            \ifthenelse{\equal{#1}{sfl}}{\draw [thick, dotted] (#2,\y+#3) circle (.1);}{%
              \ifthenelse{\equal{#1}{ffl}}{\draw [thick, dotted] (#2,\y+#3) circle (.1);\draw [thick] (#2,\y+#3) circle (.05);}{%
                \ifthenelse{\equal{#1}{blk}}{\draw [thick] (#2,\y+#3) circle (.1); \draw [thick] (#2,\y+#3) -- +(-.1,0) -- +(.1,0) -- +(0,0) -- +(0,-.1) -- +(0,.1);}{%
                  \ifthenelse{\equal{#1}{ffd}}{\draw [thick, dashed] (#2,\y+#3) circle (.1); \draw [thick] (#2,\y+#3) circle (.05);}{%
                    \ifthenelse{\equal{#1}{sss}}{\draw [thick, dashed] (#2,\y+#3) circle (.1); \draw [thick] (#2,\y+#3) circle (.02);}{%
 		    }%
		  }%
	        }%
  	      }%
 	    }%
 	  }%
  	}%
      }%
    }%
  }%

\thispagestyle{empty}
\ThisLLCornerWallPaper{1}{images/cover}
%\strut 
%\vfill
\begin{center}
{\fontfamily{ppl}\fontseries{b}\fontsize{48}{50}\selectfont
Using the\\Lumos\TM\\SSR\\Controllers\\\strut

\vfill
}
\end{center}

\newpage
\begin{center}
\LLimg[width=1in]{danger-generic}

%DANGER! 

\mc{RISK OF FIRE, ELECTROCUTION, SERIOUS INJURY OR DEATH!} 
\end{center}

This circuit design, including but not limited to any associated plans, schematics, designs, board layouts, documentation, 
and/or components, is \mc{EXPERIMENTAL} and for \mc{EDUCATIONAL} purposes only. It is not a finished consumer-grade product.
It is assumed that you have the necessary understanding and skill to assemble and/or use electronic circuits.

Proceed \mc{ONLY} if you know exactly what you are doing, understand the proper procedures for working with the high voltage present on the components and PC boards, and understand that you do so \mc{ENTIRELY AT YOUR OWN RISK.}

The author makes \mc{NO} representation as to suitability or fitness for any purpose whatsoever, and disclaims any and all liability or warranty to the full extent permitted by applicable law.
\index{warranty, limitation of}
\index{danger warnings}
\index{warnings}

\strut\vfill
\noindent Edition 2.2, for Lumos controllers with \acronym{ROM} version 3.1.

\smallskip


\noindent Copyright \copyright\ 2013, 2014, 2022 by Steven L. Willoughby,
Aloha, Oregon, USA.  All Rights Reserved.  
This document is released under the terms and conditions of the 
Creative Commons ``Attribution-NoDerivs 3.0 Unported'' license.  
In summary, you are free to use, reproduce, and redistribute this 
document provided you give full attribution to its author and do not
alter it or create derivative works from it.  See
\URL{http://creativecommons.org/licenses/by\-nd\-/\-3.0/} for the full
set of licensing terms.

\begin{center}
\LLimg[width=.5in]{cc}\LLimg[width=.5in]{by}\LLimg[width=.5in]{nd}
\end{center}

\newpage
\tableofcontents
\newpage
\listoffigures
%\listoftables

\mainmatter

\chapter{Introduction}
\LLstart{C}{ongratulations}{on joining} the many computer-controlled
Christmas light enthusiasts, \ix{theatrical lighting} technicians, electronics hobbyists,
\index{Christmas lights}
and home automation innovators who are experimenting with new ways to have computers
control lights and other electronic devices.

This manual details the software controls implemented by the Lumos controllers
and the communication protocols they use with the host PC.

\section{Intended Audience}
This is an ``advanced'' level do-it-yourself electronic circuit project.  It is not
an off-the-shelf consumer-ready product.  It is only designed for educational and experimental
use by experienced hobbyists and professionals who possess the skill to construct electronic
\marginpar{\centerline{\LLimg[height=.5in]{danger-sign}}}
circuits, to understand how they function, troubleshoot problems with them, and to use them safely.

This manual provides
basic usage and configuration instructions suitable for all users of
Lumos controllers.

Some of the information in this manual gives a level of technical detail suited to advanced
users and software developers who need to understand the workings of Lumos controllers
to write applications which interace with them.  

\section{Limitation of Warranty}
\index{danger warnings}
\index{warnings}
\index{warranty, limitation of}
Since this is a do-it-yourself project, the quality of the final product, and whether it 
functions as intended, is largely a result of your own efforts in building it.  As such, we
cannot offer to troubleshoot, repair, or replace a board we did not assemble for you.  Accordingly,
\marginpar{\centerline{\LLimg[height=.5in]{danger-sign}}}
these instructions, and all accompanying plans, schematics, software, hardware, and other
project materials are provided to you ``\mc{AS-IS}'' at no cost, as a courtesy between 
\acronym{DIY} hobbyists with \mc{NO WARRANTY} of any kind expressed or implied.  If you proceed
to build and/or use this unit, you do so \mc{ENTIRELY AT YOUR OWN RISK}.

If you purchased hardware materials from us (such as a PC board or programmed controller chip),
we will---at our sole discretion---replace, repair, or refund the cost of those materials if they were defective in manufacture
as shipped to you, up to 90~days from the date they were shipped to you,
but are not liable for damage caused by your handling or assembly of the unit.
Otherwise, we make no representation of suitability or fitness for any particular purpose and disclaim
all other warranty or liability of any kind to the full extent permitted by law.

\section{How to Use this Manual}
Start with the information in the first part of the manual to learn how to operate and configure
your Lumos controller, and how to use the host PC to alter its configuration settings.

If you need to koow the low-level details concerning how the board communicates with the PC,
continue reading the more advanced material which comprises the remainder of this manual.

\section{The Name of the Game}
\index{Lumos, the name}
The name ``Lumos'' is a combination of \emph{lumen}, the Latin word for ``light,''
and the initial letters of ``Orchestration System.''  Hence, ``Light Orchestration System''
which is the most common application for which the Lumos hardware and software are used---running
computerized lighting displays.

\section{Getting Additional Help}
The \ix{product website} at \URL{www.madscience.zone/lumos} contains additional documentation,
\index{website}
pointers, hints, and tips to assist you further.  If that doesn't answer all your questions,
there is an \ix{online forum} where you may submit questions for help.

\section{DMX Compatibility Warning}
These boards do not support the \acronym{DMX512} protocol, although we have experimented with
this as a feature.  As such, the firmware includes a ``\acronym{DMX512} mode'' which the board
and accompanying software will recognize.  However, this is still experimental and does not yet
function enough for actual production use.  While this feature may be ready for use in a future
upgrade to these boards, at present the Lumos boards will only work in native Lumos (not \acronym{DMX512})
mode.

{\bfseries Any and all references in the Lumos manuals to ``\acronym{DMX}'' modes should
be regarded as describing experimental features not yet ready for actual production use.}

\chapter{Safety Information}\label{ch:safety}

\LLstart{B}{efore}{you use} your Lumos controller, please take the time to
carefully read the following \ix{safety precautions}.  Failure to follow this advice could
result in death or serious injury, damage to the Lumos controller unit, and/or damage
to the other devices plugged into the controller.
\index{danger warnings}
\index{warnings}

\section{Small Part Danger}
This board contains small parts which could pose a \ix{choking hazard} to small children.
This product is not a toy and is not intended for use by children in any circumstance.
The small parts on the product can be swallowed by children under 4~years of age. Keep
\marginpar{\centerline{\LLimg[height=.5in]{danger-generic}}}
out of reach of children.

\section{Hazardous Voltage}
Exercise care when working with any electrical system, including one such as the Lumos DC
controllers (even though in theory they deal with low voltages).  The power supplies of the
loads plugged into the Lumos controller, and even the power loads being controlled, may present
\marginpar{\centerline{\LLimg[width=.5in]{danger-shock}}}
a \ix{shock hazard} if not wired and handled using standard safety protocols.  Never touch or work
with live circuits. Always disconnect the power source before working on your Lumos controller.

When working with loads outdoors, be sure all supplies are plugged into \acronym{GFIC}-protected
circuits.

\section{Electrostatic Discharge (ESD) Warning}
Many of the components used in this project are sensitive to static electricity.  Always use a proper
\acronym{ESD}-safe work environment when handling them, or these parts may be permanently damaged.  If
a part is damaged in this way, 
\marginpar{\centerline{\LLimg[height=.5in]{esd_symbol_l}}}
it is impossible to tell by looking at the part, and you won't necessarily
feel the \ix{static discharge} which caused the damage.  Never take the risk of handling sensitive components
without \acronym{ESD} protection in place.
\index{danger warnings}
\index{warnings}

These parts include all transistors (Q0--Q23), voltage regulators (U6--U8 and U11), diodes (D0--D11),
and integrated circuits (U0--U5, U9--U10, and U12--U13).

\section{Circuit Loading}
Always respect the maximum voltage and current capacity of the board and your wiring.  Overloading any
\index{overloaded circuits}
\index{maximum limits}
of these may result serious injury, death, fire, and/or severe damage to any or all of the devices in use.

Each block of eight controlled loads may not exceed 
\marginpar{\centerline{\LLimg[height=.5in]{danger-sign}}}
10\,A total for the block.  
Each single output channel
may not exceed 5\,A.  These should be considered \emph{absolute maximum} tolerances.  The board was designed
to operate at sustained levels below those limits.

Also note that the Lumos output circuits were designed to control simple resistive loads such as
incandescent lights.  They are not appropriate for all kinds of loads.  Some inductive loads
(for example, electromagnetic relays and motors) may require a protective ``snubber'' circuit
which would be a custom modification to the Lumos circuit requiring qualified engineering work.
%
%between the Lumos output and the load to avoid damage to the Lumos board and/or the attached load.
%(See Figure~\ref{fig:snubber} on page~\pageref{fig:snubber}.)

Do not plug any load into a Lumos board which cannot be dimmed.

\chapter{Overview of the Lumos Controller Models}
\LLstart{T}{here}{are currently} five different hardware projects which are part of the Lumos
family of controllers, which are the subject of this manual:
\section{48-Channel Controller}
\begin{figure}
  \begin{center}
    \LLimg{48ctl}
  \end{center}
  \caption{Lumos 48-Channel Controller}
\end{figure}
This board controls 48 channels of outputs but does not contain any actual relay circuits of its own.
The \acronym{TTL}-level outputs are designed to be sent directly to a 24-channel relay board (AC, DC,
or one of each), although of course they could be connected to another compatible circuit.
\index{Lumos 48-channel controller}

The controller supports only half-duplex RS-485 communications.
It occupies a single address for the Lumos command protocol.  When in \acronym{DMX512} mode, it consumes
48 slots beginning at an arbitrarily-configured starting slot number.

This board contains its own power supply.  It accepts a 120\,V~AC input (with provision for an
optional power switch built-in).  This power source provides the +5\,V~DC supply for the controller
itself as well as the logic-side components of the relay boards to which it is connected.  The controller
also uses this AC supply to pick up the power waveform's zero-crossing point for AC relay board
dimmer synchronization.  This means that it is necessary that the AC power supplied to the controller
be in phase with the power supply to the relays' loads (or exactly 180$^\circ$ out of phase).  This should
be the case in any standard residential or commercial office environment.

\emph{Although a few prototypes of this board have been built and used successfully, it has not yet been
released as an open-hardware project.  We may do so in the future, possibly with an enhanced circuit
design.}

\section{48-Channel Front Panel}
\begin{figure}
  \begin{center}
    %\LLimg{IMG393}
    \LLimg{fp-assembled}
  \end{center}
  \caption{Lumos 48-Channel Front Panel}
\end{figure}
\index{Lumos front panel}
Designed to work with the Lumos 48-Channel controller, this panel is connected to the controller's outputs
in parallel with the relay boards.  It provides an \acronym{LED} for each output channel, allowing you
to see at a glance the activity and state of all outputs.  Additionally, it has \acronym{LED}s which show
that power is being sent to the relays, cable check \acronym{LED}s to show that the cables are plugged in
the entire length of the network, and serial I/O status indicators. It allows for the controller's status
\acronym{LED}s to be displayed on the front panel as well.

This board also contains a pair of RS-232-to-\ix{RS-485 converters@\acronym*{RS-485} converters}, one \ix{full-duplex} and one \ix{half-duplex}.
These may be switched between two modes: one where the host PC is always holding the bus to transmit
constantly (or at least at will), and the other where the PC can turn the transmitter on or off by
changing the state of the \acronym{DTR} line.

\emph{Although a few prototypes of this board have been built and used successfully, it has not yet been
released as an open-hardware project.  We may do so in the future, possibly with an enhanced circuit
design.}

\section{24-Channel AC Relay}
\begin{figure}
  \begin{center}
    \LLimg{24ac}
  \end{center}
  \caption{Lumos 24-Channel AC Relay}
\end{figure}
\index{Lumos 24-channel AC SSR}
This board controls 24 output channels of 120\,V~AC, arranged in three separate blocks of 8~channels.
Each block is separately powered and completely isolated from the other blocks and from the low-voltage
logic side of the board (which connects to the controller).  Each block is designed to supply up to
5\,A per channel, with a maximum of 8\,A total per block at any given time.

\emph{Although a few prototypes of this board have been built and used successfully, it has not yet been
released as an open-hardware project.  We may do so in the future, possibly with an enhanced circuit
design.}
\section{24-Channel DC Controller/Relay}
\begin{figure}
  \begin{center}
    \LLimg{lumosboard}
  \end{center}
  \caption{Lumos 24-Channel DC Controller/Relay}
\end{figure}
\index{Lumos 24-channel DC SSR}
This board controls 24 output channels for low-voltage~DC loads, arranged in three separate blocks 
of 8~channels.  Each block is separately powered and completely isolated from the other blocks and 
from the logic side of the board (i.e., the on-board controller or connection to an external
controller).  Each block may be powered with +5\,V~DC or a voltage from +8 to +24\,V~DC and
is designed to supply up to 5\,A per channel, with a maximum of 10\,A total per block at any 
given time.

Unlike the AC relay board described above, this may be constructed as a relay-only board (and attached
to something like the Lumos 48-Channel controller) or as a stand-alone controller itself.  In the latter
configuration, it uses one address for Lumos-protocol communication, or 24 \acronym{DMX512} slots.
Communications options (selected permanently at the time the controller is assembled) include
RS-232, full-duplex RS-485, and half-duplex RS-485.

By sacrificing one or more of the on-board diagnostic \acronym{LED}s, 1--4 input signals may be 
monitored by the controller, triggering user-programmed actions.  This allows for things like
a light sensor to trigger nighttime lighting which turns off in the daytime, or to announce the
arrival of guests when a door sensor is opened.

\section{4-Channel DC Controller}
\begin{figure}
  \begin{center}
    \LLimg{4cover}
  \end{center}
  \caption{Lumos 4-Channel DC Controller}
\end{figure}
\index{Lumos 4-channel DC SSR}
This board controls four output channels for low-voltage~DC loads.
The controlled channel block is separately powered and completely isolated from the
logic side of the board 
It may be powered with +5\,V~DC or a voltage from +8 to +24\,V~DC and
is designed to supply up to 5\,A per channel, with a maximum of 10\,A total at any 
given time.

It uses one address for Lumos-protocol communication, or 4 \acronym{DMX512} slots.
Communications options (selected permanently at the time the controller is assembled) include
full- and half-duplex RS-485.

By sacrificing one or more of the on-board diagnostic \acronym{LED}s, 1--4 input signals may be 
monitored by the controller, triggering user-programmed actions.  This allows for things like
a light sensor to trigger nighttime lighting which turns off in the daytime, or to announce the
arrival of guests when a door sensor is opened.


\chapter{Operating the Board Controls}
\LLstart{T}{he}{Lumos controllers include} two front-panel \ix{buttons} labeled ``\acronym{OPTION}'' and ``\acronym{RESET}.''
This chapter will describe how to use these buttons to control the board manually.  We will assume the
\acronym{RESET} button is red and the \acronym{OPTION} button is green.  Depending on components chosen when building the
board, these colors may vary.

\section{Resetting the Board}
The red \acronym{RESET} button is connected directly to the microcontroller's $\overline{\hbox{\mc{MCLR}}}$ input.
As long as the button is pressed, the \acronym{CPU} will be halted.  No operations of the controller
will be active at this time.  

When the button is released, the \acronym{CPU} will reboot as if powered up.  This restores the ability
to enter configuration mode, resets all output channels to be fully off, 
% XXX FUTURE clears sequences stored in normal \acronym{RAM} memory, 
clears all faults and error conditions, and re-initializes all the hardware
and software components.

Four-channel boards don't include this button.  To reset one of these boards, insert a jumper across pins 
2--3 of J2 as shown in Figure~\ref{fig:4dc-reset}.  This will halt the board.  Then remove the jumper,
which will reset and restart the board.
\begin{figure}
  \centerfloat{\LLimg[width=3in]{4dc-j2-23}}
  \caption{Resetting a 4-Channel DC Lumos Board Via Jumper on J2-2 and J2-3\label{fig:4dc-reset}}
\end{figure}

\section{Entering Configuration Mode}\label{sec:configmode}
\index{configuration mode}
Some functions are only enabled when the controller is in a special ``configuration'' mode\footnote{In
some places in other documentation, including the controller's firmware source code, this is also
referred to as ``privileged mode''.  This term is deprecated. The preferred term is now
``configuration mode.''} to prevent potentially harmful effects such as accidentally changing
the device's address, \ix{baud rate}, or other configuration parameters.

To initiate configuration mode, press and hold the green \acronym{OPTION} button until the \acronym{LED}s start
flashing rapidly (approximately 2~seconds).  Then release the \acronym{OPTION} button until the \acronym{LED}s
fade to a state where the green \acronym{LED}(s) are flashing rapidly.\footnote{In normal run mode,
the green \acronym{LED}(s) are slowly fading up and down.}

The four-channel boards do not have \acronym{OPTION} and \acronym{RESET} buttons directly (unless off-board
buttons were used, connected to the board at J2).  These boards are controlled by inserting jumpers onto
header J2, as follows:
\begin{enumerate}
	\item	Insert a jumper across pins 5--6 of J2.  \marginpar{\centerline{\LLimg[width=1.5in]{4dc-j2-56a}}}
	\item	Wait until the \acronym{LED}s start flashing rapidly (approximately 2~seconds).
	\item	Remove the jumper.
\end{enumerate}

The board is now in configuration mode and can be instructed by the host PC to change critical
settings.

To leave configuration mode, the host PC may issue a command to cancel the mode, or you may press
the red \acronym{RESET} button (which also has the effect of rebooting the system).
(For four-channel boards, follow the instructions in the previous section to reset the board.)

\section{Running a Test Pattern}
\index{test pattern}
When setting up a board in the field, it may be helpful to manually have the board turn on its
output channels as a test that everything is connected and working properly.

To do this, first place the board in \ix{configuration mode} as described in Section~\ref{sec:configmode}.
After the green light is flashing rapidly and the others are off, press and hold the \acronym{OPTION} button
again %until the lights go off
for another 2 seconds, then release.  (For four-channel boards, insert and remove the jumper across pins
5--6 again, leaving the jumper in place for about 2~seconds, as you did to place the board in configuration
mode.)

The red \acronym{LED} will now be slowly fading up and down (instead of the green \acronym{LED} doing that
as it does in normal run mode).  The controller will turn off all output channels, and turn channel \#0
on fully.  

After a one-second delay, channel \#0 will turn off and \#1 will turn on.  This will continue indefinitely,
each channel turning on in its turn each second.  The panel \acronym{LED}s will display the currently-active
channel number in binary.  Note that 24-channel boards only show the least significant 3 bits, so you
will see which channel within the block (0--7) is active, but not which block.  48-channel controllers
show the entire channel number.  See Figure~\ref{fig:testbin} for a reference chart of the output
codes.  Four-channel boards use the same display pattern as the 24-channel boards.
\begin{figure}
  \begin{center}
    \begin{tikzpicture}
  \node [above right] at (2,11) {\strut Channel};
  \node [above right] at (0,11) {\strut 48-ch};
  \node [above right] at (1,11) {\strut 24-ch};
  \node [above right] at (7,11) {\strut Channel};
  \node [above right] at (5,11) {\strut 48-ch};
  \node [above right] at (6,11) {\strut 24-ch};
  \draw (0,11) -- (10,11);
  \def\y{10}
  \light{A1}{off}\light{G1}{off}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{off}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#0};
  \def\y{9}
  \light{A1}{off}\light{G1}{off}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{off}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#1};
  \def\y{8}
  \light{A1}{off}\light{G1}{off}\light{Y1}{on}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{on}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#2};
  \def\y{7}
  \light{A1}{off}\light{G1}{off}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{on}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#3};
  \def\y{6}
  \light{A1}{off}\light{G1}{on}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{off}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#4};
  \def\y{5}
  \light{A1}{off}\light{G1}{on}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{off}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#5};
  \def\y{4}
  \light{A1}{off}\light{G1}{on}\light{Y1}{on}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{on}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#6};
  \def\y{3}
  \light{A1}{off}\light{G1}{on}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{on}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#7};

  \def\y{2}
  \light{A1}{on}\light{G1}{off}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{off}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#8};
  \def\y{1}
  \light{A1}{on}\light{G1}{off}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{off}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#9};
  \def\y{0}
  \light{A1}{on}\light{G1}{off}\light{Y1}{on}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{on}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#10};
  \def\y{-1}
  \light{A1}{on}\light{G1}{off}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{on}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#11};
  \def\y{-2}
  \light{A1}{on}\light{G1}{on}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{off}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#12};
  \def\y{-3}
  \light{A1}{on}\light{G1}{on}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{off}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#13};
  \def\y{-4}
  \light{A1}{on}\light{G1}{on}\light{Y1}{on}\light{R1}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{on}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#14};
  \def\y{-5}
  \light{A1}{on}\light{G1}{on}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{on}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (2,\y) {Channel \#15};

  \def\lightxbase{5}
  \def\y{10}
  \light{A1}{off}\light{G1}{off}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{off}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#16};
  \def\y{9}
  \light{A1}{off}\light{G1}{off}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{off}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#17};
  \def\y{8}
  \light{A1}{off}\light{G1}{off}\light{Y1}{on}\light{R1}{off}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{on}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#18};
  \def\y{7}
  \light{A1}{off}\light{G1}{off}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{off}\light{G0}{on}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#19};
  \def\y{6}
  \light{A1}{off}\light{G1}{on}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{off}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#20};
  \def\y{5}
  \light{A1}{off}\light{G1}{on}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{off}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#21};
  \def\y{4}
  \light{A1}{off}\light{G1}{on}\light{Y1}{on}\light{R1}{off}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{on}\light{Y0}{off}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#22};
  \def\y{3}
  \light{A1}{off}\light{G1}{on}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \light{A0}{on}\light{G0}{on}\light{Y0}{on}\light{R0}{sfd}
  \node [right] at (7,\y) {Channel \#23};

%         gyAGYR gyAGYR
% 24-31   011000 011111
% 32-39   100000 100111
% 40-47   101000 101111
 
  \def\y{2}
  \light{A1}{on}\light{G1}{off}\light{Y1}{off}\light{R1}{off}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#24};
  \def\y{1}
  \light{A1}{on}\light{G1}{off}\light{Y1}{off}\light{R1}{on}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#25};
  \def\y{0}
  \light{A1}{on}\light{G1}{on}\light{Y1}{on}\light{R1}{on}\light{G2}{off}\light{Y2}{on}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#31};
  \def\y{-1}
  \light{A1}{off}\light{G1}{off}\light{Y1}{off}\light{R1}{off}\light{G2}{on}\light{Y2}{off}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#32};
  \def\y{-2}
  \light{A1}{off}\light{G1}{on}\light{Y1}{on}\light{R1}{on}\light{G2}{on}\light{Y2}{off}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#39};
  \def\y{-3}
  \light{A1}{on}\light{G1}{off}\light{Y1}{off}\light{R1}{off}\light{G2}{on}\light{Y2}{off}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#40};
  \def\y{-4}
  \light{A1}{on}\light{G1}{on}\light{Y1}{on}\light{R1}{off}\light{G2}{on}\light{Y2}{off}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#46};
  \def\y{-5}
  \light{A1}{on}\light{G1}{on}\light{Y1}{on}\light{R1}{on}\light{G2}{on}\light{Y2}{off}\light{R2}{sfd}
  \node [right] at (7,\y) {Channel \#47};
  \def\lightxbase{0}
    \end{tikzpicture}
  \end{center}
  \caption{Test-mode Channel Indicators\label{fig:testbin}}
\end{figure}

If the \acronym{OPTION} button is pressed briefly, the pulsing red \acronym{LED} freezes (steady on) and the cycle
pauses on the current output channel.  Pressing the \acronym{OPTION} button again resumes the cycle.
Four-channel boards may be paused by briefly inserting and then removing a jumper across pins 5--6 of J2.
      
\section{Restoring to Factory Settings}\label{ss:factoryreset}
If the board is unresponsive and cannot be reconfigured via the host PC (for example, if you configured
it to use a \ix{baud rate} your host PC can't match), follow these steps to reset the device to its 
factory default settings.  Disconnect any input sensors and power supply control wires from the Lumos
controller before beginning.
\subsection{24-Channel Boards}
\begin{enumerate}
%	\item	Turn off the Lumos controller.
%	\item	Disconnect any input sensors and power supply control wire from the Lumos
%		controller.
	\item	Turn off the Lumos controller or press and hold the red \acronym{RESET} button.
	\item	Install a \ix{jumper} to short pins 4 and 5 of J11 (labeled ``\acronym{ICSP}''
		on the board).
	\item	Power on the Lumos controller or release the \acronym{RESET} button.
	\item	When the red, green, and yellow \acronym{LED}s flash rapidly, pull the
		jumper out.
\end{enumerate}
\subsection{4-Channel Boards}
\begin{enumerate}
	\item	Turn off the Lumos controller or insert a jumper across pins 2--3 of J2.
		\marginpar{\centerline{\LLimg[width=1.5in]{4dc-j2-23}}}
	\item	Install a \ix{jumper} across pins 5--6 of J2.
		\marginpar{\centerline{\LLimg[width=1.5in]{4dc-j2-2345}}}
	\item	Remove any sensors attached to the unit.
	\item	Insert a jumper wire between sensor input terminals $\overline{\hbox{A}}$ and $\overline{\hbox{B}}$.
	\item	Power on the Lumos controller or remove the jumper from pins 2--3.
		\marginpar{\centerline{\LLimg[width=1.5in]{4dc-j2-45}}}
	\item	When the red, green, and yellow \acronym{LED}s flash rapidly, pull the
		jumper from the sensor inputs.
	\item	Finally, pull the jumper off pins 5--6.
\end{enumerate}

If those steps were carried out exactly as described, %the \acronym{LED}s will all flash rapidly and 
the controller will reboot with the factory settings in place.  This means, among other things,
it will be at address 0, set to use Lumos commands only (not \acronym{DMX512}), and will communicate
at 19,200~baud.

Failure to perform each step at the right time will prevent the factory reset from occurring.

\chapter{Configuring the Board}
\LLstart{T}{here}{are a number of settings} which can be made on the Lumos controllers.  Generally,
this is accomplished by using the \z{lumosctl} com\-mand-line program on the host PC.  The basic configuration
options include such things as setting the device address, communication speed, etc.  These can be set
directly on the command line with \z{lumosctl}.
\index{lumosctl@\z{lumosctl}|(}

In the following examples, the command-line prompt is represented by a `\z{\$}' character.
Text that is typed literally as shown in printed in \z{fixed-width type}, while values which are
to be replaced with a value appropriate for your usage are printed in \Var*{Italics} in angle brackets
(the angle brackets are not actually typed, however).

For every command, you need to include three values:
\begin{itemize}
	\item 	The serial port on the host PC to which the Lumos controller is attached.  This is
		given to \z{lumosctl}'s \z{----port} option, as ``\z{----port=}\Var*{name}''.  On many
		systems, it is enough to say ``\z{----port=0}'' or ``\z{----port=1}'' to specify the first
		or second ``standard'' port.  A specific port name may be given, such as 
		``\z{----port=COM1}'' or ``\z{----port=/dev/ttys0}''.
	\item	The speed (\ix{baud rate}) at which to communicate with the Lumos controller.  This is
		the speed the controller is \emph{currently} using, not the one you want to change it
		to.  This is given as ``\z{----speed=}\Var*{rate}'', such as ``\z{----speed=19200}''.
	\item	The Lumos controller's address, given as ``\z{----address=}\Var*{addr}''.  For example,
		``\z{----addr=0}''.
\end{itemize}

If you aren't sure what device \ix{address}es exist on the serial line, you can have \z{lumosctl} 
probe to discover them all:
\begin{SourceCode}
$ lumosctl --port=COM1 --speed=19200 --probe
Probe discovered 2 devices:
Address 00: lumos48ctl
Address 04: lumos24dc
$ _
\end{SourceCode}

If that doesn't discover everything you thought it should, you can add \z{----verbose} to the command
to see more detail.  Adding more and more \z{----verbose} options increases the amount of information
printed.  The default port is the ``first'' standard port, the default speed is 19,200 bits per second,
and the default address is 0.

If you want to print a full report of the state of a device, include the \z{----report} option:
\begin{SourceCode}
$ lumosctl --port=COM1 --speed=19200 --address=0 --report
\end{SourceCode}

The \z{----port}, \z{----speed}, and \z{----address} options assume a reasonable default value if
they were not specified.  For the sake of simplicity, we'll assume from here on that you either
accept these defaults or are specifying them to have the values you need; we won't explicitly
show them in the examples that follow.

\section{Read-Only Mode}
Sometimes you will use the Lumos board in situations where you can't receive a reply from the device.
This may, for example, happen if you use an \acronym{RS-485} converter which only transmits data, but
doesn't receive any back, or if there is a problem with your PC trying to control the data direction
on a half-duplex network.

In this case, use the \z{----read--only} option to \z{lumosctl}.  This suppresses the features of
\z{lumosctl} which monitor the Lumos board's configuration and current state.  Normally, this helps
confirm that the requested changes took effect, but if your PC is unable to receive information back
from the Lumos board, \z{lumosctl} won't be able to work without the \z{----read-only} option.

\section{Setting the Device Address}
Set a new \ix{address} by giving \z{----set--address=}\Var*{newaddr}.  Don't forget to include the
device's current address with \z{----address=}\Var*{oldaddr}.  For example, to change a board
from address 0 to 12:

\begin{SourceCode}
$ lumosctl --address=0 --set-address=12
\end{SourceCode}

Once the address is set, you'll need to use that value for \z{----address} from that point forward.

\section{Setting the Device Speed}
\index{baud rate}
Set a new speed by giving \z{----set--baud-rate=}\Var*{newspeed}.  Don't forget to include the
device's current speed with \z{----speed=}\Var*{oldspeed}, so it has any hope of seeing the command
to change it.  For example, to change a board
from 19200 to 57600 baud:

\begin{SourceCode}
$ lumosctl --speed=19200 --set-baud-rate=57600
\end{SourceCode}

Once the speed is set, you'll need to use that value for \z{----speed} from that point forward.

\section{Sensors}\label{sec:sensors}

\index{sensors}If your board is built to accommodate sensor inputs, you need to set the \acronym{EEPROM}
settings so the controller stops driving those lines as outputs and starts watching them as
inputs.

To do this, use the \z{----dump--configuration=}\Var*{file} option.  This dumps the device's
configuration state into a text file on the host PC.

\begin{SourceCode}
$ lumosctl --dump-configuration=lumos_board.cfg
\end{SourceCode}

Looking in the \z{lumos\_board.cfg}, find a section beginning with the stanza tag
``\z{[lumos\_device\_settings]}''.
There is a field ``\z{sensors=}\Var*{list}'' which should contain a list of all the sensors 
configured as inputs.  

So if we had lines A and C wired up to sensor inputs instead of \acronym{LED} outputs, we need to 
change this line in the \z{lumos\_board.cfg} file to read:

\begin{SourceCode}
[lumos_device_settings]
sensors=ac
\end{SourceCode}

Leave the other fields alone, just as they are.

\begin{NotImplemented}
For each sensor, we can arrange for an action to take place every time one of them activates.
The actions taken are set up as ``Programmed Sequences'' (see Chapter~\ref{ch:sequences}).
Assuming that the actions we want to carry out are already programmed and loaded as described in
that chapter, we associate those sequences with sensor inputs by introducing a new section
in the \z{lumos\_board.cfg} file called \z{[lumos\_device\_sensor\_}\Var*{x}\z{]}, where 
\Var*{x} is the sensor letter (or we edit that section, if it's already in the file).

For example, to set sensor A to play sequence 100 when it first activates, then continue to loop
sequence 101 as long as the sensor remains active, then finally play sequence 102 as soon as the
sensor stops being active, and assuming we want ``active'' to mean when the signal on that input
is at a logic 1 level (active high), we would put this in the file:

\begin{SourceCode}
[lumos_device_sensor_a]
enabled=yes
mode=while
setup=100
sequence=101
terminate=102
active_low=no
\end{SourceCode}

If we want sensor C to be active low, and trigger sequence 42 one time when it activates, our 
file needs this section added to it:

\begin{SourceCode}
[lumos_device_sensor_c]
enabled=yes
mode=once
sequence=42
active_low=yes
\end{SourceCode}

Once the file is set up with all the configuration changes you wish to make, it may be 
loaded back to the board again with the \z{----load--con\-fig\-ur\-a\-tion=}\Var*{file} option:

\begin{SourceCode}
$ lumosctl --load-configuration=lumos_board.cfg
\end{SourceCode}

Assigning sequences to as sensor-triggered events may also be arranged on the fly via
the \z{lumosctl} program.  The same effects could be performed thus:

\begin{SourceCode}
$ lumosctl --sensor=aw+:100:101:102 --sensor=co::42:
\end{SourceCode}

Note that configuring a sensor line as an input or output \emph{must} be done from the
configuration file.

See Chapter~\ref{ch:sequences} for complete details on how to create sequences and store them
into a Lumos controller.  Full details on the operation of \z{lumosctl} in this and other
areas begins on page~\pageref{ch:lumosctl} in the appendices.
\end{NotImplemented}

\section{Setting a Lumos Controller to Use \acronym{DMX512}}
\begin{NotImplemented*}{The \acronym{DMX512} support in Lumos is experimental and not expected
to work yet.  If you wish to experiment further to refine this feature for a future release of 
the Lumos firmware, contact the author with your findings and recommendations.}
Setting up the controller to be a \acronym{DMX512} device is another task performed via
the configuration file (see Section~\ref{sec:sensors} for instructions about how to dump
and load a configuration file).

First, get the current configuration settings into a file:
\begin{SourceCode}
$ lumosctl --dump-configuration=lumos_board.cfg
\end{SourceCode}
In the \z{[lumos\_device\_settings]} section, add a new field ``\z{dmxchannel=}\Var*{c}'',
where
\Var*{c} is the starting slot number you wish the Lumos controller to use.  This will be 
channel \#0 on this board.  

To cause a 24-channel Lumos board to occupy \acronym*{DMX} slots 200--247, this would be:
\begin{SourceCode}
[lumos_device_settings]
dmxchannel=200
\end{SourceCode}

Now download that configuration into the controller board:
\begin{SourceCode}
$ lumosctl --load-configuration=lumos_board.cfg
\end{SourceCode}

If you want to change the board to be a Lumos-protocol board instead of \acronym{DMX512},
just follow the same process, but \emph{delete} the \z{dmxchannel=}\Var*{c} line completely
before loading the configuration onto the Lumos board.
\end{NotImplemented*}

\section{Canceling Configuration Mode}
When you're finished configuring the controller board, you may use either of these options:
\begin{SourceCode}
$ lumosctl --disable-configuration-mode
$ lumosctl --forbid-configuration-mode
\end{SourceCode}

Either of these returns the board to normal run mode.  The second goes a step further, forbidding
the board from going back into configuration mode again, until the next time the board is reset or
power cycled.
\index{lumosctl@\z{lumosctl}|)}

\chapter{Creating Programmed Sequences}\label{ch:sequences}
\begin{NotImplemented*}{Stored programmed sequences are a planned feature for the Lumos boards but is not
yet implemented.  This chapter will fully describe the programming environment when that feature is
ready for use.}

\bigskip

%% XXX \LLstart{T}{he}{normal operating mode} for a Lumos controller is to receive a stream
%% XXX of real-time commands from the host PC, acting on them as they arrive.  However, it is 
%% XXX also possible to program a number of complex actions into the controller's memory.  The
%% XXX host PC can then send a much smaller command to tell the controller to execute a stored
%% XXX sequence of actions.  If sensor inputs are enabled, the board may be set up to trigger the
%% XXX execution of a stored sequence when sensor activity is detected.
%% XXX 
%% XXX \strong{N.B.: The following information assumes a high-level (if somewhat simple) language
%% XXX to describe sequences, which gets compiled into a more compact bytecode which is loaded onto the
%% XXX device itself.  This language compiler has not yet been written.  Section~\ref{sec:bytecode}
%% XXX below describes the bytecode actually understood by the device.  At the time of this writing,
%% XXX it is necessary to create this bytecode manually and load it into the device as described
%% XXX in that section.  To emphasize that this is speculative documentation about a future feature,
%% XXX the text appears in a lighter type color.}
%% XXX 
%% XXX {\color{gray}
%% XXX These sequences are written using a small, simple programming language.  It is intended to
%% XXX make it possible to describe some basic operations supported by the device, not to create a
%% XXX fully general-purpose programming system.  This, plus the need to design the sequence data
%% XXX to be as compact as possible, drove the design of this language to be optimized toward efficiency
%% XXX and to enable a certain set of common operations.  This optimization means, however, that some
%% XXX other functions are limited or omitted.  We'll point out the major caveats along the way as we
%% XXX describe this system in this chapter.
%% XXX 
%% XXX \section{Basic Sequence Syntax and Structure}
%% XXX Each sequence is numbered with an ID from 0--127.  The sequence begins with a declaration of this
%% XXX ID in the form ``\z{SEQUENCE} \Var*{id}\z{:}'' followed by all the lines of instructions, and ends
%% XXX with the word ``\z{END}'' on the final line.
%% XXX 
%% XXX When writing a sequence of instructions to be stored into the controller, each individual instruction
%% XXX is placed on a line by itself.  For example, if we define sequence~\#1 to set 
%% XXX channel~\#0 on, \#1 to half brightness, and \#2 off,
%% XXX the sequence code would be:
%% XXX \begin{SourceCode}
%% XXX sequence 1:
%% XXX   channel 0 on
%% XXX   channel 1 50%
%% XXX   channel 2 off
%% XXX end
%% XXX \end{SourceCode}
%% XXX % on #0			C1 00
%% XXX % dimmer #1,127		42 01 7F
%% XXX % off #2                41 02
%% XXX 
%% XXX The indentation is simply a convention to make the code more readable; the Lumos system ignores it.
%% XXX Similarly, Lumos sequences are case-insensitive.  The previous sequence could just as well have been
%% XXX written:
%% XXX \begin{SourceCode}
%% XXX SEQUENCE 1:
%% XXX   Channel 0 ON
%% XXX   Channel 1 50%
%% XXX   CHANNEL 2 Off
%% XXX END
%% XXX \end{SourceCode}
%% XXX 
%% XXX \section{Expressions}
%% XXX Anywhere a number is expected, a complex math expression may be used.  Standard algebraic order of
%% XXX operations is enforced on the expression, so parentheses force the enclosed sub-expression to be
%% XXX evaluated first, then multiplication and division, then addition and subtraction.  All of the following
%% XXX instructions turn channel 10 to 1/3 brightness:
%% XXX \begin{SourceCode}
%% XXX channel 10 33.3333333333%
%% XXX channel 2*(2+3) 255/3
%% XXX channel 10 255.0/3.0
%% XXX \end{SourceCode}
%% XXX 
%% XXX \strong{Note:} If the expression is able to be fully interpreted using known values at the time 
%% XXX the source code is compiled on the host PC, it is evaluated with all the precision of floating-point
%% XXX math operations to the extent supported by the PC.  The final result of the calculation, however, 
%% XXX needs to be reduced to (in most cases) an unsigned 8-bit integer value (0--255) for storage on the 
%% XXX Lumos controller.  If the expression must be interpreted at run-time on the Lumos device itself,
%% XXX there's a much more limited expression evaluation system available at that point.  Only addition,
%% XXX subtraction, and multiplication of unsigned 8-bit values is possible there.  The compiler may reject
%% XXX your expression if it can't be handled within those constraints.
%% XXX 
%% XXX The math operators supported are summarized in Figure~\ref{fig:mathop}.
%% XXX \begin{figure}
%% XXX   \begin{center}
%% XXX     \begin{tabular}{|c|l|}\hline
%% XXX 	Expression & Meaning\\\hline\hline
%% XXX 	\Var{x}  \z{+}  \Var{y} & add $x+y$ \\\hline
%% XXX 	\Var{x}  \z{-}  \Var{y} & subtract $x-y$ \\\hline
%% XXX 	\Var{x}  \z{*}  \Var{y} & multiply $x\times y$ \\\hline
%% XXX 	\Var{x}  \z{/}  \Var{y} & divide $x/y$ \\\hline
%% XXX 	\Var{x}  \z{//} \Var{y}& divide $x/y$ using integer division\\\hline
%% XXX 	\Var{x}  \z{\%}  \Var{y}& the remainder when dividing $x/y$ \\\hline
%% XXX     \end{tabular}
%% XXX   \end{center}
%% XXX   \caption{Supported Math Operations\label{fig:mathop}}
%% XXX \end{figure}
%% XXX 
%% XXX \section{Variable Assignment}
%% XXX To a rather limited extent, variables may be given values and then used in sequences in place
%% XXX of numeric values, like so:
%% XXX \begin{SourceCode}
%% XXX x = 42
%% XXX channel x on
%% XXX channel x+1 on
%% XXX channel x+2 on
%% XXX \end{SourceCode}
%% XXX %
%% XXX % optimized a bit:
%% XXX %
%% XXX % push #42	4F 2A
%% XXX % dup		32
%% XXX % on		81
%% XXX % add		23
%% XXX % dup		32
%% XXX % on		81
%% XXX % add		23
%% XXX % on		81
%% XXX % 
%% XXX % not optimized
%% XXX %
%% XXX % push #42	4F 2A		; SFB+0
%% XXX % push	0	CF 00
%% XXX % on		81
%% XXX % push 	0	CF 00
%% XXX % add		23
%% XXX % on		81
%% XXX % push 	0	CF 00
%% XXX % add	#2	43 02
%% XXX % on		23
%% XXX 
%% XXX \section{Controlling Output Channels}
%% XXX We already saw the \z{CHANNEL} command which can be used to turn a designated channel \z{ON}, 
%% XXX \z{OFF}, or to a given percentage.  It may also be given a raw value from 0--255.  All of the following
%% XXX set channel~\#4 to full brightness:
%% XXX \begin{SourceCode}
%% XXX channel 4 100%
%% XXX channel 4 255
%% XXX cahnnel 4 on
%% XXX \end{SourceCode}
%% XXX 
%% XXX We may also start a channel smoothly fading up or down from its current brightness to either fully
%% XXX on or fully off.  The following instructions cause channel~\#12 to fade to black by reducing its 
%% XXX output value by 2 every .2 seconds.  Simultaneously, channel~\#13 will increase in brightness by 1 step
%% XXX every 1/120\,second.
%% XXX \begin{SourceCode}
%% XXX ramp down 12 by 2 per .2 seconds
%% XXX ramp up 13
%% XXX \end{SourceCode}
%% XXX 
%% XXX There is also a single command for turning all output channels off at once:
%% XXX \begin{SourceCode}
%% XXX blackout
%% XXX \end{SourceCode}
%% XXX 
%% XXX \section{Device State Changes}
%% XXX There are commands \z{SLEEP} and \z{WAKE} to turn on and off sleep mode if desired.
%% XXX These control power-saving features but don't disrupt the interpretation or execution of
%% XXX incoming commands.
%% XXX 
%% XXX There are also \z{SUSPEND} and \z{RESUME} commands.  \z{SUSPEND} causes the controller
%% XXX to ignore any further input, on the premise that the sequence wants to take priority over
%% XXX whatever the host PC wanted the controller to do.  \z{RESUME} allows the board to resume
%% XXX normal operation (acting on received commands from the host PC).
%% XXX 
%% XXX If the command \z{SUSPEND WITH UPDATE} is given, then the device will track changes to
%% XXX channel outputs made by the host PC, but still will not act on them until a \z{RESUME}
%% XXX command (at which point, the output channels will simply change to what would be the
%% XXX final result of all the changes received---it does not ``replay'' all of the changes
%% XXX that were delayed at that point).  
%% XXX 
%% XXX The \z{RESUME WITH FADE} is just like \z{RESUME}, except it will fade all channels to black
%% XXX first, then fade up the channels to their reume values.
%% XXX 
%% XXX For example, if you have a light sensor configured to run sequence 1 once when it senses daylight,
%% XXX and then run sequence 2 when it senses darkness, and you want to inhibit outputs during the daytime
%% XXX but still allow the host PC to set a pattern of channel values which will be displayed immediately
%% XXX upon dusk, the sequences could be coded:
%% XXX \begin{SourceCode}
%% XXX sequence 1:
%% XXX   suspend with update
%% XXX   blackout
%% XXX end
%% XXX 
%% XXX sequence 2:
%% XXX   resume with fade
%% XXX end
%% XXX \end{SourceCode}
%% XXX 
%% XXX \section{Flow Control}
%% XXX In addition to the linear sequence of instructions to change channel outputs, there are
%% XXX a number of instructions which alter the flow of execution itself.  This includes the usual
%% XXX collection including conditionals, loops, and so forth.  
%% XXX 
%% XXX If you want to have sequence 123 turn on channel \#4 if sensor B is active at that moment,
%% XXX or turn it off otherwise, the following code will suffice:
%% XXX \begin{SourceCode}
%% XXX sequence 123:
%% XXX   if sensor b:
%% XXX     channel 4 on
%% XXX   else:
%% XXX     channel 4 off
%% XXX   end
%% XXX end
%% XXX \end{SourceCode}
%% XXX 
%% XXX We can turn on every even numbered channel from \#0--\#10, with a half-second delay up through \#6
%% XXX and then instantly for the rest:
%% XXX \begin{SourceCode}
%% XXX sequence 47:
%% XXX   for ch=0 to 10 by 2:
%% XXX     channel ch on
%% XXX     if channel <= 6:
%% XXX       wait 0.5 seconds
%% XXX     end
%% XXX   end
%% XXX end
%% XXX \end{SourceCode}
%% XXX 
%% XXX We can flash channels \#1 and \#3 repeatedly until our sequence is forced to stop:
%% XXX \begin{SourceCode}
%% XXX sequence 9:
%% XXX   repeat:
%% XXX     channel 1 on
%% XXX     channel 3 on
%% XXX     wait 1 second
%% XXX     channel 1 off
%% XXX     channel 3 off
%% XXX     wait 1 second
%% XXX   end
%% XXX end
%% XXX \end{SourceCode}
%% XXX 
%% XXX Loops can be interrupted using \z{BREAK}, \z{CONTINUE}, and \z{EXIT}.
%% XXX See the \z{lumosctl} documentation (page~\pageref{sh:lumosctl}) for full details.
%% XXX 
%% XXX \section{Subroutines and Sequence Chains}
%% XXX One sequence can invoke another sequence, either as a subroutine (so that the execution
%% XXX temporarily detours into the called sequence, and then the calling sequence resumes where
%% XXX it left off), or as a ``chain'' from one sequence to another (where the calling sequence 
%% XXX stops as the called sequence starts, so there is no returning from that point).
%% XXX 
%% XXX Here we have sequence 12 which calls sequence 13 in a loop:
%% XXX \begin{SourceCode}
%% XXX sequence 12:
%% XXX   repeat 10 times as i:
%% XXX     call 13
%% XXX     wait i seconds
%% XXX   end
%% XXX   execute 14
%% XXX end
%% XXX 
%% XXX sequence 13:
%% XXX   channel 0 on
%% XXX   wait 2
%% XXX   channel 0 off
%% XXX end
%% XXX 
%% XXX sequence 14:
%% XXX   blackout
%% XXX end
%% XXX \end{SourceCode}
%% XXX Note that the \z{EXECUTE} instruction terminated sequence 12 and started
%% XXX sequence 14.  When sequence 14 finishes, nothing further is done.
%% XXX 
%% XXX Sometimes it's valuable to be able to pass parameters to subroutines.  Sequences support
%% XXX up to four parameters which must be declared in both the definition of the sequence and
%% XXX the \z{EXECUTE} or \z{CALL} which invokes it.  Here's a program which turns on each channel
%% XXX from 0--24 repeatedly.
%% XXX \begin{SourceCode}
%% XXX sequence 1:
%% XXX   repeat:
%% XXX     for c=0 to 24:
%% XXX       call 2(c)
%% XXX     end
%% XXX   end
%% XXX end
%% XXX 
%% XXX sequence 2(chan):
%% XXX   channel chan on
%% XXX   wait 1 second
%% XXX   channel chan off
%% XXX end
%% XXX \end{SourceCode}
%% XXX %
%% XXX % 0 loop	0	2A
%% XXX % 1 loop	0	2A
%% XXX % 2 pctr		36
%% XXX % 3 call	$C,#1	48 0C 01
%% XXX % 6 next	1,#24	2B 01 18
%% XXX % 9 next	0	AB 00
%% XXX % b exit		00
%% XXX % c push	0	8F 00
%% XXX % e on			81
%% XXX % f wait	#nn	49 nn
%% XXX %11 push	0	0F 00
%% XXX %13 off			01
%% XXX %14 exit		00
%% XXX 
\section{Temporary vs.\ Permanent Sequences}
Sequences numbered from 0--63 are stored into non-volatile \acronym{EEPROM} memory and will remain
in place until explicitly erased or replaced.  Sequences numbered 64--127 are stored in temporary 
\acronym{RAM} and will be lost at the next device reset.  This enables the host PC to download
sequences for short-term temporary use.

\section{Storing Sequences into Device Memory}
The device files are stored into the Lumos controller using the \z{lumosctl} command:
\begin{SourceCode}
$ lumosctl --clear-sequences
$ lumosctl --load-sequence=my_program_file
\end{SourceCode}

The initial \z{----clear--sequences} option is not always needed.  It erases all sequences
from memory.  Then each subsequent \z{----load--sequence} option loads a file containing one
or more sequences into the device.

If a sequence is loaded which already exists on the device, the old one is replaced with the
new one.  Note, however, that Lumos controllers have a very na\"\i ve memory management capability.
They are really designed to simply have a set of sequences loaded on them, later erased
\emph{en masse} and replaced by a new set.

If replacement sequences are written on top of old ones, it is quite likely that the memory
will get fragmented quickly and you'll run out of available memory too early.
Simply adding new sequences shouldn't be a problem, however.

You can see how much memory is available by running \z{lumosctl} with the \z{----report} 
option.
\begin{SourceCode}
$ lumosctl --report --address=2
...
XXX
$ _
\end{SourceCode}

\section{Bytecode Reference}\label{sec:bytecode}
\emph{This is an advanced reference section most users will never have any reason to 
read.}  For the curious, however, we note that when you load a sequence source file
into \z{lumosctl}, it compiles the source into bytecode which is what actually gets 
sent to the controller, and is what is stored in its memory.  The following reference
details the format of that bytecode.

\subsection{Execution Model}
The execution model is a small stack-based\footnote{Several other
models were experimented with, but this provided better flexibility with a minimal
number of bytes required for the sequence instruction bytes themselves, which need to
be stored in a limited space on the controller.} 
machine environment, in which
each sequence is an independent program which begins at
address 0 in its own memory area.  

All memory locations, including program and stacks, are 8~bits wide.  Unless otherwise
indicated, data values are unsigned 8-bit integers.

\subsection{Stacks}
There are actually three independent stacks used: a call-return stack, data stack, and loop
counter stack.

The call-return stack (not illustrated here since it's not directly accessible from your programs) 
receives three bytes every time a sequence calls another sequence: the return address, sequence number,
and stack frame boundary pointer.
%\begin{BF}
%  \begin{rightwordgroup}{previous calling sequence}
%  \wordbox{1}{return address}\\
%  \wordbox{1}{return sequence}\\
%  \wordbox{1}{stack frame ptr}
%  \end{rightwordgroup}\\
%  \begin{rightwordgroup}{calling sequence}
%  \wordbox{1}{return address}\\
%  \wordbox{1}{return sequence}\\
%  \wordbox{1}{stack frame ptr}
%  \end{rightwordgroup}\\
%  \wordbox[]{1}{$\downarrow$ \\[1ex]}\\
%  \wordbox[]{1}{(increasing addresses)}
%\end{BF}

We can conceptually picture the stacks as ``piles'' of data values, with the most
recently-placed value set on top of the previous ones.  If we ``push'' three values
1, 2, and 3 onto a stack, it would look like this:
\begin{center}
\begin{bytefield}{8}
  \begin{rightwordgroup}{$\leftarrow$Top of Stack}
  \wordbox{1}{3}
  \end{rightwordgroup}\\
  \wordbox{1}{2}\\
  \wordbox{1}{1}\\
\end{bytefield}
\end{center}
As we ``pop'' values off the stack, we pull them from the top of the stack, so
they are retrieved in the reverse order in which they were pushed onto the
stack.

\subsubsection{Loop Counter Stack}
The loop counter stack holds all the loop counter values.  %At any given time,
%the top of the stack is the counter for the innermost executing loop.  This
%value is always referred to as ``\z{\{0\}}'' in the bytecode assembly listings.
If the code is executing a nested loop such as:
\begin{SourceCode}
repeat as outer:
  for middle=1 to 10:
    repeat 10 as inner:
      ...
    end
  end
end
\end{SourceCode}

Then the loop stack would look like:
\begin{center}
\begin{bytefield}[leftcurlyspace=0pt, rightcurlyspace=0pt, leftcurly=., rightcurly=.]{10}
  \bitbox[]{2}{} & \bitbox[]{8}{(direction of growth)}\\
  \bitbox[]{2}{} & \bitbox[]{8}{$\uparrow$}\\
  \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{\z{inner}}\\
  \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{\z{middle}}\\
  \bitbox[]{2}{\z{\{2\}}} & \bitbox{8}{\z{outer}}\\
\end{bytefield}
\end{center}

At any given time, \z{\{0\}} refers to the top of the loop stack, which is the
innermost loop level currently running.  Likewise, \z{\{1\}} is the 
counter for the next loop out from there, and so on.

Note that a counter variable is allocated for \emph{every} loop entered,
even if the source code didn't associate it with a variable name
(e.g., if the innermost was ``\z{REPEAT 10:}'' without the 
``\z{AS INNER}'' part).

\subsubsection{Data Stack}
The data stack contains the parameters passed to the current
sequence, if any, followed by local variables for the sequence.
The remaining room is for working stack space for calculations
and values consumed by the opcodes.

At each call, parameters are pushed onto the stack and then the
stack frame boundary (\acronym{SFB}) pointer is moved to 
point to the first parameter.
This way, parameters and local variables are referenced within the
sequence as offsets from the frame pointer, while working values
are obtained by pushing and popping values from the top of the stack.

\begin{center}
\begin{bytefield}{15}%[leftcurlyspace=0pt, rightcurlyspace=0pt, leftcurly=., rightcurly=.]{10}
  \begin{leftwordgroup}{Stack Frame}
  \begin{rightwordgroup}{working stack}
  \bitbox[]{5}{} & \bitbox[]{8}{(increasing addresses)}\\
  \bitbox[]{5}{} & \bitbox[]{8}{$\uparrow$}\\
  \bitbox[]{5}{\Var{x}} & \bitbox{8}{\Var{d}}\\
  \bitbox[]{5}{\Var{y}} & \bitbox{8}{\Var{c}}\\
  \bitbox[]{5}{\Var{z}} & \bitbox{8}{\Var{b}}\\
  \bitbox[]{5}{}        & \bitbox{8}{\Var{a}}
  \end{rightwordgroup}\\
  \begin{rightwordgroup}{local variables}
  \bitbox[]{5}{\z{[}\Var{n}+\Var{m}--1\z{]}} & \bitbox{8}{\Var{v$_{m-1}$}}\\
  \bitbox[]{5}{}        & \bitbox[]{8}{$\vdots$ \\[1ex]}\\
  \bitbox[]{5}{\z{[}\Var{n}+1\z{]}} & \bitbox{8}{\Var{v$_1$}}\\
  \bitbox[]{5}{\z{[}\Var{n}+0\z{]}} & \bitbox{8}{\Var{v$_0$}}
  \end{rightwordgroup}\\
  \begin{rightwordgroup}{parameters passed \\ to this sequence}
  \bitbox[]{5}{\z{[}\Var{n}--1\z{]}} & \bitbox{8}{\Var{p$_{n-1}$}}\\
  \bitbox[]{5}{       } & \bitbox[]{8}{$\vdots$ \\[1ex]}\\
  \bitbox[]{5}{\z{[1]}} & \bitbox{8}{\Var{p$_1$}}\\
  \bitbox[]{5}{\z{[0]}} & \bitbox{8}{\Var{p$_0$}} & \bitbox[]{2}{$\leftarrow$\acronym{SFB}}
  \end{rightwordgroup}
  \end{leftwordgroup}\\
  %\begin{leftwordgroup}{previous frame}
  %\bitbox[]{5}{} &\bitbox{8}{\dots}\\
  \bitbox[]{5}{} &\bitbox[]{8}{$\vdots$ \\[1ex]}
  %\end{leftwordgroup}\\
\end{bytefield}
\end{center}

For convenience in our description of the bytecode below, we'll refer to the value on the top of the
data stack as \Var{x}, the second value as \Var{y}, and the third as \Var{z}.  In the assembly code,
the notation \z{[}\Var{n}\z{]} directly addresses the value \Var{n} bytes from the stack frame boundary
(\acronym{SFB}), so the first parameter passed (if any) would be at \z{[0]}, and so on.
 
\subsection{Instruction Format}

Each instruction is at least one byte long. The first byte is the opcode which always
has the general format:
%\newcommand\zh{\bitheader{0-7}}
\begin{BF}
  \bitbox{1}{\Var{f}} & \bitbox{1}{\Var{i}} & \bitbox{1}{\Var{d}} & \bitbox{5}{\Var*{cmd}}
\end{BF}
Where:
\begin{itemize}
	\item[\Var{f}=] Instruction-specific flag.
	\item[\Var{i}=] Data values are given as immediate bytes (\Var{i}=1) instead of being popped
		from the stack (\Var{i}=0).
	\item[\Var{d}=] Take default values for some or all of the arguments (\Var{d}=1).
\end{itemize}
Note that these are generalizations; individual command opcode patterns vary.

Following the opcode byte are any direct addressing bytes (generally, addresses of locations
on the stack for data values, or addresses to jump to) which must be constants at runtime.

After that are zero or more data bytes providing the values needed by the instruction, if the immediate
addressing mode is used (bit \Var{i}=1).  Otherwise they will be popped from the data stack as needed.

\subsection{Addressing Modes}
The following addressing modes are supported:
\begin{itemize}
	\item[--] \emph{Default addressing} means that some or all data values are omitted, 
		(which of them may be omitted depends on the instruction), so
		the instruction should assume
		a useful default value instead.  Denoted below as either the lack of argument, or
		an explicit mention of the default value (in which case the assembler would convert
		the instruction to the default form and avoid the argument).
	\item[\Var{a}] \emph{Direct addressing} specifies a memory location as a constant value following
		the opcode.  Examples include jump and loop instructions which directly name an
		instruction address within the sequence, and operations which specify a local
		variable or parameter as a constant offset from the stack frame pointer.  Note
		that some instructions mandate a direct argument even if others are pulled from
		the stack, memory, or take defaults.  Denoted below as a number (or name
		defined as a number) without other punctuation.
	\item[\z\#\Var{v}] \emph{Immediate addressing} mode means that the values needed by the instruciton are
		provided as constant bytes following the opcode, rather than being taken from the
		stack.  Denoted below as a value prefixed by a pound sign (\z\#).
	\item[{\z[\Var{a}\z]}] \emph{Indirect addressing} is used when a data value needed by an operation is
		specified, but that value specifies an address in memory (specifically, the value
		is an unsigned integer added to the stack frame pointer).  
		Denoted by square brackets around the argument value.
	\item[{\z{[\$]}}] \emph{Indirect Stack} values are obtained by popping an address from the stack and
		then using it as the location for the value to use.  Noted by square brackets
		and dollar sign together (\z{[\$]}).
	\item[--] \emph{Inherent} means that the instruction simply needs no further values to perform
		its operation; the data is inerent in the instruction itself.
	\item[\z\$] \emph{Stack addressing} means that the data values are popped from the stack.  These are
		popped in the order they would appear if given as immediate bytes, so they would
		need to be pushed in opposite order to that.  Denoted by a dollar sign (\z\$) as
		the argument to the instruction.
	\item[\z\{\Var{v}\z\}] \emph{Loop addressing} accesses loop counter values.  \z{\{0\}} is the
		innermost loop counter (the top of the loop stack), \z{\{1\}} is the next loop out from
		there, etc.  This can be combined with some other modes.  For example, \z{\{\$\}}
		pops a value from the stack, uses that as the loop depth number, and fetches the
		loop counter at that level.
\end{itemize}

The addressing mode is selected by various bits in the opcode byte.

For example, the instruction to set the dimmer output level for a channel (mnemonic ``\z{dimmer}'', 
base hex opcode \z{0x02}) may have the following forms:

% dimmer #1,16	42 01 10
% dimmer 	02
% push	 #9	4F 09
% push	9	8F 09
% push  #0	2F
% pctr	2	66 02

\begin{center}
\begin{bytefield}[leftcurlyspace=0pt, rightcurlyspace=0pt, leftcurly=., rightcurly=.]{24}
	\bitbox[]{8}{\footnotesize byte 0} &
	\bitbox[]{8}{\footnotesize byte 1} &
	\bitbox[]{8}{\footnotesize byte 2} \\

	\begin{leftwordgroup}{immed.}
	\begin{rightwordgroup}{\z{dimmer \#1,\#16}}
	\bitbox{1}{\z0} & \bitbox{1}{\z1} & \bitbox{1}{\z0} & \bitbox{5}{\z{0x02}} &
	\bitbox{8}{\z{0x01}} & \bitbox{8}{\z{0x10}}
	\end{leftwordgroup}
	\end{rightwordgroup} \\

	\begin{leftwordgroup}{stack}
	\begin{rightwordgroup}{\z{dimmer \$,\$}}
	\bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{5}{\z{0x02}} &
	\bitbox[]{8}{} & \bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup} \\
\end{bytefield}
\end{center}

In the first case, the \z{dimmer} command takes the channel number (1) and level (16) as 
immediate values in the sequence program itself.  In the second case, it pops two values
off the stack, the first number popped being the channel number and the second one being
the value.

Consider the \z{push} command as well:

\begin{center}
\begin{bytefield}[leftcurlyspace=0pt, rightcurlyspace=0pt, leftcurly=., rightcurly=.]{16}
	\bitbox[]{8}{\footnotesize byte 0} &
	\bitbox[]{8}{\footnotesize byte 1} \\
%0F
	\begin{leftwordgroup}{inherent}
	\begin{rightwordgroup}{\z{dup}}
	\bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{5}{\z{0x0F}} &
	\bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup}\\
%2F
	\begin{leftwordgroup}{default}
	\begin{rightwordgroup}{\z{push \#0}}
	\bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{1}{\z1} & \bitbox{5}{\z{0x0F}} &
	\bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup}\\
%4F
	\begin{leftwordgroup}{immediate}
	\begin{rightwordgroup}{\z{push \#9}}
	\bitbox{1}{\z0} & \bitbox{1}{\z1} & \bitbox{1}{\z0} & \bitbox{5}{\z{0x0F}} &
	\bitbox{8}{\z{0x09}}
	\end{leftwordgroup}
	\end{rightwordgroup} \\
%6F
	\begin{leftwordgroup}{loop default}
	\begin{rightwordgroup}{\z{push \{0\}}}
	\bitbox{1}{\z0} & \bitbox{1}{\z1} & \bitbox{1}{\z1} & \bitbox{5}{\z{0x0F}} &
	\bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup}\\
%8F
	\begin{leftwordgroup}{indirect stack}
	\begin{rightwordgroup}{\z{push [\$]}}
	\bitbox{1}{\z1} & \bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{5}{\z{0x0F}} &
	\bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup}\\
%AF
	\begin{leftwordgroup}{indirect default}
	\begin{rightwordgroup}{\z{push [0]}}
	\bitbox{1}{\z1} & \bitbox{1}{\z0} & \bitbox{1}{\z1} & \bitbox{5}{\z{0x0F}} &
	\bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup}\\
%CF
	\begin{leftwordgroup}{indirect}
	\begin{rightwordgroup}{\z{push [9]}}
	\bitbox{1}{\z1} & \bitbox{1}{\z1} & \bitbox{1}{\z0} & \bitbox{5}{\z{0x0F}} &
	\bitbox{8}{\z{0x09}}
	\end{leftwordgroup}
	\end{rightwordgroup} \\
%EF
	\begin{leftwordgroup}{loop stack}
	\begin{rightwordgroup}{\z{push \{\$\}}}
	\bitbox{1}{\z1} & \bitbox{1}{\z1} & \bitbox{1}{\z1} & \bitbox{5}{\z{0x0F}} &
	\bitbox[]{8}{}
	\end{leftwordgroup}
	\end{rightwordgroup}\\
\end{bytefield}
\end{center}
Some of these combinations are special only for the \z{PUSH} and \z{POP} commands.
%, which is the only command
%to have eight modes.
The first mode is somewhat special as well.  Since ``\z{PUSH \$}'' would
not do anything particularly useful---pop a value from the stack and then put it right back 
again---this opcode was reassigned to a similar but more useful operation.  Renamed \z{DUP},
it takes the value on the top of the stack and pushes another copy of it.

\subsection{Using the Value Stack}
The operation of the loop stack and call stack take place behind the scenes where you don't
really need to be too concerned about them.  The data stack, on the other hand, is important
to understand if you'll be writing sequences at the low level of the bytecodes described here.

The stack has a maximum depth of 256 bytes.  Values are pushed onto it (usually via the \z{PUSH}
instruction) and those values are consumed by other instructions as needed.  A \z\$ appearing in
an instruction's argument list means to pop a value off the stack for that parameter.

Consider the following sequence of instructions:
\begin{SourceCode}
base=2
for x=1 to 20:
  on x
  dimmer x+10+base 6*x+12
  wait 100
  base *= 3
end
\end{SourceCode}

This would be compiled into the following sequence bytecode:
\begin{SourceCode}
ADDR BYTES          LINE SOURCE CODE
---- -------------- ---- ------------------------
0000 4F 02          0002      PUSH   #2
0002 AA             0003 L:   LOOP   #1
0003 6F             0004      PUSH   {0}
0004 81             0005      ON     $
0005 6F             0006      PUSH   {0}
0006 52 06          0007      MUL    $,#6
0008 53 0C          0008      ADD    $,#12
000A 6F             0009      PUSH   {0}
000B 53 0A          0010      ADD    $,#10
000D AF             0011      PUSH   [0]
000E 13             0012      ADD    $,$
000F 02             0013      DIMMER $,$
0010 49 64          0014      WAIT   #100
0012 AF             0015      PUSH   [0]
0013 52 03          0016      MUL    $,#3
0015 B0             0017      POP    [0]
0016 6B 02 14       0018      NEXT   L,#1,#20
\end{SourceCode}

When executed, this is the sequence of steps carried out, and the stack's contents
at each step.  Here's the initial state:

\begin{bytefield}{32}
  \bitbox[]{8}{Instruction:} 
  & \bitbox[]{2}{} & \bitbox[]{2}{} 
  & \bitbox[]{8}{Value Stack:} & \bitbox[]{4}{} 
  & \bitbox[]{2}{}
  & \bitbox[]{8}{Loop Stack:}\\
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{(empty)} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{(empty)}
\\
\end{bytefield}

Now we begin execution.  First, we create a local variable ``\z{base}'' by pushing
its initial value (2) onto the stack.  This will be at address zero (relative to the
base stack frame pointer), so ``\z{[0]}'' will directly reference this storage location.

\begin{bytefield}{32}
  \bitbox[]{8}{\z{PUSH \#2}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{(empty)}
\\
\end{bytefield}

A new loop context is created with an initial counter value of 1 (now the top of the loop
stack).

\begin{bytefield}{32}
  \bitbox[]{8}{\z{LOOP \#1}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

Next we turn on the channel specified by the value of the loop counter, which is on the 
loop stack at \z{\{0\}}.  We push that counter onto the data stack then use that as the
argument to the \z{ON} instruction.

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{1} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{PUSH \{0\}}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

Since the value at the top of the stack (\Var{x}) is~1, the
instruction \z{ON \$} pops that value and turns on channel~1.

\begin{bytefield}{32}
  \bitbox[]{8}{\z{ON \$}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

Now we need to evaluate \z{6*x+12}.

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{1} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{PUSH \{0\}}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

The 1 on the top of the stack is popped off, multiplied by 6, and the
product pushed back onto the stack:

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{6} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{MUL \$,\#6}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}
  
The product is popped, added to 12 and the sum pushed back:

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{18} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{ADD \$,\#12}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

Now that we have the value to be set on the channel (18),
we calculate the channel number as \z{x+10+base}:

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{1} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{18} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{PUSH \{0\}}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{11} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{18} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{ADD \$,\#10}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

The value of the local variable \z{base} is at local address
0 (i.e., \acronym{SFB}+0, also known as ``\z{[0]}''), so we push that onto
the stack then add it to our sum.

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{11} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{18} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{PUSH [0]}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{13} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{18} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{ADD \$,\$}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

Now we pop the channel number and level off the stack
so channel~13 is set to dimmer level~18.

\begin{bytefield}{32}
  \bitbox[]{8}{\z{DIMMER \$,\$}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

Now we wait, which doesn't affect the stack.

\begin{bytefield}{32}
  \bitbox[]{8}{\z{WAIT \#100}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}

To update the value of the variable \z{base}, we push its
current value from memory location \z{[0]}, multiply it by 3
to get the new value, and the pop that result back into 
memory location \z{[0]} again.\footnote{``Wait a moment,'' you may be asking yourself
at this point, ``The value of \z{base} is sitting \emph{right there} on the stack,
why not just execute the single instruction \z{MUL \#3} and accomplish the same
thing in one step?'' The answer is that you can, in this particular case.  In some sequences,
though, there may be other variables in the way, so the approach outlined here will
work in the general case.  If you're hand-compiling your own bytecode, you can make
optimizations like that.}

\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{2} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{PUSH [0]}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}
  
\begin{bytefield}{32}
  \bitbox[]{8}{} 
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{6} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{\z{MUL \$,\#3}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{2} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}
  
\begin{bytefield}{32}
  \bitbox[]{8}{\z{POP [0]}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{6} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{1}
\\
\end{bytefield}
  
We then start the next iteration.

\begin{bytefield}{32}
  \bitbox[]{8}{\z{NEXT L,\#1,\#20}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{6} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{2}
\\
\end{bytefield}

\dots\ and so on, until we reach the end of the final iteration:

\begin{bytefield}{32}
  \bitbox[]{8}{\z{}}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{34} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
\end{bytefield}

(Note that the value in \z{[0]}---the local variable ``\z{base}''---is multiplied
by 3$\times$ every iteration, so although the value in the 8-bit memory location is
currently 34, it has overflowed 13~times already.  Remember that you are working with
only 8-bit values on the Lumos device.)

When the \z{NEXT} instruction is executed, it determines that the loop exit
condition has been met, and destroys the loop context, does \emph{not} jump to
the top of the loop, and execution will continue on past the loop now.

\begin{bytefield}{32}
  \bitbox[]{8}{\z{NEXT 2,\#1,\#20}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{34} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{(empty)}
\\
\end{bytefield}

\subsection{Subroutine Calls and Parameter Passing}
The basic unit of execution is a sequence itself, so when we speak of calling a ``subroutine''
we really mean one sequence is calling another sequence (or recursively calling itself).

A number of parameters may be passed to the called sequence, which will appear as local
variables to it.  This is done by pushing their values onto the stack before making the
call.  Part of the call itself moves the stack frame boundary so that location \z{[0]}
refers to the first parameter.  The other parameters, if any, follow.  If the called
sequence sets up local variables, they'll be pushed after the parameters (which means
it is important that the sequences all agree about how many parameters are being passed
and received).

To illustrate this, consider the following pair of sequences:

\begin{SourceCode}
sequence 1:
  delay=10
  for i=0 to 255 by 4:
    for j=20 to 10 by -1:
      call 5(i,j)
      wait delay
    end
    delay += 10
  end
end
 
sequence 5(val,ch):
  foo=0x42
  dimmer ch, val
  on ch+20
  off ch+20
end
\end{SourceCode}

This compiles into the following bytecode:

\label{src:2seq}
\begin{SourceCode}
SEQUENCE #1 ASSEMBLY LISTING
ADDR BYTES          LINE SOURCE CODE
---- -------------- ---- -----------------------------
0000 4F 0A          0002 	PUSH    #10
0002 2A             0003 I_LOOP: LOOP    #0
0003 4A 14          0004 J_LOOP:	LOOP    #20
0005 4F 01          0005 	PUSH    #1
0007 EF             0006 	PUSH    {$}
0008 6F             0007 	PUSH    {0}
0009 48 05 02       0008 	CALL    #5,#2
000C AF             0009 	PUSH    [0]
000D 09             0010 	WAIT    $
000E 75 03 0A       0011 	NEXTDEC J_LOOP,#1,#10
0011 AF             0012 	PUSH    [0]
0012 53 0A          0013 	ADD     $,#10
0014 B0             0014 	POP     [0]
0015 4B 02 04 FF    0015 	NEXT    I_LOOP,#4,#255
0019 00             0016 	EXIT

SEQUENCE #5 ASSEMBLY LISTING
ADDR BYTES          LINE SOURCE CODE
---- -------------- ---- -----------------------------
0000 40 02          0019 	SSFB    #2
0002 4F 42          0020 	PUSH    #0x42
0004 AF             0021 	PUSH    [0]
0005 CF 01          0022 	PUSH    [1]
0007 02             0023 	DIMMER  $,$
0008 CF 01          0024 	PUSH    [1]
000A 53 14          0025 	ADD     $,#20
000C 0F             0026 	DUP
000D 81             0027 	ON      $
000E 01             0028 	OFF     $
000F 00             0029 	EXIT
\end{SourceCode}

We'll step through the execution of these routines to show how the stack frames
look between calls.

First, sequence~1 starts running, pushes its local variable to the stack, and enters
its loops:

\begin{bytefield}{32}
  \bitbox[]{8}{\z{PUSH \#10}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{(empty)}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{\z{LOOP \#0}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \bitbox[]{8}{} & \bitbox[]{4}{}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{LOOP \#20}} 
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

We push the two parameters onto the stack in the order shown in the source code
(i.e., the deepest value will be the first parameter).  Since the call is
``\z{CALL 5(x,y)}'' we need to push the outer loop counter \z{x} (which is 
at position \z{\{1\}} on the loop stack), then the inner loop counter \z{y}
(which is at position \z{\{0\}}).

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{1} & \bitbox[]{4}{}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH \#1}}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{0} & \bitbox[]{4}{}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH \{\$\}}}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0} & \bitbox[]{4}{}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH \{0\}}}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

Now we make the call.  The first parameter to \z{CALL} is the sequence number
we're calling, and the second is the number of parameters being passed (2 in this
case).

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{CALL \#5,\#2}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

At this point, control transfers into sequence~5.  Note that the stack frame boundary
moved up until the frame includes only the top 2 items (the two parameters passed into 
this sequence).  This means the parameters are directly accessible as \z{[0]}
and \z{[1]}, and the local variable sequence~5 is about to create will be \z{[2]}.  The
local variable from the calling sequence (the value 10 on the stack) is not directly
accessible for now.\footnote{Yes, if you're clever or careless enough, you can destroy
the integrity of the stack(s) to retrieve or alter the values below \acronym{SFB}, but
we're not recommending that.}

The first thing sequence~5 does is to ensure the stack frame is as expected.  

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{SSFB \#2}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

Next, it will
push the initial value of the local variable
\z{foo}, so we can get to it at location \z{[2]}.

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH \#0x42}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

Now we set the dimmer value of channel \z{[1]} to level \z{[0]}.

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{0} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH [0]}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[4]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH [1]}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{DIMMER \$,\$}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

Now we calculate the value of \z{[1]}+20 which will 
be used for both the \z{ON} and \z{OFF} commands.

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{0} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH [1]}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{ADD \#20}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[4]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{DUP}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[3]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{ON \$}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[2]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{0x42} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{20} & \bitbox[]{4}{}
  & \bitbox[]{2}{} & \bitbox[]{8}{}
\\
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{z}}
  & \bitbox{8}{0} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{OFF \$}}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \colorbitbox{lightgray}{8}{10} & \bitbox[]{4}{} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

Now sequence~5 is done.  As it exits, the calling sequence resumes
where it left off, and the stack frame is destroyed, restoring the
\acronym{SFB} to its previous location.

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{} & \bitbox[]{2}{}
  & \bitbox[]{8}{} & \bitbox[]{4}{}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{EXIT}}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}

Execution of sequence~1 continues\dots.

\begin{bytefield}{32}
  \bitbox[]{8}{}
  & \bitbox[]{2}{\z{[1]}} & \bitbox[]{2}{\Var{x}}
  & \bitbox{8}{10} & \bitbox[]{4}{}
  & \bitbox[]{2}{\z{\{0\}}} & \bitbox{8}{20}
\\
  \bitbox[]{8}{\z{PUSH [0]}}
  & \bitbox[]{2}{\z{[0]}} & \bitbox[]{2}{\Var{y}}
  & \bitbox{8}{10} & \bitbox[]{4}{$\leftarrow$\acronym{SFB}} 
  & \bitbox[]{2}{\z{\{1\}}} & \bitbox{8}{0}
\\
\end{bytefield}
\subsection{Instruction Set}
\newenvironment{opdesc}{\medskip\noindent\begin{tabular}{lll|ll|l}
  \multicolumn{3}{l|}{Bytes} & \multicolumn{2}{l|}{Instruction} & Description\\\hline}{\end{tabular}}
\subsubsection{\z{ADD/INCR}: Add Two Numbers}
Adds the top two numbers on the stack (or the top number and another value), 
and pushes their sum back onto the 
stack.  Note that both operands, and the sum, are unsigned 8-bit values (0--255).
If the result exceeded this range, the result will be inaccurate (it will be the least
significant 8 bits of the value) and the overflow flag will be raised which you can test
using conditional branch instructions such as \z{IFANY}.

As a special case, the operation of adding 1 to a value is named \z{INCR} to reflect that it
is simply incrementing that value by one.

\begin{opdesc}
  \z{13} &            &&\z{ADD}&\z{\$,\$}& \Var{y} $+$ \Var{x} $\rightarrow$ \Var{x}.\\
  \z{53} & \Var*{v}   &&\z{ADD}&\z{\$,\#}\Var*{v}& \Var{x} $+$ \Var*{v} $\rightarrow$ \Var{x}.\\
  \z{33} &            &&\z{INCR}&\z{\$}& \Var{x} $+$ 1 $\rightarrow$ \Var{x}.\\
\end{opdesc}

\subsubsection{\z{BLACKOUT}: Turn Off All Channels at Once}
All channels are immediately turned off, or in the case of \z{FADEOUT}, all channels are smoothly
faded down to off.

\begin{opdesc}
  \z{0D} &&&\z{BLACKOUT}&&Turn off all channels.\\
  \z{8D} &&&\z{FADEOUT}&&Fade all channels to zero.\\
\end{opdesc}

\subsubsection{\z{BREAK}: Escape From Loop}
This is a special form of \z{JUMP} which is designed to branch out of a loop body.
In addition to jumping to the destination address, it destroys one or more loop contexts.  You must
ensure that the correct number of loops is specified when using \z{BREAK} to escape out
of one or more loop bodies.

\begin{opdesc}
  \z{83} & \Var*{addr} &&\z{BREAK}&\Var*{addr}\z{,\$} &  break out of \Var{x} loops\\
  \z{A3} & \Var*{addr} &&\z{BREAK}&\Var*{addr}        & break out of innermost loop\\
  \z{C3} & \Var*{addr} & \Var*{n} & \z{BREAK}&\Var*{addr}\z{,\#}\Var*{n} & break out of \Var*{n} loops\\
\end{opdesc}

\subsubsection{\z{CALL}: Invoke Sequence as a Subroutine}
Begins excuting a new sequence, possibly with parameters passed into it.
When that sequence completes, the current one will resume where it left off.

\begin{opdesc}
  \z{08} &            &           &\z{CALL}&\z{\$,\$} & Call \Var{x} with \Var{y} params.\\
  \z{28} &            &           &\z{CALL}&\z{\$}    & Call \Var{x} with no params.\\
  \z{48} & \Var*{seq} & \Var*{np} &\z{CALL}&\z{\#}\Var*{seq}\z{,\#}\Var*{np} & Call \Var*{seq} with \Var*{np} params.\\
  \z{68} & \Var*{seq} &           &\z{CALL}&\z{\#}\Var*{seq} & Call \Var*{seq} with no params.\\
\end{opdesc}


\subsubsection{\z{DIMMER}: Set a Channel Dimmer To a Value}
The specified channel \Var*{ch} is set to dimmer level \Var*{lvl} (0--255).

\begin{opdesc}
  \z{02} &            &           &\z{DIMMER}&\z{\$,\$} & Set channel \Var{x} to level \Var{y}.\\
  \z{42} & \Var*{ch} & \Var*{lvl} &\z{DIMMER}&\z\#\Var*{ch}\z{,\#}\Var*{lvl} & Set \Var*{ch} to \Var*{lvl}.\\
\end{opdesc}

\subsubsection{\z{EXCH}: Exchange Data Stack Values}
Swaps the top two values on the data stack (\Var{x} $\leftrightarrow$ \Var{y}).

\begin{opdesc}
  \z{11} &            &           &\z{EXCH}&& Swap \Var{x} and \Var{y}.\\
\end{opdesc}

\subsubsection{\z{EXEC}: Start New Sequence}
Begins excuting a new sequence, possibly with parameters passed into it.
This sequence replaces the current one.  When the called sequence \Var*{seq} exits,
execution returns to the caller of the current sequence (if any).

\begin{opdesc}
  \z{88} &            &           &\z{EXEC}&\z{\$,\$} & Run \Var{x} with \Var{y} params.\\
  \z{A8} &            &           &\z{EXEC}&\z{\$}    & Run \Var{x} with no params.\\
  \z{C8} & \Var*{seq} & \Var*{np} &\z{EXEC}&\z{\#}\Var*{seq}\z{,\#}\Var*{np} & Run \Var*{seq} with \Var*{np} params.\\
  \z{E8} & \Var*{seq} &           &\z{EXEC}&\z{\#}\Var*{seq} & Run \Var*{seq} with no params.\\
\end{opdesc}

\subsubsection{\z{EXIT}: Stop Execution of a Sequence}
The current sequence is terminated.  This will return to the previous sequence context
(resuming the previous sequence if we arrived here from a \z{CALL} instruction).  If this
was the outermost executing sequence, then no sequence will be running anymore.

\begin{opdesc}
  \z{00} &&&\z{EXIT}&& Terminate sequence.
\end{opdesc}

\subsubsection{\z{FADE}: Fade a Channel Down to Off}
Incrementally decrease the dimmer level of channel \Var*{ch} by subtracting \Var*{step}, with a delay
of \Var*{t}/120\,sec between each step, until it reaches the minimum level of 0.

\begin{opdesc}
  \z{04} &&&\z{FADE}&\z{\$,\$,\$}& Fade \Var{x} by \Var{y} per \Var{z}.\\
  \z{44} &\multicolumn{2}{l|}{\Var*{ch} \Var*{step} \Var*{t}}&\z{FADE}&\z\#\Var*{ch}\z{,\#}\Var*{step}\z{,\#}\Var*{t}& Fade \Var*{ch} by \Var*{step} per \Var*{t}.\\
\end{opdesc}

\subsubsection{\z{IF*}: Conditional Jumps}
The \z{JUMP} instruction always transfers control to the specified address.  The following
alternatives evaluate some condition, and if that condition is currently true, transfers
the flow of the sequence execution to the specified address \Var*{addr}.

Most of these compare two values for equality or inequality:

\begin{opdesc}
  \z{0C00} & \Var*{addr} &&\z{IFEQ}&\Var*{addr}\z{,\$,\$}& Jump to \Var*{addr} if \Var{y} $=$ \Var{x}.\\
  \z{4C00} & \Var*{addr} &\Var*{v}&\z{IFEQ}&\Var*{addr}\z{,\$,\#}\Var*{v}& Jump to \Var*{addr} if \Var{x} $=$ \Var*{v}.\\
  \z{0C40} & \Var*{addr} &&\z{IFLT}&\Var*{addr}\z{,\$,\$}& Jump to \Var*{addr} if \Var{y} $<$ \Var{x}.\\
  \z{4C40} & \Var*{addr} &\Var*{v}&\z{IFLT}&\Var*{addr}\z{,\$,\#}\Var*{v}& Jump to \Var*{addr} if \Var{x} $<$ \Var*{v}.\\
  \z{0C80} & \Var*{addr} &&\z{IFGT}&\Var*{addr}\z{,\$,\$}& Jump to \Var*{addr} if \Var{y} $>$ \Var{x}.\\
  \z{4C80} & \Var*{addr} &\Var*{v}&\z{IFGT}&\Var*{addr}\z{,\$,\#}\Var*{v}& Jump to \Var*{addr} if \Var{x} $>$ \Var*{v}.\\
  \z{8C00} & \Var*{addr} &&\z{IFNE}&\Var*{addr}\z{,\$,\$}& Jump to \Var*{addr} if \Var{y} $\ne$ \Var{x}.\\
  \z{CC00} & \Var*{addr} &\Var*{v}&\z{IFNE}&\Var*{addr}\z{,\$,\#}\Var*{v}& Jump to \Var*{addr} if \Var{x} $\ne$ \Var*{v}.\\
  \z{8C40} & \Var*{addr} &&\z{IFGE}&\Var*{addr}\z{,\$,\$}& Jump to \Var*{addr} if \Var{y} $\ge$ \Var{x}.\\
  \z{CC40} & \Var*{addr} &\Var*{v}&\z{IFGE}&\Var*{addr}\z{,\$,\#}\Var*{v}& Jump to \Var*{addr} if \Var{x} $\ge$ \Var*{v}.\\
  \z{8C80} & \Var*{addr} &&\z{IFLE}&\Var*{addr}\z{,\$,\$}& Jump to \Var*{addr} if \Var{y} $\le$ \Var{x}.\\
  \z{CC80} & \Var*{addr} &\Var*{v}&\z{IFLE}&\Var*{addr}\z{,\$,\#}\Var*{v}& Jump to \Var*{addr} if \Var{x} $\le$ \Var*{v}.\\
\end{opdesc}

The following forms test the status of a number of boolean flags in the system:

\begin{opdesc}
  \z{0CC}\Var{q} & \Var*{addr} &&\z{IFANY}&\Var*{addr}\z{,}\Var*{flags}& Jump to \Var*{addr} if any of \Var*{flags} true.\\
  \z{4CC}\Var{q} & \Var*{addr} &&\z{IFALL}&\Var*{addr}\z{,}\Var*{flags}& Jump to \Var*{addr} if all of \Var*{flags} true.\\
  \z{8CC}\Var{q} & \Var*{addr} &&\z{IFNONE}&\Var*{addr}\z{,}\Var*{flags}& Jump to \Var*{addr} if none of \Var*{flags} true.\\
  \z{CCC}\Var{q} & \Var*{addr} &&\z{IFNALL}&\Var*{addr}\z{,}\Var*{flags}& Jump to \Var*{addr} if not all of \Var*{flags} true.\\
\end{opdesc}

\medskip

In other words, these correspond to the combination of the specified bits using logical 
\acronym{OR}, \acronym{AND}, \acronym{NOR}, and \acronym{NAND} operations, respectively.

The actual flag bits are specified by \acronym{OR}-ing together the following bits to get
the final opcode value (second byte).  Flags not
included will not be part of the test.

\medskip\noindent\begin{tabular}{l|l|l}
Bits & Flag Name & Description \\\hline
\z{0020} & \z{Z} & Last \z{ADD}/\z{MUL}/\z{NEXT}/\z{SUB} result was zero.\\
\z{0010} & \z{V} & Last \z{ADD}/\z{MUL}/\z{NEXT}/\z{SUB} result overflowed.\\
\z{0008} & \z{A} & Sensor A input is low (0\,V).\\
\z{0004} & \z{B} & Sensor B input is low (0\,V).\\
\z{0002} & \z{C} & Sensor C input is low (0\,V).\\
\z{0001} & \z{D} & Sensor D input is low (0\,V).\\
\end{tabular}

\medskip

Watch for the fact that the sensors are ``true'' if they are at ground potential, regardless of
whether any triggers configured for them are set to activate when the sensor reads high or low.
\subsubsection{\z{JUMP}: Go to New Address}
Jump to the specified \Var*{address}.

\begin{opdesc}
  \z{03} &\Var*{addr}&&\z{JUMP}&\Var*{addr}\z{,\$}& Jump to \Var*{addr}+\Var{x}\\
  \z{23} &\Var*{addr}&&\z{JUMP}&\Var*{addr}       & Jump to \Var*{addr}\\
  \z{43} &\Var*{addr}&\Var*{offset}&\z{JUMP}&\Var*{addr}\z{,\#}\Var*{offset}& Jump to \Var*{addr}+\Var*{offset}\\
\end{opdesc}

\subsubsection{\z{LOOP}: Start New Loop Context}
Begins a new loop context, initializing the loop counter to a specified value.  This pushes the value
onto the loop stack.  This will henceforth be accessible as ``\z{\{0\}}'' for instructions which can
see loop counters, and the previous \z{\{0\}} is now \z{\{1\}} (i.e., \z{\{0\}} always refers to the innermost loop, \z{\{1\}} is the next level of loop context counting outward, etc.).

This loop context is destroyed (and the counter popped off the loop stack) by a corresponding
\z{BREAK}, \z{NEXT}, or \z{NEXTDEC}.

\begin{opdesc}
  \z{0A} &            &&\z{LOOP}&\z{\$} & Start loop with initial value \Var{x}.\\
  \z{2A} &            &&\z{LOOP}&\z{\#0}& Start loop with initial value 0.\\
  \z{4A} & \Var*{n}   &&\z{LOOP}&\z{\#}\Var*{n} & Start loop with initial value \Var*{n}.\\
  \z{AA} &            &&\z{LOOP}&\z{\#1}& Start loop with initial value 1.\\
\end{opdesc}

\subsubsection{\z{MUL}: Multiply Two Numbers}
Multiplies the top two numbers on the stack (or the top number and another value), 
and pushes their product back onto the 
stack.  Note that both operands, and the product, are unsigned 8-bit values (0--255).
If the result exceeded this range, the result will be inaccurate (it will be the least
significant 8 bits of the value) and the overflow flag will be raised which you can test
using conditional branch instructions such as \z{IFANY}.

\begin{opdesc}
  \z{12} &            &&\z{MUL}&\z{\$,\$}& \Var{y} $\times$ \Var{x} $\rightarrow$ \Var{x}.\\
  \z{52} & \Var*{v}   &&\z{MUL}&\z{\$,\#}\Var*{v}& \Var{x} $\times$ \Var*{v} $\rightarrow$ \Var{x}.\\
\end{opdesc}

\subsubsection{\z{NEXT}: End Loop Body (Start Next Iteration)}
This instruction (including a few variant forms as described below) marks the end of the loop
body began with a \z{LOOP} instruction.  It specifies an increment or decrement value to be
applied to the innermost loop counter, and a maximum value (or minimum, if decrementing).
If the loop counter is greater than the maximum or less than the minimum after updating it,
the loop context is destroyed and execution continues with the following instruction.
Otherwise, execution jumps to the address specified in the \z{NEXT} instruction, which should
be the address of the first instruction after the matching \z{LOOP} (although it need not be,
if you want some initialization code to take place at the start of the first iteration which
is not repeated on subsequent iterations).

\begin{opdesc}
  \z{0B} & \Var*{addr}&&\z{NEXT}&\Var*{addr}\z{,\$,\$} & Loop to \Var*{addr} if \z{\{0\}}+=\Var{x}$\le$\Var{y}.\\
  \z{2B} & \Var*{addr}&&\z{NEXT}&\Var*{addr}\z{,\#1,\$}& Loop to \Var*{addr} if \z{\{0\}}+=1$\le$\Var{x}.\\
  \z{4B} & \Var*{addr}& \Var*{inc} \Var*{max}&\z{NEXT}&\Var*{addr}\z{,\#}\Var*{inc}\z{,\#}\Var*{max}& Loop to \Var*{addr} if \z{\{0\}}+=\Var*{inc}$\le$\Var*{max}.\\
  \z{6B} & \Var*{addr}&\Var*{max}&\z{NEXT}&\Var*{addr}\z{,\#1,\#}\Var*{max}& Loop to \Var*{addr} if \z{\{0\}}+=1$\le$\Var*{max}.\\
  \z{15} & \Var*{addr}&&\z{NEXTDEC}&\Var*{addr}\z{,\$,\$} & Loop to \Var*{addr} if \z{\{0\}}--=\Var{x}$\ge$\Var{y}.\\
  \z{35} & \Var*{addr}&&\z{NEXTDEC}&\Var*{addr}\z{,\#1,\$}& Loop to \Var*{addr} if \z{\{0\}}--=1$\ge$\Var{x}.\\
  \z{55} & \Var*{addr}& \Var*{dec} \Var*{min}&\z{NEXTDEC}&\Var*{addr}\z{,\#}\Var*{dec}\z{,\#}\Var*{min}& Loop to \Var*{addr} if \z{\{0\}}--=\Var*{dec}$\ge$\Var*{min}.\\
  \z{75} & \Var*{addr}&\Var*{min}&\z{NEXTDEC}&\Var*{addr}\z{,\#1,\#}\Var*{min}& Loop to \Var*{addr} if \z{\{0\}}--=1$\ge$\Var*{min}.\\
  \z{8B} & \Var*{addr}&&\z{NEXTINF}&\Var*{addr}\z{,\$} & $\infty$ loop to \Var*{addr}, \z{\{0\}}+=\Var{x}.\\
  \z{AB} & \Var*{addr}&&\z{NEXTINF}&\Var*{addr}\z{,\#1}& $\infty$ loop to \Var*{addr}, \z{\{0\}}+=1.\\
  \z{CB} & \Var*{addr}&\Var*{inc}&\z{NEXTINF}&\Var*{addr}\z{,\#}\Var*{inc}& $\infty$ loop to \Var*{addr}, \z{\{0\}}+=\Var*{inc}.\\
  \z{95} & \Var*{addr}&&\z{NXDCINF}&\Var*{addr}\z{,\$} & $\infty$ loop to \Var*{addr}, \z{\{0\}}--=\Var{x}.\\
  \z{B5} & \Var*{addr}&&\z{NXDCINF}&\Var*{addr}\z{,\#1}& $\infty$ loop to \Var*{addr}, \z{\{0\}}--=1.\\
  \z{D5} & \Var*{addr}&\Var*{dec}&\z{NXDCINF}&\Var*{addr}\z{,\#}\Var*{dec}& $\infty$ loop to \Var*{addr}, \z{\{0\}}--=\Var*{dec}.\\
\end{opdesc}

\subsubsection{\z{NOP}: No Operation}
When this instruction is executed, nothing happens.

\begin{opdesc}
  \z{0E}&&&\z{NOP}&&No operation.\\
\end{opdesc}

\subsubsection{\z{OFF}: Turn a Channel Off}
The specified channel is turned fully off.

\begin{opdesc}
  \z{01} &           &&\z{OFF}&\z{\$}& Turn off channel \Var{x}.\\
  \z{41} &\Var*{chan}&&\z{OFF}&\z\#\Var*{chan}& Turn off \Var*{chan}.\\
\end{opdesc}

\subsubsection{\z{ON}: Turn a Channel On}
The specified channel is turned fully on.

\begin{opdesc}
  \z{81} &           &&\z{ON}&\z{\$}& Turn on channel \Var{x}.\\
  \z{C1} &\Var*{chan}&&\z{ON}&\z\#\Var*{chan}& Turn on \Var*{chan}.\\
\end{opdesc}

\subsubsection{\z{DROP/POP}: Remove a Value From the Stack}
The \z{DROP} instructions remove values from the stack and discard them. 
The \z{POP} instructions remove values and store them elsewhere in memory
(loop counters and direct memory locations).

For example, \z{DROP \$} pops the top value off the data stack (\Var{x}),
and then pops \Var{x} more values off and discards them.

\z{POP [\$]} removes the top value \Var{x}, which is used as the address
within memory (i.e., \z{[}\Var{x}\z{]}) into which to store the next value
\Var{y} on the stack.  This will remove both values from the stack.

\begin{opdesc}
  \z{10}&&&\z{DROP}&\z{\$}&Drop \Var{x} values, plus \Var{x} itself.\\
  \z{30}&&&\z{DROP}&&Drop the top value (\Var{x}).\\
  \z{50}&\Var*{n}&&\z{DROP}&\z{\#}\Var*{n}&Drop the top \Var*{n} values.\\
  \z{70}&&&\z{POP}&\z{\{0\}}&Store \Var{x} into loop counter \z{\{0\}}.\\
  \z{90}&&&\z{POP}&\z{[\$]}&Store \Var{y} into memory address in \Var{x}.\\
  \z{B0}&&&\z{POP}&\z{[0]}&Store \Var{x} into memory address 0.\\
  \z{D0}&\Var*{a}&&\z{POP}&\z{[}\Var*{a}\z{]}&Store \Var{x} into address \Var*{a}.\\
  \z{F0}&&&\z{POP}&\z{\{\$\}}&Store \Var{y} into loop counter for level \Var{x}.\\
\end{opdesc}

\subsubsection{\z{PUSH/DUP}: Push a Value Onto the Stack}
Adds a value to the data stack from various sources.  As a special case, \z{DUP} duplicates
the top value on the stack (i.e., pushes another copy of the top value).

The values pushed onto the data stack are consumed by most other commands, or removed from
the stack by \z{DROP} and \z{POP} instructions.

\begin{opdesc}
  \z{0F}&&&\z{DUP}&&Duplicate \Var{x}.\\
  \z{2F}&&&\z{PUSH}&\z{\#0}&Push a 0 constant value.\\
  \z{4F}&\Var*{v}&&\z{PUSH}&\z{\#}\Var*{v}&Push value \Var*{v}.\\
  \z{6F}&&&\z{PUSH}&\z{\{0\}}&Push loop counter \z{\{0\}}.\\
  \z{8F}&&&\z{PUSH}&\z{[\$]}&Push contents of address in \Var{x}.\\
  \z{AF}&&&\z{PUSH}&\z{[0]}&Push contents of address 0.\\
  \z{CF}&\Var*{a}&&\z{PUSH}&\z{[}\Var*{a}\z{]}&Push contents of address \Var*{a}.\\
  \z{EF}&&&\z{PUSH}&\z{\{\$\}}&Push loop counter for level \Var{x}.\\
\end{opdesc}

\subsubsection{\z{RAMP}: Fade a Channel Up to Full Brightness}
Incrementally increase the dimmer level of channel \Var*{ch} in increments of \Var*{step}, with a delay
of \Var*{t}/120\,sec between each step, until it reaches the maximum level of 255.

\begin{opdesc}
  \z{84} &&&\z{RAMP}&\z{\$,\$,\$}& Ramp \Var{x} by \Var{y} per \Var{z}.\\
  \z{C4} &\multicolumn{2}{l|}{\Var*{ch} \Var*{step} \Var*{t}}&\z{RAMP}&\z\#\Var*{ch}\z{,\#}\Var*{step}\z{,\#}\Var*{t}& Ramp \Var*{ch} by \Var*{step} per \Var*{t}.\\
\end{opdesc}

\subsubsection{\z{RESUME}: Resume From \z{SUSPEND}}
Resume acting on incoming instructions from the host PC.
If the \z{RESFADE} version is used, all channels are smoothly faded to
black then faded up to their last-known intended values (either the levels
they had when \z{SUSPEND} was invoked, or the result of the subsequent
PC commands if \z{SUSPUPD} was used).

\begin{opdesc}
  \z{06} &&&\z{RESUME}&& Resume command interpretation.\\
  \z{86} &&&\z{RESFADE}&& Fade through black and resume.
\end{opdesc}

\subsubsection{\z{SLEEP}: Shut Down Load Power}
Tell the load power supply it can shut down.  Requires a properly-configured
compatible power supply.

\begin{opdesc}
  \z{07} &&&\z{SLEEP}&& Turn off load power supply.
\end{opdesc}

\subsubsection{\z{SSFB}: Set Stack Frame Boundary}
The first instruction of a sequence which expects parameters to be passed into it
should be \z{SSFB} with the number of parameters expected (\Var*{np}).  This will reserve enough
space on the stack and initialze it with zero values.

Ideally, if another sequence called this one, it will have already pushed parameters
and moved the stack frame boundary (\acronym{SFB}) so that those parameters are the only
items in the current stack frame.  When the called sequence executes \z{SSFB}, if this
is the case, and the number of values in the stack frame equals \Var*{np},
nothing further is done.  If the number of values is less than \Var*{np}, additional zero bytes
will be pushed onto the stack to make the stack have exactly \Var*{np} values from \acronym{SFB}
upward.  If the number of values in the stack frame exceeds \Var*{np}, a fatal error is flagged
and the sequence terminates immediately.  (This latter condition means that too many values
are there, which will cause the sequence to confuse them with where it expects its own
local variables to be addressed within the stack frame).

\begin{opdesc}
  \z{40} & \Var*{np}&&\z{SSFB}&\z{\#}\Var*{np}& Ensure stack frame has \Var*{np} values.\\
\end{opdesc}

\subsubsection{\z{SUB/DECR}: Subtract Two Numbers}
Subtracts the top value on the stack from the next value (or another value from the top value),
and pushes their difference back onto the 
stack.  Note that both operands, and the result, are unsigned 8-bit values (0--255).
If the result exceeded this range (including by dropping below zero), 
the result will be inaccurate (it will be the least
significant 8 bits of the value) and the overflow flag will be raised which you can test
using conditional branch instructions such as \z{IFANY}.

As a special case, the operation of subtracting 1 from a value is named \z{DECR} to reflect that it
is simply decrementing that value by one.

\begin{opdesc}
  \z{14} &            &&\z{SUB}&\z{\$,\$}& \Var{y} $-$ \Var{x} $\rightarrow$ \Var{x}.\\
  \z{54} & \Var*{v}   &&\z{SUB}&\z{\$,\#}\Var*{v}& \Var{x} $-$ \Var*{v} $\rightarrow$ \Var{x}.\\
  \z{34} &            &&\z{DECR}&\z{\$}& \Var{x} $-$ 1 $\rightarrow$ \Var{x}.\\
\end{opdesc}


\subsubsection{\z{SUSPEND}: Stop Accepting Commands}
Stop acting on incoming instructions from the host PC until a \z{RESUME} instruction is executed.
If the \z{SUSPEND UPDATE} version is used, the effects of the commands are still remembered but
channel outputs are not actually affected.

\begin{opdesc}
  \z{05} &&&\z{SUSPEND}&& Suspend command interpretation.\\
  \z{85} &&&\z{SUSPUPD}&& Suspend tracking updates.
\end{opdesc}

\subsubsection{\z{WAIT}: Delay}
Pauses execution for \Var*{time}/120 seconds.

\begin{opdesc}
  \z{09} &&&\z{WAIT}&\z{\$}& Wait \Var{x}/120\,s.\\
  \z{49} &\Var*{time}&&\z{WAIT}&\z{\#}\Var*{time}& Wait \Var*{time}/120\,s.\\
\end{opdesc}

\subsubsection{\z{WAKE}: Turn On Load Power}
Tell the load power supply it can start up.  Requires a properly-configured
compatible power supply.

\begin{opdesc}
  \z{87} &&&\z{WAKE}&& Turn on load power supply.
\end{opdesc}



\begin{table}
  \begin{center}
    \begin{tabular}{llll|llll}
	Opcode & Args & Mode & Instruction & 		Opcode & Args & Mode & Instruction\\
	\z{00} &      & inh  & exit   			\\
	\z{01} &      & stk  & off \$ 			& \z{81} &      & stk  & on \$ \\
	\z{02} &      & stk  & dimmer \$,\$ 		\\
	\z{03} & a    & stk  & jump a,\$		& \z{83} & a    & stk  & break a,\$ \\
	\z{04} &      & stk  & fade \$,\$,\$		& \z{84} &      & stk  & ramp \$,\$,\$\\
	\z{05} &      & inh  & suspend			& \z{85} &      & inh  & suspupd\\
	\z{06} &      & inh  & resume			& \z{86} &      & inh  & resfade\\
	\z{07} &      & inh  & sleep			& \z{87} &      & inh  & wake\\
	\z{08} &      & stk  & call \$,\$		& \z{88} &      & stk  & exec \$,\$\\
	\z{09} &      & stk  & wait \$ 			\\
	\z{0A} &      & stk  & loop \$			\\
	\z{0B} & a    & stk  & next a,\$,\$		& \z{8B} & a    & stk  & nextinf a,\$\\
%	\z{0C} &      &      & see conditionals		& \z{8C} &      &      & see conditionals\\
	\z{0D} &      & inh  & blackout                 & \z{8D} &      & inh  & fadeout\\
	\z{0E} &      & inh  & nop 			\\
	\z{0F} &      & inh  & dup         		& \z{8F} &      & i/s  & push [\$]\\
	\z{10} &      & inh  & drop \$ 			& \z{90} &      & i/s  & pop [\$]\\
	\z{11} &      & stk  & exch 			\\
	\z{12} &      & stk  & mul \$,\$		\\
	\z{13} &      & stk  & add \$,\$		\\
	\z{14} &      & stk  & sub \$,\$		\\
	\z{15} & a    & stk  & nextdec a,\$,\$		& \z{95} & a    & stk  & nxdcinf a,\$\\
	%\z{21} &      & def  & exch 			\\
	\z{23} & a    & def  & jump a			& \z{A3} & a    & def  & break a\\
	\z{28} &      & d/s  & call \$			& \z{A8} & i    & d/s  & exec \$\\
	\z{2A} &      & def  & loop \#0			& \z{AA} &      & def  & loop \#1\\
	\z{2B} & a    & d/s  & next a,\#1,\$		& \z{AB} & a    & d/s  & nextinf a,\#1\\
%	\z{2C} &      &      & see conditionals		& \z{AC} &      &      & see conditionals\\
	\z{2F} &      & def  & push \#0    		& \z{AF} &      & i/d  & push [0]\\
	\z{30} &      & def  & drop			& \z{B0} &      & i/d  & pop [0]\\
	\z{33} &      & def  & incr \$ 			\\
	\z{34} &      & def  & decr \$ 	 		\\
	\z{35} & a    & d/s  & nextdec a,\#1,\$		& \z{B5} & a    & d/s  & nxdcinf a,\#1\\
	\z{40} & n    & imm  & ssfb \#n 		\\
	\z{41} & c    & imm  & off \#c			& \z{C1} & c    & imm  & on  \#c \\
	\z{42} & c v  & imm  & dimmer \#c,\#v 		\\
	\z{43} & a o  & imm  & jump a,\#o		& \z{C3} & a n  & imm  & break a,\#n\\
	\z{44} & c s t& imm  & fade \#c,\#s,\#t		& \z{C4} & c s t& imm  & ramp \#c,\#s,\#t\\
	\z{48} & i n  & imm  & call \#i,\#n		& \z{C8} & i n  & imm  & exec \#i,\#n\\
	\z{49} & t    & imm  & wait \#t 		\\
	\z{4A} & v    & imm  & loop \#v			\\
	\z{4B} & a i x& imm  & next a,\#i,\#x		& \z{CB} & a i  & imm  & nextinf a,\#i\\
%	\z{4C} &      &      & see conditionals		& \z{CC} &      &      & see conditionals\\
	\z{4F} & v    & imm  & push \#v    		& \z{CF} & a    & ind  & push [a]\\
	\z{50} & n    & imm  & drop \#n  		& \z{D0} & a    & ind  & pop [a]\\
	%\z{51} & n    & imm  & exch \#n		\\
	\z{52} & x    & imm  & mul \$,\#x		\\
	\z{53} & x    & imm  & add \$,\#x		\\
	\z{54} & x    & imm  & sub \$,\#x		\\
	\z{55} & a i x& imm  & nextdec a,\#i,\#x 	& \z{D5} & a i  & imm  & nxdcinf a,\#i\\
	\z{68} & i    & i/d  & call \#i			& \z{E8} & i    & i/d  & fexec \#i\\
	\z{6B} & a x  & i/d  & next a,\#1,\#x		\\%& \z{EB} & a    & i/d  & nextinf a,\#1\\
%	\z{6C} &      &      & see conditionals		& \z{EC} &      &      & see conditionals\\
	\z{6F} &      & d/l  & push \{0\}    		& \z{EF} &      & s/l  & push \{\$\}\\
	\z{70} &      & d/l  & pop \{0\}    		& \z{F0} &      & s/l  & pop \{\$\}\\
	\z{75} & a x  & i/d  & nextdec a,\#1,\#x	\\%& \z{F5} & a    & i/d  & nxdcinf a,\#1\\
    \end{tabular}
  \end{center}
  \caption{Summary of Sequence Instructions by Opcode Value\label{tbl:opcodes}}
\end{table}


\begin{table}
  \begin{center}
    \begin{tabular}{llll|llll}
	Opcode & Args & Mode & Instruction & 		Opcode & Args & Mode & Instruction\\
	\z{0C00}&a    & stk  & ifeq a,\$		& \z{8C00}&a    & stk  & ifne a,\$\\
	\z{0C40}&a    & stk  & iflt a,\$		& \z{8C40}&a    & stk  & ifge a,\$\\
	\z{0C80}&a    & stk  & ifgt a,\$		& \z{8C80}&a    & stk  & ifle a,\$\\
	\z{0CCx}&a    & inh  & ifany a,f		& \z{8CCx}&a    & inh  & ifnone a,f\\   % or nor
	\z{4C00}&a x  & imm  & ifeq a,\#x		& \z{CC00}&a x  & imm  & ifne a,\#x\\
	\z{4C40}&a x  & imm  & iflt a,\#x		& \z{CC40}&a x  & imm  & ifge a,\#x\\
	\z{4C80}&a x  & imm  & ifgt a,\#x		& \z{CC80}&a x  & imm  & ifle a,\#x\\
	\z{4CCx}&a    & inh  & ifall a,f		& \z{CCCx}&a    & inh  & ifnall a,f\\   %and nand
    \end{tabular}
  \end{center}
  \caption{Summary of Conditional Jump Instructions by Opcode Value\label{tbl:conditionals}}
\end{table}

\begin{table}
  \begin{center}
    \begin{tabular}{rcl}
	Bits & Flag & Description \\
	\z{0020}& \z{Z} & Last \z{NEXT*}/\z{MUL}/\z{ADD}/\z{SUB} result was zero \\
	\z{0010}& \z{V} & Last \z{NEXT*}/\z{MUL}/\z{ADD}/\z{SUB} result overflowed byte \\
	\z{0008}& \z{A} & Sensor A input is true (low) \\
	\z{0004}& \z{B} & Sensor B input is true (low)\\
	\z{0002}& \z{C} & Sensor C input is true (low)\\
	\z{0001}& \z{D} & Sensor D input is true (low)\\
    \end{tabular}
  \end{center}
  \caption{Conditional Jump Condition Code Bits\label{tbl:condcodes}}
\end{table}

\section{Loading Binary Sequences Onto Lumos Boards}
The binary sequences are stored in the Intel Hex Format, where memory addresses
are effectively assumed to be 24 bits long, with the upper eight bits representing
the sequence number and the lower 16 bits forming the address within that sequence,
allowing for 65,536 bytes per sequence, which is far more than the current Lumos
boards can actually accommodate.

Each sequence begins with a line of the form:
\begin{Coding}
|:0200000400|\Var{ss}\Var{kk}
\end{Coding}
where \Var{ss} is the two-hex-digit sequence number and \Var{kk} is the checksum obtained
by adding all the bytes together and taking the 8-bit two's compliment of that sum.

Each line after that provides a number of data bytes in the sequence, and is of the form:
\begin{Coding}
|:|\Var{nn}\Var{aaaa}|00|\Var*{\Var{n} data bytes (2\Var{n} hex digits)\dots}\Var{kk}
\end{Coding}
where:
\begin{itemize}
	\item[\Var{n}] is the number of data bytes on this line.  This is typically 16 or 32
	but may be any number from 0--255.
	\item[\Var{a}] is the address within the sequence where these data bytes reside.
	\item[\Var*{data}] bytes are the instruction data being recorded at this address.
	\item[\Var{k}] is the two-hex-digit checksum calculated as described above.
\end{itemize}

Finally, the last line of the hex file is always:
\begin{Coding}
|:00000001FF|
\end{Coding}

For example, the sequence pair 
shown on page~\pageref{src:2seq} would be encoded
in the hex file as follows:
\begin{SourceCode}
:020000040001F9
:100000004F0A2A4A144F01EF6F480502AF097503E2
:0A0010000AAF530AB04B0204FF00D0
:020000040005F5
:1000000040024F42AFCF0102CF0153140F810100D4
:00000001FF
\end{SourceCode}

To assemble the sequence mnemonics into binary format, use the \z{lumosasm} \acronym{CLI}
command (documented fully on page~\pageref{man:lumosasm}):
\begin{SourceCode}
$ lumosasm --output=sequences.hex sequences.lasm
Lumos Sequence Assembler version 1.0
SEQUENCES: 002
ERRORS:    000
\end{SourceCode}
This binary file may then be downloaded into the Lumos controller using the \z{lumosctl}
command:
\begin{SourceCode}
$ lumosctl --port=COM1 --speed=19200 --address=2 \
    --load-hex-sequences=sequences.hex
\end{SourceCode}
%% XXX } % end of grayed-out text
\end{NotImplemented*}
% 
%  ____  ____   ___ _____ ___   ____ ___  _     
% |  _ \|  _ \ / _ \_   _/ _ \ / ___/ _ \| |    
% | |_) | |_) | | | || || | | | |  | | | | |    
% |  __/|  _ <| |_| || || |_| | |__| |_| | |___ 
% |_|   |_| \_\\___/ |_| \___/ \____\___/|_____|
%                                               
\chapter{Communication Protocol Details}\label{ch:proto}
\LLstart{T}{he}{protocol used by Lumos boards} to receive commands is designed to be compact (so as to 
conserve the number of bytes transmitted to carry out common functions) while remaining 
simple and fast for the controller to interpret.  It is also designed so that multiple devices can
\index{command protocol|(}
share the same \acronym{RS-485} network connection.  As long as they all implement this basic protocol, they can
safely avoid misinterpreting each other's commands even if they do not know the details of each other's
command structure.  This includes, for example, Lumos boards at different revision levels.  (There are
also more devices designed by the author which have very different command sets but use a compatible
protocol so they may peacefully coexist with Lumos controllers on the same network.)

The original Lumos protocol is now designated as ``protocol 0'' and an explicit version number is assigned
to each new version of the protocol if there is a breaking change introduced by that version.

The current protocol version as of this writing is {\bfseries protocol 1}.

The protocol is essentially a stream of 8-bit bytes transmitted over an asynchronous communication link
such as \acronym{RS-232} or \acronym{RS-485}.  Commands may consist of as little as a single byte, or could be an arbitrarily
large number of bytes long.  

The first byte of a command always has this format:  
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{\Var*{cmd}} & \bitbox{4}{\Var*{addr}}
\end{BF}
The most significant bit is always set.  The next significant three bits, \Var*{cmd}, specify the
command being given to the device.  The least significant four bits, \Var*{addr}, specify the
address of the device which should act on this command.

Any following data bytes in a multi-byte command always have their most significant bit clear:
\begin{BF}
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{data}}
\end{BF}

\index{8-bit data, escaping}
This suggests the following algorithm for devices listening to the data stream, upon the receipt
of each byte:

\begin{enumerate}
	\item	If bit 7 is set:
		\begin{enumerate}
			\item	If I was in the middle of collecting data bytes for a command,
				clearly the host has abandoned it and is beginning a new command, 
				so I should abandon it too and return to normal passive scanning mode.
			\item	If \Var*{addr} matches my address, interpret command code \Var*{cmd}
				and act upon it.
			\item	Otherwise, ignore this byte.
		\end{enumerate}
	\item	Otherwise:
		\begin{enumerate}
			\item	If I was in the middle of collecting data bytes, collect this one too.
				Act on the command when the last expected byte is received.
			\item	Otherwise, ignore this byte.
		\end{enumerate}
\end{enumerate}

If more than eight commands are needed, we reserve command 7 as an extended command, where the bits
in the following byte are used:
\begin{BF}
	\bitbox{1}{\z1} & \bitbox[t]{1}{\z1} & \bitbox[t]{1}{\z1} & \bitbox[t]{1}{\z1} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{cmd}}
\end{BF}
%This is, in fact, done in the case of the Lumos protocol.  The most common commands are assigned codes
%0--6, allowing them to be sent in 1--4 bytes.  Other commands are given extended codes.

Note that where a value for \Var*{channel} is given in the commands that follow, the protocol's bitfield
may allow for a greater number of channels than the Lumos board actually has.  For example, typically six bits
are allocated for channel numbers, giving a range of values of 0--63, but Lumos boards are usually built
to have 24 or 48 channels.  If a command specifies a \Var*{channel} value the board does not support,
it will flag the command as an error and ignore it.

\label{escapebytes}If 
a binary value greater than 127 needs to be sent as part of a command packet, 
the following escape mechanism is used.  Two byte values are special:
\begin{description}
  \item[\z{0x7E}] The following byte will have its \acronym{MSB} set upon receipt.
  \item[\z{0x7F}] The following byte will be accepted as-is without further interpretation.  This
	means a literal \z{0x7E} byte needs to be sent as \z{0x7F} \z{0x7E}, and a literal
	\z{0x7F} byte as \z{0x7F} \z{0x7F}.
\end{description}
See the examples in Figure~\ref{tbl:escapes}.
\begin{figure}
 \begin{center}
  \begin{tabular}{|l|l|}\hline
	\bfseries Intended Value & \bfseries Transmitted Byte(s)\\\hline\hline
	\z{0x42} & \z{0x42} \\\hline
	\z{0x7D} & \z{0x7D} \\\hline
	\z{0x7E} & \z{0x7F 0x7E} \\\hline
	\z{0x7F} & \z{0x7F 0x7F} \\\hline
	\z{0x80} & \z{0x7E 0x00} \\\hline
	\z{0x81} & \z{0x7E 0x01} \\\hline
	\z{0xFD} & \z{0x7E 0x7D} \\\hline
	\z{0xFE} & \z{0x7E 0x7E} \\\hline
	\z{0xFF} & \z{0x7E 0x7F} \\\hline
  \end{tabular}
  \caption{Examples of Escaped 8-bit Data Values\label{tbl:escapes}}
 \end{center}
\end{figure}

In the command descriptions that follow, we will show the bytes sent or received typographically, using the
following notation:
\begin{itemize}
	\item Binary bits are shown in fixed-width type: \z0, \z1.
	\item Decimal numbers are shown in normal type: 123.
	\item Hexadecimal numbers are shown in fixed-width type with a leading \z{0x}: \z{0x42}.
	\item Single-bit flags are shown in Italics as single-letter names: \Var{f}.
	\item Multi-bit fields are shown in Italics with angle brackets: \Var*{speed}.
\end{itemize}

\section{\z{0x0}--\z{0x6}: Common Commands}
With the command code embedded in the packet's initial byte, these commands represent the most commonly
used features of the Lumos boards, thereby using the minimum number of bytes to transmit over the
wire, possibly even a single byte for the entire command.

\begin{QS*}
	For the QS* units, output dimming is not supported, so setting a channel level of 0--127 is equivalent
	to turning that channel off, and a level of 128--255 is equivalent to turning it on.
\end{QS*}

\subsection{\z{0x0}: Blackout}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{0} & \bitbox{4}{\Var*{addr}}
\end{BF}
Immediately turns all output channels completely off.

\subsection{\z{0x1}: Channel On/Off}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{1} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & \bitbox{6}{\Var*{channel}}
\end{BF}
Turns output \Var*{channel} fully on (\Var{s}=1) or off (\Var{s}=0).  %Although \Var*{channel}
%may have a value in the range 0--63, if the Lumos board does not implement that many channels,
%it will flag the command as an error and ignore it.

\subsection{\z{0x2}: Set Channel Output Level}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{2} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{1}{\Var{h}} & \bitbox{6}{\Var*{channel}}\\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{level}}
\end{BF}
Sets the output level of the designated \Var*{channel} to a level in the range 0--255.  The controller
will simply switch the output to a steady off or on state if the level is 0 or 255, respectively.  Otherwise,
it will use pulse width modification to send a square wave pulse that will be on a fraction of the time
approximately equivalent to the value on a 0--255 scale.  See Chapter~\ref{ch:too} for more information
about how this pulsing works and how it affects the apparent brightness of lights controlled by that channel.

Note that the value of the output level is encoded as the combination of the \Var*{level} field and the \Var{h}
bit, with \Var{h} forming the \emph{least significant} bit of the resulting value:
\begin{BF}
  \bitbox{7}{\Var*{level}} & \bitbox{1}{\Var{h}}
\end{BF}

This means is that for the sake of simplicity, you may choose to ignore the \Var{h} bit,\footnote{For best
results, if you choose to do this, set \Var{h}=0 unless setting the channel at maximum brightness, in which case
 set \Var{h}=1.} and just use a 0--127
value for \Var*{level}, and it will work (although the steps between each level will be twice as large).

(This command was added to the protocol set before the data escaping rules were added,
which is why it is structured as it is. This may change in the future.)

\newcommand\xbit{\color{lightgray}\rule{\width}{\height}}
\subsection{\z{0x3}: Bulk Channel Update}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{3} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{1}{\xbit} & \bitbox{6}{\Var*{channel}}\\
  \wordbox{1}{\Var*{N}$-$1}\\
  \begin{rightwordgroup}{\Var*{N} bytes}
	\wordbox[ltr]{1}{\Var*{levels}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}



  %\wordbox{1}{\Var*{level$_c$}}\\
  %\wordbox[]{1}{$\vdots$ \\[1ex]} \\
  %\wordbox{1}{\Var*{level$_{c+\hbox{\tiny\Var*{N}}-1}$}}
  \end{rightwordgroup}\\
  \bitbox{1}{\z0} 
	& \bitbox[tb]{1}{\z1}
	& \bitbox[tb]{1}{\z0}
	& \bitbox[tb]{1}{\z1}
	& \bitbox[tb]{1}{\z0}
	& \bitbox[tb]{1}{\z1}
	& \bitbox[tb]{1}{\z0}
	& \bitbox[tbr]{1}{\z1}
\end{BF}
If more than a small number of channel levels are being updated at once,
it is more economical to send a single bulk update command with all their
new values in one payload, rather than initiate individual commands for them.

This updates \Var*{N} channels starting with \Var*{channel} and continuing to
\Var*{channel}$+$\Var*{N}$-$1.  Note that the value \Var*{N}$-$1 is passed, not \Var*{N}.
This allows for any number of channels from 1--256 to be updated (in theory; %although
no Lumos controller currently implements that many channels).

Note that it may be necessary to escape some of these data bytes so their 8-bit values
conform to the overall communications protocol as described at the beginning of
this chapter (see p.~\pageref{escapebytes} for details about this escape mechanism).

%% XXX DEPRECATED XXX  \subsection{\z{0x3}: Bulk Channel Update---deprecated version}
%% XXX DEPRECATED XXX  \strong{The following is obsolete and no longer supported:}
%% XXX DEPRECATED XXX  {\color{gray}
%% XXX DEPRECATED XXX  \begin{BF}
%% XXX DEPRECATED XXX    \bitbox{1}{\z1} & \bitbox{3}{3} & \bitbox{4}{\Var*{addr}}\\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} & \bitbox{1}{\Var{m}} & \bitbox{6}{\Var*{channel}}\\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} & \bitbox{7}{\Var*{N}$-$1}\\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} & \bitbox{7}{\Var*{level$_0$}}\\
%% XXX DEPRECATED XXX    \wordbox[]{1}{$\vdots$ \\[1ex]} \\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} & \bitbox{7}{\Var*{level$_{N-1}$}}\\
%% XXX DEPRECATED XXX    \begin{rightwordgroup}{if \Var{m}=1}
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} 
%% XXX DEPRECATED XXX  	& \bitbox[]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[]{1}{\z0}
%% XXX DEPRECATED XXX  	& \bitbox[]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[]{1}{\z0}
%% XXX DEPRECATED XXX  	& \bitbox[]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[r]{1}{\z0}\\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} 
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_0$}
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_1$}
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_2$}
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_3$}
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_4$}
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_5$}
%% XXX DEPRECATED XXX  	& \bitbox{1}{$h_6$}\\
%% XXX DEPRECATED XXX    \wordbox[]{1}{$\vdots$ \\[1ex]} \\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} 
%% XXX DEPRECATED XXX  	& \bitbox[t]{4}{$\cdots$}
%% XXX DEPRECATED XXX  	& \bitbox[tr]{3}{$h_{N-1}$}
%% XXX DEPRECATED XXX  	\end{rightwordgroup}\\
%% XXX DEPRECATED XXX    \bitbox{1}{\z0} 
%% XXX DEPRECATED XXX  	& \bitbox[tb]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[tb]{1}{\z0}
%% XXX DEPRECATED XXX  	& \bitbox[tb]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[tb]{1}{\z0}
%% XXX DEPRECATED XXX  	& \bitbox[tb]{1}{\z1}
%% XXX DEPRECATED XXX  	& \bitbox[tb]{1}{\z0}
%% XXX DEPRECATED XXX  	& \bitbox[tbr]{1}{\z1}
%% XXX DEPRECATED XXX  \end{BF}
%% XXX DEPRECATED XXX  If more than a small number of channel levels are being updated at once,
%% XXX DEPRECATED XXX  it is more economical to send a single bulk update command with all their
%% XXX DEPRECATED XXX  new values in one payload, rather than initiate individual commands for them.
%% XXX DEPRECATED XXX  
%% XXX DEPRECATED XXX  This updates \Var*{N} channels starting with \Var*{channel} and continuing to
%% XXX DEPRECATED XXX  \Var*{channel}$+$\Var*{N}$-$1.  Note that the value \Var*{N}$-$1 is passed, not \Var*{N}.
%% XXX DEPRECATED XXX  This allows for any number of channels from 1--128 to be updated.
%% XXX DEPRECATED XXX  
%% XXX DEPRECATED XXX  As with the ``Set Output Channel Level'' command above, the 8-bit level value for
%% XXX DEPRECATED XXX  the $i$th channel in the list is the combination of the \Var*{level$_i$} field and the $h_i$ bit:
%% XXX DEPRECATED XXX  \begin{BF}
%% XXX DEPRECATED XXX    \bitbox{7}{\Var*{level$_i$}} & \bitbox{1}{\Var{h$_i$}}
%% XXX DEPRECATED XXX  \end{BF}
%% XXX DEPRECATED XXX  
%% XXX DEPRECATED XXX  This command has two modes of operation as selected by the \Var{m} bit.  In low-resolution
%% XXX DEPRECATED XXX  mode (\Var{m}=0), all the \Var{h} bits are omitted, and the level range is effectively
%% XXX DEPRECATED XXX  0--127, with 0 being fully off and 127 being fully on.\footnote{The Lumos device intelligently
%% XXX DEPRECATED XXX  handles these edge conditions rather than simply assuming the least significant bit is always 
%% XXX DEPRECATED XXX  set or clear.}  In high-resolution mode (\Var{m}=1), then all bits are specified and the full
%% XXX DEPRECATED XXX  range of values (0--255) is supported.
%% XXX DEPRECATED XXX }
\subsection{\z{0x4}: Ramp Channel Level}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{4} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\Var{c}} & \bitbox{1}{\Var{d}} & \bitbox{6}{\Var*{channel}}\\
  \wordbox{1}{\Var*{steps}$-1$}\\
  \wordbox{1}{\Var*{time}$-1$}
\end{BF}
Smoothly increases (\Var{d}=1) the brightness of \Var*{channel} from its current value until it reaches the
maximum level, or decreases (\Var{d}=0) it until it is fully off,
changing it in increments of \Var*{steps} each time, with a delay of \Var*{time}/120
seconds between each change.  Since the values passed are actually \Var*{steps}$-$1 and \Var*{time}$-$1,
the effective ranges for each of those values is 1--256.

Once the level has reached the full extent of its range, it remains there.  However, 
if the flag \Var{c}=1, the channel will immediately ramp back the other direction, ramping
continuously up and down until another command changes the channel's state.

Note that it may be necessary to escape some of these data bytes so their 8-bit values
conform to the overall communications protocol as described at the beginning of
this chapter (see p.~\pageref{escapebytes} for details about this escape mechanism).

\begin{QS*}
	For devices which don't support dimming (e.g. the QS* units), this can be used to
	make an output flash at a specified rate. Since there is no ability to ramp the level,
	these devices simply go to full on or off state immediately. However, if the \Var*{c} flag
	is set, the channel will cycle between on and off states every \Var*{time} intervals,
	which are device specific but should be approximately 1/120~s. (The \mc{QSMC}, for example,
	interprets \Var*{time} in units of 8~ms, which is slightly shorter than 1/120~s. This gives
	them a flash rate of a state change of 125 per second to one state change per 2.048 seconds,
	or 62.5~Hz to 0.24~Hz.)
\end{QS*}

\begin{QS}
\subsection{\z{0x5}: Update Scoreboard Display}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{\Var*{op}} & \bitbox{2}{\Var*{c}} & \bitbox{2}{\Var*{m}}\\
	\wordbox[ltr]{1}{\Var*{data}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{terminator}}
\end{BF}
This command updates the quiz show unit's scoreboard display according to the
	operation code \Var*{op}, as described below. In each case, \Var*{c}
	indicates how color information will be sent in the \Var*{data} block,
	and \Var*{m} contains operation-specific mode flag bits.
	Table~\ref{tbl:scoreclr} lists the possible color modes for the \Var*{c}
	field.
	Table~\ref{tbl:scoreterm} lists the expected values for \Var*{terminator}
	for each operation.

\begin{table}
	\begin{QS*}
	\begin{center}
	\begin{tabular}{crrl}\toprule
		\Var*{c} & Color Depth & Bytes & Encoding \\\midrule
		\z{00}   & none        &     0 & none \\
		\z{01}   & 3 bits      &     1 & \z{00000}\Var{r}\Var{g}\Var{b} \\
		\z{10}   & 9 bits      &     2 & \z{0}\Var{rrr}\z{0}\Var{ggg} \z{00000}\Var{bbb} \\
		\z{11}   & 12 bits     &     2 & \Var{rrrr}\Var{gggg} \z{0000}\Var{bbbb} \\\bottomrule
	\end{tabular}
	\end{center}
	\caption{Color Encoding Values\label{tbl:scoreclr}}
	\end{QS*}
\end{table}

\begin{table}
	\begin{QS*}
	\begin{center}
	\begin{tabular}{cl}\toprule
		\Var*{op} & \Var*{terminator} \\\midrule
		\z{000}   & \z{01000100} (if no color given)\\
		\z{000}   & \z{00110011} (if color given)\\
		\z{001}   & \z{00101110} \\
		\z{010}   & \z{01110001} \\
		\z{011}   & \z{01110001} \\
		\z{100}   & \z{01110001} \\
		\z{101}   & \z{01110001} \\
		\z{110}   & \z{00011100} \\
		\z{111}   & \z{01101010} (for segmented \acronym{LED} updates) \\
		\z{111}   & \z{00001011} (for scoreboard updates) \\
		\bottomrule
	\end{tabular}
	\end{center}
	\caption{Command Terminator Bytes by Operation (Scoreboard Updates) \label{tbl:scoreterm}}
	\end{QS*}
\end{table}

\newpage
\begin{description}
	\item[op=0: Clear] Clear the entire screen. 
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{0} & \bitbox{2}{0} & \bitbox{2}{0}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		If no color is specified (\Var*{c}=0)
		the screen is cleared to black. 
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{0} & \bitbox{2}{\Var*{c}} & 
		\bitbox{2}{\color{lightgray}\rule{\width}{\height}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		Otherwise \Var*{data} contains a single
		color value for the screen to be painted with.
	\newpage
	\item[op=1: Bitmap] % x y w h color data	(no color means monochrome)
			    % m=1x full color 01 bgcolor 00 mono
		Draws a bitmapped image on the display. In all modes, the first
		four bytes of \Var*{data} provide the \Var*{x} and \Var*{y} coordinates,
		\Var*{width} and \Var*{height} in pixels, respectively.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{1} & \bitbox{2}{\Var*{c}} & \bitbox{2}{0}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{width}}\\
	\wordbox{1}{\Var*{height}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\begin{rightwordgroup}{8 pixels/byte}
	\wordbox[ltr]{1}{\Var*{bitmap}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
\newpage
		If \Var*{m}=0, the next data byte specifies a color with which to
		draw the entire monochrome bitmap whose bits are given in the rest
		of the \Var*{data} block.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{1} & \bitbox{2}{\Var*{c}} & \bitbox{2}{1}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{width}}\\
	\wordbox{1}{\Var*{height}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\wordbox[ltr]{1}{\Var*{bgcolor}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\begin{rightwordgroup}{8 pixels/byte}
	\wordbox[ltr]{1}{\Var*{bitmap}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
\newpage
		If \Var*{m}=1, two color values are given followed by a monochrome
		bitmap. The first color is used to draw the bitmap, while the second
		is the background color to be used.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{1} & \bitbox{2}{\Var*{c}} & \bitbox{2}{2}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{width}}\\
	\wordbox{1}{\Var*{height}}\\
	\begin{rightwordgroup}{1--2 bytes/pixel}
	\wordbox[ltr]{1}{\Var*{bitmap}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		If \Var*{m}=2, each value after the above-mentioned initial four
		are full color specifications for each pixel of the color image.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{1} & \bitbox{2}{\Var*{c}} & \bitbox{2}{3}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{width}}\\
	\wordbox{1}{\Var*{height}}\\
	\begin{rightwordgroup}{1--2 bytes/pixel}
	\wordbox[ltr]{1}{\Var*{bitmap}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}
	\end{rightwordgroup}\\
	\begin{rightwordgroup}{8 pixels/byte}
	\wordbox[ltr]{1}{\Var*{bitmap}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		If \Var*{m}=3, a color bitmap is given as with \Var*{m}=2, but the
		color bitmap data are followed by a monochrome bitmap which gives the
		image mask to apply while drawing.
	\item[op=2: Pixel/Line] % x1 y1 x2 y2 color
				% m=0 pixel at x1,y1 else line
	Draw a line or a single pixel on the matrix display.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{2} & \bitbox{2}{\Var*{c}} & \bitbox{2}{0}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		If \Var*{m}=0, \Var*{data} contains, respectively, \Var{x} and \Var{y}
		coordinates and a \Var{color} value. A single pixel will be drawn.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{2} & \bitbox{2}{\Var*{c}} & \bitbox{2}{1}\\
	\wordbox{1}{\Var*{x$_0$}}\\
	\wordbox{1}{\Var*{y$_0$}}\\
	\wordbox{1}{\Var*{x$_1$}}\\
	\wordbox{1}{\Var*{y$_1$}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		Otherwise, \Var*{data} contains coordinates \Var{x$_0$}, \Var{y$_0$},
		\Var{x$_1$}, \Var{y$_1$}, and a \Var{color}. A line is drawn between
		the given points.
	\item[op=3: Rectangle]  % x y w h [r] color
				% m=x1 filled 1x rounded
		Draws a rectangle. The first four bytes of \Var*{data} provide the
		\Var{x} and \Var{y} coordinates, \Var{width} and \Var{height} in
		pixels.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{3} & \bitbox{2}{\Var*{c}} & \bitbox{1}{\z0} & \bitbox{1}{\Var{f}}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{w}}\\
	\wordbox{1}{\Var*{h}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z1} \\
\end{BF}

		If \Var*{f}=0, a rectangle will be drawn, outlined in \Var*{color}.
		If \Var*{f}=1, the rectangle will be completely filled in.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{3} & \bitbox{2}{\Var*{c}} & \bitbox{1}{\z{1}} & \bitbox{1}{\Var{f}}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{w}}\\
	\wordbox{1}{\Var*{h}}\\
	\wordbox{1}{\Var*{radius}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		In this variant, \Var*{data} includes a \Var{radius} byte followed
		by a \Var{color} code. A rectangle will be drawn with rounded
		corners, outlined or filled in the color.
		\newpage
	\item[op=4: Circle]	% x y r color
				% m=x1 filled
		Draws a circle on the matrix display.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{4} & \bitbox{2}{\Var*{c}} & \bitbox{1}{\z0} & \bitbox{1}{\Var{f}}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{radius}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		The \Var*{data} block provides \Var*{x} and \Var*{y} coordinates
		of the center point, the \Var*{radius}, and a \Var*{color} code.
		A circle with those parameters is drawn, outlined if \Var*{f}=0
		or filled in if \Var*{f}=1.
	\item[op=5: Triangle]	% x1 y1 x2 y2 x3 y3 color
				% m=x1 filled
		Draws triangles on the matrix display.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{5} & \bitbox{2}{\Var*{c}} & \bitbox{1}{\z0} & \bitbox{1}{\Var{f}}\\
	\wordbox{1}{\Var*{x$_0$}}\\
	\wordbox{1}{\Var*{y$_0$}}\\
	\wordbox{1}{\Var*{x$_1$}}\\
	\wordbox{1}{\Var*{y$_1$}}\\
	\wordbox{1}{\Var*{x$_2$}}\\
	\wordbox{1}{\Var*{y$_2$}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		The \Var*{data} includes coordinates 
		\Var*{x$_0$}, \Var*{y$_0$},
		\Var*{x$_1$}, \Var*{y$_1$}, and
		\Var*{x$_2$}, \Var*{y$_2$},
		follwed by a \Var*{color} code. A triangle is drawn between these
		three points, filled in if \Var*{f}=1.
		\newpage
	\item[op=6: Inhibit/Enable Updates]
		Controls whether drawing commands immediately change the matrix
		display.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{6} & \bitbox{2}{0} & \bitbox{1}{\z{0}}
		& \bitbox{1}{\Var{e}}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		If \Var*{e}=0, stops updating the display for graphics drawing commands.
		The drawing commands are noted internally but won't be sent to
		the scoreboard itself until updates are enabled again.
		
		If \Var*{e}=1, updates the display to reflect the internal state
		tracked by the device. All subsequent graphic updates will change
		the display in real time.
	\item[op=7: Alphanumeric Display]
		This operation writes text data to the score display.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{7} & 
		\bitbox{2}{\Var*{c}} &
		\bitbox{1}{\color{lightgray}\rule{\width}{\height}} &
		\bitbox{1}{\z{0}}\\
	\wordbox{1}{\Var*{x}}\\
	\wordbox{1}{\Var*{y}}\\
	\wordbox{1}{\Var*{style}}\\
	\wordbox[ltr]{1}{\Var*{color}}\\
	\wordbox[lbr]{1}{(1 or 2 bytes)}\\
	\wordbox{1}{\Var*{n}}\\
	\begin{rightwordgroup}{\Var*{n} bytes}
	\wordbox[ltr]{1}{\Var*{text}}\\
	\skippedwords\\
	\wordbox[lbr]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z1} \\
\end{BF}
		In this case, \Var*{data} provides the \Var*{x} and \Var*{y}
		coordinates, font style \Var*{style}, a \Var*{color} code, and
		a string length \Var{n}. Following this are \Var{n} bytes
		containing the characters to be written.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{7} & 
%		\bitbox{1}{\color{lightgray}\rule{\width}{\height}} &
		\bitbox{1}{\Var{s}} &
		\bitbox{2}{0} &
		\bitbox{1}{\z{1}}\\
	\bitbox{1}{\strut\Var{p}} & \bitbox{7}{\Var*{n}}\\
	\begin{rightwordgroup}{\Var*{n} bytes}
	\wordbox[ltr]{1}{\Var*{text}}\\
	\skippedwords\\
	\wordbox[lbr]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		This and the following forms all
		write to the alphanumeric \acronym{LED} character display
		in one of several ways.
		Here, \Var*{data} holds a length byte \Var{n} followed
		by \Var{n} bytes of character data. These are displayed as \acronym{ASCII}
		bytes on the alphanumeric digits. The entire display is overwritten
		with the specified \Var*{text}.

		If \Var{s}=1, the text will appear on the display and then scroll to the left,
		allowing for messages which are longer than the number of physical characters
		on the display to be shown.  You may want to prepend spaces to the string
		to initially blank the display and scroll the entire message on from the right, or
		set \Var{p}=1, which will automatically pad the message with enough blanks to ensure
		the message starts off-display before scrolling across.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{7} & 
		\bitbox{1}{\color{lightgray}\rule{\width}{\height}} &
		\bitbox{2}{1} &
		\bitbox{1}{\z{1}}\\
	\wordbox{1}{\Var*{d}}\\
	\wordbox{1}{\Var*{char}}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		In this variant, \Var*{data} holds two bytes: \Var*{d} which gives
		the digit to be modified, and the \acronym{ASCII} character to written to
		that digit.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{7} & 
%		\bitbox{1}{\color{lightgray}\rule{\width}{\height}} &
		\bitbox{1}{\Var{s}} &
		\bitbox{2}{2} &
		\bitbox{1}{\z{1}}\\
	\bitbox{1}{\strut\Var{p}} & \bitbox{7}{\strut\Var*{n}}\\
	\begin{rightwordgroup}{2$\times$\Var*{n} bytes}
	\wordbox[ltr]{1}{\Var*{bitmaps}}\\
	\skippedwords\\
	\wordbox[lbr]{1}{}
	\end{rightwordgroup}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		In this version, \Var*{data} holds a length byte \Var{n} followed
		by 2\Var{n} bytes of character data. The character data words
		are bitmapped to the \acronym{LED} digit segments, allowing completely 
		arbitrary symbols on the displays. The entire display is overwritten
		by the given \Var*{text}.

		If \Var{s}=1, the text will appear on the display and then scroll to the left,
		allowing for messages which are longer than the number of physical characters
		on the display to be shown.  You may want to prepend spaces to the string
		to initially blank the display and scroll the entire message on from the right.
		Setting \Var{p}=1 arranges sufficient padding to do this for you automatically.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{3}{7} & 
		\bitbox{1}{\color{lightgray}\rule{\width}{\height}} &
		\bitbox{2}{3} &
		\bitbox{1}{\z{1}}\\
	\wordbox{1}{\Var*{d}}\\
	\wordbox[ltr]{1}{\Var*{bitmap}}\\
	\wordbox[lbr]{1}{(2 bytes)}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
		This one allows a single character to be updated using a raw segment
		bitmap.
				% m=x0 write string to matrix
				%	x y s color n text[n]
				% m=z1 c=xy alphanumeric leds (submode yz)
\end{description}
\subsubsection{Character Sets}
The \acronym{ASCII} characters sent to the matrix displays contain all the usual
characters one would expect within the traditional 7-bit printable character range.
% XXX in addition...

Table~\ref{tbl:ledchars} lists the special characters available for the 
segmented \acronym{LED} displays.
\begin{table}
	\begin{QS*}
	\begin{center}
		\begin{tabular}{rl}\toprule
			\bfseries Code & \bfseries Description \\\midrule
			\z{0x80}       & ``Z'' with line through middle (\rlap{Z}\raisebox{0.75pt}{--})\\
			\z{0x81}       & Digit ``1'' without serif\\
			\z{0x82}       & Digit ``7'' with diagonal downstroke (instead of straight)\\
			\z{0x83}       & Digit ``7'' with line through (\rlap7\raisebox{0.75pt}{--})\\
			\z{0x84}       & Digit ``9'' with tail\\
			\z{0x85}       & Hourglass ($\hourglass$)\\
			\z{0x86}       & Degree sign ($^\circ$)\\
			\z{0x87}       & X in box ($\boxtimes$)\\
			\z{0x88}       & Plus-minus ($\pm$)\\
			\z{0x89}       & Minus-plus ($\mp$)\\
			\z{0x8A}       & Clock\\
			\z{0x8B}       & All segments on (``splat'')\\
			\z{0x8C}       & Upper splat\\
			\z{0x8D}       & Lower splat\\
			\z{0x8E}       & Left splat \\
			\z{0x8F}       & Right splat\\
			\z{0x90}       & Up-pointing triangle ($\bigtriangleup$)\\
			\z{0x91}       & Down-pointing triangle ($\bigtriangledown$)\\
			\z{0x92}       & Left-pointing triangle ($\triangleleft$)\\
			\z{0x93}       & Right-pointing triangle ($\triangleright$)\\
			\z{0x94}       & Up arrow ($\uparrow$)\\
			\z{0x95}       & Down arrow ($\downarrow$)\\
			\z{0x96}       & Right arrow ($\rightarrow$)\\
			\z{0x97}       & Left arrow ($\leftarrow$)\\
			\z{0x98}       & NE arrow ($\nearrow$)\\
			\z{0x99}       & NW arrow ($\nwarrow$)\\
			\z{0x9A}       & SE arrow ($\searrow$)\\
			\z{0x9B}       & SW arrow ($\swarrow$)\\
			\z{0x9C}       & Capital Gamma ($\Gamma$)\\
			\z{0x9D}       & Lowercase mu ($\mu$)\\
			\z{0x9E}       & Captial Xi ($\Xi$)\\
			\z{0x9F}       & Capital Pi ($\Pi$)\\
			\z{0xA0}       & Lowercase pi ($\pi$)\\
			\z{0xA1}       & Capital Sigma ($\Sigma$)\\
			\z{0xA2}       & Capital Phi ($\Phi$)\\
			\z{0xA3}       & Capital Psi ($\Psi$)\\
		\bottomrule
		\end{tabular}
		\caption{Non-standard \acronym{LED} Characters\label{tbl:ledchars}}
	\end{center}
\end{QS*}
\end{table}

% XXX show
\subsubsection{Segmented \acronym{LED} Display Bitmaps}
The raw bitmap data sent to arbitrarily light up \acronym{LED} segments
is a 15-bit value, with the least significant bit mapped to the \Var{a}
segment, followed in order by 
\Var{b},
\Var{c},
\Var{d},
\Var{e},
\Var{f},
\Var{g1},
\Var{g2},
\Var{h},
\Var{j},
\Var{k},
\Var{l},
\Var{m},
\Var{n},
and the decimal point.
\section{\z{0x06}: Button Scanning}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{6} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{1}{\Var{\strut a}} & \bitbox{1}{\Var{\strut i}}
		& \bitbox{1}{\Var{\strut p}} & \bitbox{1}{\Var{\strut s}} 
		& \bitbox{1}{\Var{\strut d}} & \bitbox{1}{\Var{\strut e}}
		& \bitbox{1}{\z0}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{terminator}}
\end{BF}
This command controls the quiz show button scanner. This may take two
different forms.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{6} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{1}{\Var{\strut a}} & \bitbox{1}{\Var{\strut i}}
		& \bitbox{1}{\Var{\strut p}} & \bitbox{2}{\color{lightgray}\rule{\width}{\height}}
		& \bitbox{1}{\z{0}}
		& \bitbox{1}{\z0}\\
	\bitbox{1}{\z0} & 
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
With \Var*{e}=0, this initiates a button scan. The button states are cleared and
the button timer (re-)started. Normally, no reply is given and the results of the 
button scan may be requested when the scan is stopped (see below). However, if
\Var*{i}=1, a reply is sent every time any button is pressed. These replies will be
simple ``ping'' replies if \Var*{p}=1 or full status replies otherwise.
Additionally, if \Var*{a}=1, periodic ``\acronym{NAK}'' replies will be sent while
waiting for more button presses.
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{6} & \bitbox{4}{\Var*{addr}}\\
	\bitbox{1}{\z0} & \bitbox{1}{\z{1}} & \bitbox{1}{\z{1}}
		& \bitbox{1}{\Var{\strut p}} & \bitbox{1}{\Var{\strut s}}
		& \bitbox{1}{\Var{\strut d}} & \bitbox{1}{\z{1}}
		& \bitbox{1}{\z0}\\
	\bitbox{1}{\z0}
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[b]{1}{\z0} &
		\bitbox[b]{1}{\z1} &
		\bitbox[br]{1}{\z0} \\
\end{BF}
With \Var*{e}=1, the button scanner's state is queried, and optionally stopped.
The state reply will either be a simple ``ping'' response if \Var*{p}=1, otherwise
a full status will be sent.

If \Var*{s}=1, the scanner is stopped. Otherwise it will continue running (if it was
running at the time) after
this status query is sent. If \Var*{s}=1 and \Var*{d}=1, the scanner is entirely
disabled. No button scans will be done, and no signals will be sent to poll the button
hardware. Otherwise, if \Var*{s}=1 and \Var*{d}=0, the button scanning function will
continue to poll the buttons, but will do so only in order to lock out buttons pressed
prematurely (i.e., before a scan was initiated). (If \Var*{s}=0, the value of
\Var*{d} is irrelevant.)

% XXX
% 6: button status (QSMC)
%	Ea 0aip0000 00110011
%	clear button status, start new scan
%		i=1 -> send ping (if p=1) or full status with every button event
%		a=1 -> send periodic NAK packets while waiting
%	Ea 011sp010 01000010
%		query button state and stop scan (if s=1), ping if p=1
%
% Fa 03 24 54			query unit
% Fa 04 00 tt 32 5A		set button lockout time to tt
% Fa 05 4u 00abcdlx 66		set mask for unit u; 1=ignore button
% Fa 06 nn iu*n 2C		setup players: 0-(n-1) are valid, player i=unit u
% see protocol doc
\end{QS}


\subsection{Unimplemented Single-byte Codes}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{5} & \bitbox{4}{\Var*{addr}}
\end{BF}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{6} & \bitbox{4}{\Var*{addr}}
\end{BF}
Codes 5 and 6 are not implemented and are reserved for future Lumos features.
\begin{QS*}(Except QS* devices.)\end{QS*}

\section{\z{0x700}--\z{0x71f}: Extended Commands}
Less frequently used commands use an extended code, where the initial byte's command code is
7 (all bits set), and the following byte gives the remaining bits of the command.  The first
32 such codes (extended code values \z{0x00}--\z{0x1f}) are set aside for normal-mode commands.
Additionally, response packets sent back to the host PC from the Lumos boards are formatted the
same as commands, with codes assigned starting at \z{0x71f}, counting down, while the commands
start at \z{0x700}, counting up. There is a currently-unimplemented zone of codes in the middle
which is reserved for future use.

\subsection{\z{0x700}: Sleep}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{7}{0}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[br]{1}{\z0}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[br]{1}{\z0}
\end{BF}
Put the controller into sleep mode.  This signals the controlled load's power supply to shut down
(whether the power supply is equipped or inclined to obey that signal is another matter).  The Lumos
board may automatically---even immediately---wake out of sleep mode if it is asked to supply an output
$>$0 on any of its channels.
\begin{QS*}Not implemented on QS* devices.\end{QS*}

\subsection{\z{0x701}: Wake}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{7}{1}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[br]{1}{\z0}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[br]{1}{\z0}
\end{BF}
Wake up the controller out of sleep mode.  This signals the controlled load's power supply to turn on
(whether the power supply is equipped or inclined to obey that signal is another matter).  The Lumos
board may automatically go into sleep mode again if some period of time elapses during which it had
no output channels with levels $>$0.
\begin{QS*}Not implemented on QS* devices.\end{QS*}

\subsection{\z{0x702}: Shut Down}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{7}{2}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z0}
	&\bitbox[br]{1}{\z0}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z0}
	&\bitbox[br]{1}{\z1}
\end{BF}
Shuts the controller completely down.  After this command executes, the Lumos board will shut down
as many of its functions as possible, reducing its power consumption to the bare minimum.  It will
no longer respond to any commands sent.  The only way out of a shut down is to reset or power cycle
the board.
\begin{QS*}Not implemented on QS* devices.\end{QS*}

\subsection{\z{0x703}: Query}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{7}{3}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[br]{1}{\z0}\\
  \bitbox{1}{\z0} 
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[b]{1}{\z1}
	&\bitbox[b]{1}{\z0}
	&\bitbox[br]{1}{\z0}
\end{BF}
Reports the device status back to the host PC.  On half-duplex networks, the host PC needs to switch
to listening mode immediately after sending this command, although on full duplex networks, this is not
necessary.  The response packet is shown in Figure~\ref{bb:query-reply}.

All devices using the Lumos protocol are expected to implement this command with the output as documented
here; there is a section reserved in the specification for device-specific information which is up to each
device type to define.

\begin{figure}
\begin{BF}
  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
  \bitbox{1}{\z0} & \bitbox{7}{31}\\
  \bitbox{1}{\z0} & \bitbox{3}{\color{red}\Var*{R$_1$}} & \bitbox{4}{\color{red}\Var*{R$_0$}}\\
  \bitbox{1}{\z0} 
	&\bitbox{4}{\Var*{S$_c$}}
	&\bitbox{1}{\Var{d}}
	&\bitbox{2}{\Var*{C$_1$}}\\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{C$_0$}} \\
  \bitbox{1}{\z0} 
	&\bitbox{4}{\Var*{S$_m$}}
	&\bitbox{1}{\Var{q}}
	&\bitbox{1}{\Var{s}}
	&\bitbox{1}{\Var{f}}\\
  \bitbox{1}{\z0} 
	&\bitbox{4}{\Var*{S$_a$}}
	&\bitbox{1}{\Var{X}}
	&\bitbox{2}{\Var{P$_1$}}\\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{P$_0$}} \\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{E$_1$}} \\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{E$_0$}} \\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{M$_1$}} \\
  \bitbox{1}{\z0} & \bitbox{7}{\Var*{M$_0$}} \\
  \bitbox{1}{\z0} 
	&\bitbox{1}{\strut\Var{Q}}
	&\bitbox{1}{\strut\Var{p}}
	&\bitbox{5}{\Var*{model}}\\
%  \bitbox{1}{\z0} & \bitbox{7}{\Var*{exec}} \\
  \bitbox{8}{\textit{reserved}}\\
	\begin{rightwordgroup}{$\times4$ (for sensors A--D)}
%  \bitbox{1}{\z0} 
%	& \bitbox{1}{\Var{o}} 
%	& \bitbox{1}{\Var{w}} 
%	& \bitbox{1}{\Var{e}} 
%	& \bitbox{4}{\Var*{sens}}\\
%  \bitbox{1}{\z0} 
%	& \bitbox{7}{\Var*{pre}}\\
%  \bitbox{1}{\z0} 
%	& \bitbox{7}{\Var*{run}}\\
%  \bitbox{1}{\z0} 
%	& \bitbox{7}{\Var*{post}}\\
   \bitbox{8}{\textit{reserved}}\\
   \bitbox{8}{\textit{reserved}}\\
   \bitbox{8}{\textit{reserved}}\\
   \bitbox{8}{\textit{reserved}}\\
  \wordbox[]{1}{$\vdots$ \\[1ex]} 
  \end{rightwordgroup}\\
	\wordbox{1}{\Var*{fault0}}\\
	\wordbox{1}{\Var*{fault1}}\\
%  \bitbox{1}{\z0} 
%	& \bitbox{7}{\Var*{fault$_1$}}\\
%  \bitbox{1}{\z0} 
%	& \bitbox{7}{\Var*{fault$_0$}}\\
  \bitbox{1}{\z0} 
	& \bitbox{5}{}
	& \bitbox{2}{\Var*{P$'_1$}}\\
  \bitbox{1}{\z0} 
	& \bitbox{7}{\Var*{P$'_0$}}\\
  \bitbox{8}{\Var*{serial$_1$}}\\
  \bitbox{8}{\Var*{serial$_0$}}\\
	\begin{rightwordgroup}{if \Var{p}=1}
\wordbox{1}{\Var*{protocol}}\\
\wordbox{1}{\Var*{major}}\\
\wordbox{1}{\Var*{minor}}\\
\wordbox{1}{\Var*{patch}}\\
\wordbox{1}{\Var*{mslen}}\\
\wordbox[ltr]{1}{model-specific data}\\
\skippedwords\\
\wordbox[lrb]{1}{(\Var*{mslen} bytes)}
	\end{rightwordgroup}\\
  \bitbox{1}{\z0} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[br]{1}{\z1}
\end{BF}
\caption{\z{0x71f} [reply] Query Response from Lumos Controller\label{bb:query-reply}}
\end{figure}

The information contained in this packet describes several facts about the Lumos unit:
\begin{description}
	\item[Version and Protocol Information:]
		{\color{red}For Protocol 0 devices, the \Var*{p} flag is clear (\z0) and the
		firmware version number is contained in fields \Var*{$R_1$} and \Var*{$R_0$},
		with \Var*{$R_1$} giving the major revision number in the range 0--7 and
		\Var*{$R_0$} giving the minor revision number in the range 0--15.}

		All other devices set the \Var*{p} flag (\z1) to indicate that they are sending
		the extended form of response to this command. In this case, fields \Var*{$R_1$} and
		\Var*{$R_0$} should be disregarded. Instead, additional fields appear at the end of
		the response packet:
		\Var*{protocol} specifies the protocol number implemented by the device;
		\Var*{major}, \Var*{minor}, and \Var*{patch} give the full semantic version value
		for the firmware with each component having a range of 0--255; and \Var*{mslen}
		gives the length in bytes of any additional model-specific data which immediately
		follows the \Var*{mslen} field.
		Descriptions of the currently-defined model-specific data appear below.
	\item[Device identity:]
		\Var*{addr} holds the reporting device's current address on the network.
		%the \acronym{ROM} version (major revision \Var*{R$_1$}, minor \Var*{R$_0$});

		The device's serial number is held in the \Var*{serial$_1$} (\acronym{MSB}) and 
		\Var*{serial$_0$} (\acronym{LSB}) fields.
		Serial numbers consisting of all 0 or all 1 bits (i.e., \z{0x0000} or \z{0xFFFF})
		are undefined (meaning that no serial number was assigned to this unit, probably 
		because it was built by a hobbyist for their own use).  Serial numbers $\ge42000$
		are reserved for boards created by the author.  Numbers below 42000 are available
		for others to assign.
		The device model
		code is in the \Var*{model} field.  Table~\ref{tbl:modelnumbers} lists the values that are currently defined
		for \Var*{model}. 
		\begin{table}
		\begin{center}
		 \begin{tabular}{cl}\toprule
		  \bfseries \Var*{model} & \bfseries Device Type \\\midrule
		  0 & 48-channel controller \\
		  1 & 24-channel DC controller \\
		  2 & 4-channel DC controller \\
		  3 & reserved \begin{QS*}QSCC\end{QS*} \\
		  4 & reserved \begin{QS*}QSMC\end{QS*} \\
		  5 & reserved \begin{QS*}QSRB\end{QS*}\\
		  6 & reserved \begin{QS*}QSXT\end{QS*}\\
		  7 & reserved\\
		  8 & reserved\\
		  9 & reserved\\
		  \bottomrule
		 \end{tabular}
		\caption{Defined Device Model Numbers\label{tbl:modelnumbers}}
		\end{center}
		\end{table}
	\item[General Status:]
		The \Var{q} flag indicates if the device is in configuration mode (\Var{q}=1)
		or normal run mode (\Var{q}=0); the \Var{s} flag shows whether it is in sleep
		mode (\Var{s}=1); The \Var{X} flag is true (\Var{X}=1) if configuration mode is
		locked out.  If a sequence is currently running, the \Var{Q} flag will be set and the
		sequence number is in field \Var*{exec}.  The fault code from the last failed command
		is contained in fields \Var*{fault0} for \acronym{CPU0} and \Var*{fault1} for \acronym{CPU1} (on
		multi-\acronym{CPU} devices). %{\color{red}In Protocol~0,
%		this was a 14-bit value in the range 0--16,383:
%		\begin{center}\begin{bytefield}{14}
%			\bitheader{0,6,7,13}\\
%			\bitbox{7}{\Var*{fault$_1$}} & \bitbox{7}{\Var*{fault$_0$}}\\
%		\end{bytefield}\end{center}
%		}
%		However, starting with Protocol~1, this is a full 16-bit value:
%		\begin{center}\begin{bytefield}{16}
%			\bitheader{0,7,8,15}\\
%			\bitbox{8}{\Var*{fault$_1$}} & \bitbox{8}{\Var*{fault$_0$}}\\
%		\end{bytefield}\end{center}

		A value of 0 means there was no fault detected since the last query command (i.e.,
		the fault condition is cleared by the query command). Starting with Protocol~1,
		single-\acronym{CPU} systems place a 16-bit fault code here, with \Var*{fault0}
		as the \acronym{MSB} and \Var*{fault1} as the \acronym{LSB}.
	\item[Sensor information:]
		Three values describe the sensor configuration and state: \Var*{S$_c$} indicates 
		the sensor lines configured as inputs (1) or as \acronym{LED} outputs (0);
		\Var*{S$_m$} shows which sensor inputs are masked out (1) or are being monitored (0);
		and \Var*{S$_a$} indicates which sensors are currently reading a logic 1 or 0.  In each
		case, the sensor lines are represented by these bits in each field:

		\begin{center}\begin{bytefield}{8}
			\bitheader{3,4,5,6}\\
			\bitbox{1}{} 
				& \bitbox{1}{A}
				& \bitbox{1}{B}
				& \bitbox{1}{C}
				& \bitbox{1}{D}
				& \bitbox{3}{}
		\end{bytefield}\end{center}

%		Each sensor's trigger information is given by a block of four bytes.  The first
%		contains the field \Var*{sens} which identifies the sensor (0=A, 1=B, 2=C, 3=D).
%		Flag \Var{o} is set if the trigger is set to fire once only each time the sensor
%		activates, \Var{w} if it's set to run while the sensor is active, and \Var{e}
%		indicates whether the sensor is active high (\Var{e}=1) or active low (\Var{e}=0).
%		The following three bytes, \Var*{pre}, \Var*{run}, and \Var*{post}, specify the
%		sequence number to be executed initially, repeatedly while active, and at the end,
%		respectively.
		At this time, the only sensor information available is \Var*{S$_c$} and \Var*{S$_a$}.
		The others are anticipated for a future release of the \acronym{ROM}.
	\item[\acronym{DMX512} configuration:]
		The bit \Var{d} indicates that the board is in normal Lumos mode (\Var{d}=0) or
		\acronym{DMX512} mode (\Var{d}=1).  If in \acronym{DMX512} mode, its starting
		\acronym*{DMX} channel is \Var*{C}$+$1, which is a value in the range 1--512, sent
		in two fields:

		\begin{center}\begin{bytefield}{9}
			\bitheader{0,6,7,8}\\
			\bitbox{2}{\Var*{C$_1$}} & \bitbox{7}{\Var*{C$_0$}}
		\end{bytefield}\end{center}
	\item[Memory state:]
		The \Var{f} flag is true (\Var{f}=1) if the sequence storage memory overflowed when
		being sent a new program; The number of bytes of \acronym{EEPROM} memory free for
		storage of permanent sequences is given by the \Var*{E} field, while the bytes of
		available \acronym{RAM} memory for temporary storage is in the \Var*{M} field.  Each
		of these values is in the range 0--16,383, sent as two fields:

		\begin{center}\begin{bytefield}{14}
			\bitheader{0,6,7,13}\\
			\bitbox{7}{\Var*{E$_1$}} & \bitbox{7}{\Var*{E$_0$}}\\
			\bitbox{7}{\Var*{M$_1$}} & \bitbox{7}{\Var*{M$_0$}}
		\end{bytefield}\end{center}
	\item[Operating parameters:]
		The internal timing mechanism's phase offset value \Var*{P} is a number in the range
		0--512, given by the combination of two fields.  For 48-channel units, the phase offset
		of the secondary microcontroller is given in \Var*{P$'$}.

		\begin{center}\begin{bytefield}{9}
			\bitheader{0,6,7,8}\\
			\bitbox{2}{\Var*{P$_1$}} & \bitbox{7}{\Var*{P$_0$}}\\
			\bitbox{2}{\Var*{P$'_1$}} & \bitbox{7}{\Var*{P$'_0$}}
		\end{bytefield}\end{center}
\end{description}
\begin{QS*}
	\subsubsection{\acronym{QSMC} Model-Specific Data}
	\begin{BF}
		\wordbox{1}{\Var*{digits}} \\
		\wordbox{1}{\Var*{scrollsz}} \\
		\wordbox{1}{\Var*{scrollfree}} \\
		\bitbox{1}{$\gamma$} &
		\bitbox{1}{\strut\Var{g}} &
		\bitbox{1}{\strut\Var{f}} &
		\bitbox{1}{\strut\Var{e}} &
		\bitbox{1}{\strut\Var{d}} &
		\bitbox{1}{\strut\Var{c}} &
		\bitbox{1}{\strut\Var{b}} &
		\bitbox{1}{\strut\Var{a}} \\
		\bitbox{1}{$\delta$} &
		\bitbox{1}{\strut\Var{n}} &
		\bitbox{1}{\strut\Var{m}} &
		\bitbox{1}{\strut\Var{l}} &
		\bitbox{1}{\strut\Var{k}} &
		\bitbox{1}{\strut\Var{j}} &
		\bitbox{1}{\strut\Var{i}} &
		\bitbox{1}{\strut\Var{h}} \\
		\bitbox{1}{$\epsilon$} &
		\bitbox{1}{\strut\Var{u}} &
		\bitbox{1}{\strut\Var{t}} &
		\bitbox{1}{\strut\Var{s}} &
		\bitbox{1}{\strut\Var{r}} &
		\bitbox{1}{\strut\Var{q}} &
		\bitbox{1}{\strut\Var{p}} &
		\bitbox{1}{\strut\Var{o}} \\
		\bitbox{1}{$\zeta$} &
		\bitbox{1}{$\beta$} &
		\bitbox{1}{$\alpha$} &
		\bitbox{1}{\strut\Var{z}} &
		\bitbox{1}{\strut\Var{y}} &
		\bitbox{1}{\strut\Var{x}} &
		\bitbox{1}{\strut\Var{w}} &
		\bitbox{1}{\strut\Var{v}} \\
		\wordbox[lrt]{1}{Lockout} \\
		\wordbox[lr]{1}{time (\SI{}{\micro\second})} \\
		\wordbox[lr]{1}{MSB first} \\
		\wordbox[lrb]{1}{(4 bytes)} \\
		\wordbox{1}{\Var*{nplayers}} \\
		\begin{rightwordgroup}{For each player}
		\bitbox{1}{\z0} &
		\bitbox{1}{\z0} &
		\bitbox{1}{\strut\Var{d}} &
		\bitbox{1}{\strut\Var{c}} &
		\bitbox{1}{\strut\Var{b}} &
		\bitbox{1}{\strut\Var{a}} &
		\bitbox{1}{\strut\Var{l}} &
		\bitbox{1}{\strut\Var{x}} \\
		\bitbox{1}{\z0} &
		\bitbox{1}{\color{lightgray}\rule{\width}{\height}}&
			\bitbox{1}{\strut\Var{m}} &
			\bitbox{1}{\strut\Var{e}} &
			\bitbox{4}{\Var*{paddr}} \\
			\wordbox[]{1}{$\vdots$}
		\end{rightwordgroup}\\
	\end{BF}
	The \Var*{digits} field specifies the number of alphanumeric \acronym{LED} characters physically
	present in this device. Which ones are currently reserved for host use are indicated in the 
	following bytes, where \Var{a}--\Var{z} and $\alpha$--$\zeta$ represent the individual digit
	positions. The number of characters which may be buffered at once for scrolling across the
	display is given by \Var*{scrollsz}, with the number of empty positions still available
	in that buffer in \Var*{scrollfree}.
	
	The configured lockout time is given (0 if disabled), followed by \Var*{nplayers} which is the number
	of player positions supported by the hardware. Then there are \Var*{nplayers} sets of two bytes
	giving, the current button masks for that player, \Var*{paddr} (the Lumos device address
	for that player), and the \Var{m} and \Var{e} flags configured for that player from the most recent
	Player Setup command.
\end{QS*}

\begin{NotImplemented}
\subsection{\z{0x704}: Define Sequence}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{4} \\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{id}} \\
	\wordbox{1}{\Var*{N}$-$1} \\
	\begin{rightwordgroup}{\Var*{N} bytes}
	\wordbox[ltr]{1}{\Var*{data}}\\
	\skippedwords\\
	\wordbox[lrb]{1}{}
	\end{rightwordgroup}\\
  \bitbox{1}{\z0} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[br]{1}{\z0}\\
  \bitbox{1}{\z0} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z0} 
	& \bitbox[b]{1}{\z1} 
	& \bitbox[br]{1}{\z1}
\end{BF}
Downloads a new sequence \Var*{data} of \Var*{N} bytes in length into the Lumos controller.  This sequence
will be known with the given \Var*{id}.  If a sequence is stored as \Var*{id}=0, it will be executed
automatically whenever the Lumos board is reset.  It cannot explicitly be invoked by a command from the
host PC.

Sequences with \Var*{id} in the range 0--63 are stored in permanent \acronym{EEPROM} memory and will
remain in the controller even after a reset or power cycle.  Those with \Var*{id} in the range 64--127
are stored temporarily in \acronym{RAM} memory and will be lost when the device resets.

\subsection{\z{0x705}: Execute Stored Sequence}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{5}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{id}}
\end{BF}
Starts executing the stored sequence with the given \Var*{id}.  If another sequence was
in progress, it is stopped.  If \Var*{id}=0, the current sequence is stopped without
starting a new one.

\subsection{\z{0x706}: Define Sensor Action}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{6}\\
	\bitbox{1}{\z0} & \bitbox{1}{\Var{o}} & \bitbox{1}{\Var{w}} & \bitbox{1}{\Var{e}} & \bitbox{2}{\color{lightgray}\rule{\width}{\height}}

		& \bitbox{2}{\Var*{id}} \\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{pre}}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{exec}}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{post}}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z0}
\end{BF}
Defines the action to be taken when the sensor \Var*{id} triggers.  (\Var*{id}=0 is sensor A,
\Var*{id}=1 is B, 
\Var*{id}=2 is C, and
\Var*{id}=3 is D.)
The sensor is triggered on the rising edge if \Var{e}=1, or the falling edge if \Var{e}=0.

When that sensor is triggered, any currently executing sequence is stopped.  Then the sequence
number \Var*{pre} is executed once.  The \Var{exec} sequence will be executed one time if \Var{o}=1, or
repeatedly while the sensor continues to be active if \Var{w}=1; if neither of those bits is set, the sequence loops forever until explicitly stopped.\footnote{The action if both bits are set is undefined.}
When the sensor is no longer triggering, \Var*{exec} plays on until it completes, then \Var*{post} is
run once.

Note that if another sensor triggers or an ``Execute Stored Sequence'' command is run, it immediately
stops the current sequence and all associated sequences.  This may cause \Var*{post} to not execute.


\subsection{\z{0x707} Mask Sensors}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{7}\\
	\bitbox{1}{\z0} 
		& \bitbox{3}{\color{lightgray}\rule{\width}{\height}}
		& \bitbox{1}{A}
		& \bitbox{1}{B}
		& \bitbox{1}{C}
		& \bitbox{1}{D}
\end{BF}
Sets input sensor masks for the given sensors.  If the mask value is 1, that sensor is ignored.
If the mask is 0, it is responded to normally.

\subsection{\z{0x708} Erase All Stored Sequences}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{8}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[br]{1}{\z1}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z1}
\end{BF}
All stored sequences are erased.
\end{NotImplemented}

\subsection{\z{0x709} Forbid Configuration Mode}\label{cmd:xpriv}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{9}
\end{BF}
Turns off configuration mode (if the board was in that mode at the time), and
prevents the board from going into configuration mode in the future.  Once the board is
reset or power-cycled, it may again be placed into configuration mode.  

This command is intended to replace command \z{0x774} (see p.~\pageref{cmd:xprivold}), since it can be
used regardless of whether the Lumos board is already in configuration mode at the time.  This makes
it a better choice than \z{0x774} as a general-purpose initialization step to ensure boards stay in
normal run mode during a performance.  Command \z{0x774} is therefore deprecated and may disappear
in the future.

%\begin{QS}
%\subsection{\z{0x70a}: QS Query}
%\begin{BF}
%	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
%	\bitbox{1}{\z0} & \bitbox{7}{10} \\
%	\bitbox{1}{\z0} &
%	\bitbox{1}{\z1} &
%	\bitbox{1}{\z1} &
%	\bitbox{1}{\z0} &
%	\bitbox{1}{\z0} &
%	\bitbox{1}{\Var{b}} &
%	\bitbox{1}{\Var{p}} &
%	\bitbox{1}{\Var{s}} \\
%\end{BF}
%This command solicits a status report from the addressed QS unit.  The specific type
%of query depends on the \Var{b} and \Var{p} bits:
%\begin{center}
% \begin{tabular}{ccl}\\\toprule
%  \bfseries\Var{b} & \bfseries\Var{p} & \bfseries Query Type \\\midrule
%  \z0 & \z0 & Full query---return measured times for every button.\\
%  \z0 & \z1 & Ping only---just verify that the unit is still responsive.\\
%  \z1 & \z0 & Button report---the states (not times) of all buttons.\\
%  \z1 & \z1 & Undefined.\\\bottomrule
% \end{tabular}
%\end{center}
%If the \Var{s} flag is set (\Var{s}=1), the scanner is halted.  This and any subsequent
%query commands will show the last-measured state of the buttons (but no further changes
%will be made to those measurements until the scanner is reset and restarted).
%The response packet is shown in Figures~\ref{bb:qsquery-reply1}--\ref{bb:qsquery-reply5}.
%
%\begin{figure}
%\begin{QS*}
%\begin{BF}
%  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
%  \bitbox{1}{\z0} & \bitbox{7}{29}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & \bitbox{6}{0} \\
%  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & 
%	\bitbox[b]{1}{\z1} &
%	\bitbox[b]{1}{\z0} &
%	\bitbox[b]{1}{\z1} &
%	\bitbox{3}{0}\\
%\end{BF}
%\caption{\z{0x71d} [reply] Response to Ping-Only QS Query\label{bb:qsquery-reply1}}
%\end{QS*}
%\end{figure}
%
%\begin{figure}
%\begin{QS*}
%\begin{BF}
%  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
%  \bitbox{1}{\z0} & \bitbox{7}{29}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\strut\Var{s}} & \bitbox{6}{2} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\color{blue}\rule{\width}{\height}} & 
%	\bitbox{1}{\strut\Var{a}} &
%	\bitbox{1}{\strut\Var{b}} &
%	\bitbox{1}{\strut\Var{c}} &
%	\bitbox{1}{\strut\Var{d}} &
%	\bitbox{1}{\strut\Var{l}} &
%	\bitbox{1}{\strut\Var{x}} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\color{blue}\rule{\width}{\height}} & 
%	\bitbox{1}{\strut\Var{A}} &
%	\bitbox{1}{\strut\Var{B}} &
%	\bitbox{1}{\strut\Var{C}} &
%	\bitbox{1}{\strut\Var{D}} &
%	\bitbox{1}{\strut\Var{L}} &
%	\bitbox{1}{\strut\Var{X}} \\
%  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & 
%	\bitbox[b]{1}{\z1} &
%	\bitbox[b]{1}{\z0} &
%	\bitbox[b]{1}{\z1} &
%	\bitbox{3}{2}\\
%\end{BF}
%\caption{\z{0x71d} [reply] Response to Button State QS Query (QSCC)\label{bb:qsquery-reply2}}
%\end{QS*}
%\end{figure}
%
%\begin{figure}
%\begin{QS*}
%\begin{BF}
%  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
%  \bitbox{1}{\z0} & \bitbox{7}{29}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\strut\Var{s}} & \bitbox{6}{3} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\strut\Var{l$_3$}} &
%	\bitbox{1}{\strut\Var{X$_3$}} &
%	\bitbox{1}{\strut\Var{x$_3$}} &
%	\bitbox{1}{\strut\Var{L$_0$}} &
%	\bitbox{1}{\strut\Var{l$_0$}} &
%	\bitbox{1}{\strut\Var{X$_0$}} &
%	\bitbox{1}{\strut\Var{x$_0$}} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\strut\Var{l$_4$}} &
%	\bitbox{1}{\strut\Var{X$_4$}} &
%	\bitbox{1}{\strut\Var{x$_4$}} &
%	\bitbox{1}{\strut\Var{L$_1$}} &
%	\bitbox{1}{\strut\Var{l$_1$}} &
%	\bitbox{1}{\strut\Var{X$_1$}} &
%	\bitbox{1}{\strut\Var{x$_1$}} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\color{blue}\rule{\width}{\height}} & 
%	\bitbox{1}{\strut\Var{L$_4$}} &
%	\bitbox{1}{\strut\Var{L$_3$}} &
%	\bitbox{1}{\strut\Var{L$_2$}} &
%	\bitbox{1}{\strut\Var{l$_2$}} &
%	\bitbox{1}{\strut\Var{X$_2$}} &
%	\bitbox{1}{\strut\Var{x$_2$}} \\
%  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & 
%	\bitbox[b]{1}{\z1} &
%	\bitbox[b]{1}{\z0} &
%	\bitbox[b]{1}{\z1} &
%	\bitbox{3}{3}\\
%\end{BF}
%\caption{\z{0x71d} [reply] Response to Button State QS Query (QSRC)\label{bb:qsquery-reply3}}
%\end{QS*}
%\end{figure}
%
%\begin{figure}
%\begin{QS*}
%\begin{BF}
%  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
%  \bitbox{1}{\z0} & \bitbox{7}{29}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\strut\Var{s}} & \bitbox{6}{26} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\color{blue}\rule{\width}{\height}} & 
%	\bitbox{1}{\strut\Var{a}} &
%	\bitbox{1}{\strut\Var{b}} &
%	\bitbox{1}{\strut\Var{c}} &
%	\bitbox{1}{\strut\Var{d}} &
%	\bitbox{1}{\strut\Var{l}} &
%	\bitbox{1}{\strut\Var{x}} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\color{blue}\rule{\width}{\height}} & 
%	\bitbox{1}{\strut\Var{A}} &
%	\bitbox{1}{\strut\Var{B}} &
%	\bitbox{1}{\strut\Var{C}} &
%	\bitbox{1}{\strut\Var{D}} &
%	\bitbox{1}{\strut\Var{L}} &
%	\bitbox{1}{\strut\Var{X}}
%  \begin{rightwordgroup}{\(\times 6\): X, L, A, B, C, D}\\
%	\wordbox[lrt]{1}{\strut\Var*{time}}\\
%	\wordbox[lr]{1}{(32-bit value}\\
%	\wordbox[lr]{1}{$\times$ \SI{100}{\nano\second})}\\
%	\wordbox[lrb]{1}{X button}\\
%	\wordbox[]{1}{$\vdots$ \\[1ex]} 
%	\end{rightwordgroup}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & 
%	\bitbox[bt]{1}{\z1} &
%	\bitbox[bt]{1}{\z0} &
%	\bitbox[bt]{1}{\z1} &
%	\bitbox{3}{2}\\
%\end{BF}
%\caption{\z{0x71d} [reply] Response to Full QS Query (QSCC)\label{bb:qsquery-reply4}}
%\end{QS*}
%\end{figure}
%
%\begin{figure}
%\begin{QS*}
%\begin{BF}
%  \bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
%  \bitbox{1}{\z0} & \bitbox{7}{29}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\strut\Var{s}} & \bitbox{6}{43} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\strut\Var{l$_3$}} &
%	\bitbox{1}{\strut\Var{X$_3$}} &
%	\bitbox{1}{\strut\Var{x$_3$}} &
%	\bitbox{1}{\strut\Var{L$_0$}} &
%	\bitbox{1}{\strut\Var{l$_0$}} &
%	\bitbox{1}{\strut\Var{X$_0$}} &
%	\bitbox{1}{\strut\Var{x$_0$}} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\strut\Var{l$_4$}} &
%	\bitbox{1}{\strut\Var{X$_4$}} &
%	\bitbox{1}{\strut\Var{x$_4$}} &
%	\bitbox{1}{\strut\Var{L$_1$}} &
%	\bitbox{1}{\strut\Var{l$_1$}} &
%	\bitbox{1}{\strut\Var{X$_1$}} &
%	\bitbox{1}{\strut\Var{x$_1$}} \\
%  \bitbox{1}{\z0} &
%	\bitbox{1}{\color{blue}\rule{\width}{\height}} & 
%	\bitbox{1}{\strut\Var{L$_4$}} &
%	\bitbox{1}{\strut\Var{L$_3$}} &
%	\bitbox{1}{\strut\Var{L$_2$}} &
%	\bitbox{1}{\strut\Var{l$_2$}} &
%	\bitbox{1}{\strut\Var{X$_2$}} &
%	\bitbox{1}{\strut\Var{x$_2$}} \\
%  \begin{rightwordgroup}{\(\times 10\): X$_0$, L$_0$, X$_1$, L$_1$, etc.}
%  \wordbox[lrt]{1}{\strut\Var*{time}}\\
%	\wordbox[lr]{1}{(32-bit value}\\
%	\wordbox[lr]{1}{$\times$ \SI{100}{\nano\second})}\\
%	\wordbox[lrb]{1}{X button}\\
%	\wordbox[]{1}{$\vdots$ \\[1 ex]}
%	\end{rightwordgroup}\\
%  \bitbox{1}{\z0} & \bitbox{1}{\Var{s}} & 
%	\bitbox[bt]{1}{\z1} &
%	\bitbox[bt]{1}{\z0} &
%	\bitbox[bt]{1}{\z1} &
%	\bitbox{3}{3}\\
%\end{BF}
%\caption{\z{0x71d} [reply] Response to Full QS Query (QSRC)\label{bb:qsquery-reply5}}
%\end{QS*}
%\end{figure}
%Note the different forms of reply which may be returned.  In these replies,
%\Var{s}=1 means the scanner is still running.  Button states \Var{x}, \Var{l}, etc. are 1 if the
%button has been pressed and counted or 0 if not.  Masks \Var{X}, \Var{L}, etc. are 1 if the button
%is masked out (ignored).
%
%In the full response, a 32-bit time value is returned, which is the number of tenths of microseconds that elapsed from
%the time the scanner started until the button was pressed.  The bytes are sent in big-endian
%order (starting with the most significant, ending with the least).  This block of times is
%preceded by the two-bit button flags as in the button-status-only query.  
%The two flag bits have this meaning (assuming \Var{m} is the mask bit and \Var{p} is the
%button-pressed bit as described above):
%\begin{center}
% \begin{tabular}{ccl}\toprule
%  \bfseries\Var{m} & \bfseries\Var{p} & \bfseries Meaning \\\midrule
%   \z0 & \z0 & Still waiting for input on this button.\\
%   \z0 & \z1 & Button pressed within indicated time.\\
%   \z1 & \z0 & Button locked out, will not be checked.\\
%   \z1 & \z1 & Currently autolocked, check again.\\
%\bottomrule
% \end{tabular}
%\end{center}
%At least theoretically, it's possible for a button to be pressed in less than \SI{0.1}{\micro\second} from
%the start time, which would result in the 32-bit value \z{0x00000000}, so don't rely only on the
%time value alone.
%
%
%\subsection{\z{0x70b}: Set Button Masks}
%For QSCC Units:
%\begin{BF}
%	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
%	\bitbox{1}{\z0} & \bitbox{7}{11} \\
%	\bitbox{1}{\z{0}}&
%	\bitbox{1}{\z{0}}&
%	\bitbox{1}{\strut\Var{a}}&
%	\bitbox{1}{\strut\Var{b}}&
%	\bitbox{1}{\strut\Var{c}}&
%	\bitbox{1}{\strut\Var{d}}&
%	\bitbox{1}{\strut\Var{l}}&
%	\bitbox{1}{\strut\Var{x}}\\
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z1}&
%	\bitbox{1}{\z1}&
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z0}
%\end{BF}
%For QSRC Units:
%\begin{BF}
%	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
%	\bitbox{1}{\z0} & \bitbox{7}{11} \\
%	\bitbox{1}{\z{0}}&
%	\bitbox{1}{\z{0}}&
%	\bitbox{1}{\strut\Var{l$_2$}}&
%	\bitbox{1}{\strut\Var{x$_2$}}&
%	\bitbox{1}{\strut\Var{l$_1$}}&
%	\bitbox{1}{\strut\Var{x$_1$}}&
%	\bitbox{1}{\strut\Var{l$_0$}}&
%	\bitbox{1}{\strut\Var{x$_0$}}\\
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z1}&
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\z0}&
%	\bitbox{1}{\strut\Var{l$_4$}}&
%	\bitbox{1}{\strut\Var{x$_4$}}&
%	\bitbox{1}{\strut\Var{l$_3$}}&
%	\bitbox{1}{\strut\Var{x$_3$}}
%\end{BF}
%The main ``X'' button is masked out (ignored) if \Var{x}=1, or is enabled for input
%if \Var{x}=0.  Likewise for the other buttons as indicated.
%
%\subsection{\z{0x70c}: Display Text}
%\begin{BF}
%	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
%	\bitbox{1}{\z0} & \bitbox{7}{12} \\
%	\bitbox{1}{\z0} & \bitbox{1}{\z0} & \bitbox{6}{\Var*{n}} \\
%	\begin{rightwordgroup}{\Var*{n} bytes}
%	\wordbox[ltr]{1}{\Var*{message}}\\
%	\skippedwords\\
%	\wordbox[lrb]{1}{}
%	\end{rightwordgroup}\\
%	\bitbox{1}{\z0} & \bitbox{1}{\z1} &
%	\bitbox{1}{\z0} & \bitbox{1}{\z1} &
%	\bitbox{1}{\z0} & \bitbox{1}{\z1} &
%	\bitbox{1}{\z0} & \bitbox{1}{\z1}\\
%\end{BF}
%The text string \Var*{message} is displayed on the scoreboard, replacing any previous image.  A zero-length
%\Var*{message}) (i.e., \Var{n}=0) will blank the display completely.  The character set as currently defined
%is shown in Table~\ref{tbl:textcodes}.
%\begin{table}
% \begin{center}
%  {\color{blue}
%  \begin{tabular}{ll}\toprule
%	\bfseries Byte & \bfseries Character \\\midrule
%	\z{0x00} & Large ``0'' (no slash) \\
%	\z{0x01} & Large ``1'' \\
%	\z{0x02} & Large ``2'' \\
%	\z{0x03} & Large ``3'' \\
%	\z{0x04} & Large ``4'' \\
%	\z{0x05} & Large ``5'' \\
%	\z{0x06} & Large ``6'' \\
%	\z{0x07} & Large ``7'' \\
%	\z{0x08} & Large ``8'' \\
%	\z{0x09} & Large ``9'' \\
%	\z{0x0a} & Large ``X'' \\
%	\z{0x0b} & Large down-arrow \\
%	\z{0x0c} & Half fill pattern \\
%	\z{0x0d} & Diagonal fill \\
%	\z{0x0e} & Checkerboard \\
%	\z{0x0f} & Reverse down-arrow \\
%	\midrule
%	\z{0x10} & Tiny ``0'' (no slash) \\
%	\z{0x11} & Tiny ``1'' \\
%	\z{0x12} & Tiny ``2'' \\
%	\z{0x13} & Tiny ``3'' \\
%	\z{0x14} & Tiny ``4'' \\
%	\z{0x15} & Tiny ``5'' \\
%	\z{0x16} & Tiny ``6'' \\
%	\z{0x17} & Tiny ``7'' \\
%	\z{0x18} & Tiny ``8'' \\
%	\z{0x19} & Tiny ``9'' \\
%	\z{0x1a} & Tiny period \\
%	\z{0x1b} & Undefined \\
%	\z{0x1c} & Undefined \\
%	\z{0x1d} & Undefined \\
%	\z{0x1e} & Copyright ``\copyright'' \\
%	\z{0x1f} & Solid block \\
%	\midrule
%	\z{0x20}--\z{0x7e} & Normal \acronym{ASCII} characters\\
%	\z{0x7f} & Half-fill pattern \\
%	\bottomrule
%  \end{tabular}
% \caption{Text Message Character Codes\label{tbl:textcodes}}
% }
% \end{center}
%\end{table}
%
%
%\subsection{\z{0x70d}: Display Bitmap}
%\begin{BF}
%	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
%	\bitbox{1}{\z0} & \bitbox{7}{13}\\
%	\begin{leftwordgroup}{\(\times 7\) rows}
%	\begin{rightwordgroup}{8 bytes (64 pixels)}
%	\wordbox{1}{Left 8 bits}\\
%	\wordbox{1}{Next 8 bits}\\
%	\wordbox[]{1}{$\vdots$ \\[1 ex]}\\
%	\wordbox{1}{Right 8 bits}
%	\end{rightwordgroup}\\
%	\wordbox[]{1}{$\vdots$ \\[1 ex]}
%	\end{leftwordgroup}\\
%	\bitbox{1}{\z0} & \bitbox{1}{\z1} &
%	\bitbox{1}{\z1} & \bitbox{1}{\z0} &
%	\bitbox{1}{\z0} & \bitbox{1}{\z1} &
%	\bitbox{1}{\z1} & \bitbox{1}{\z0}\\
%\end{BF}
%An arbitrary \(64\times7\) bitmap image is displayed on the scoreboard.  Note that the first and last
%two columns are not visible on these signs, so you really get an effective drawing space of
%\(60\times7\) pixels, centered horizontally.  The raw bits (1=pixel lighted, 0=dark) are transmitted
%in the data portion of the command, starting with the top left pixel, continuing across and down to 
%the bottom right pixel.
%
%This image replaces the previously-displayed image, if any.
%\end{QS}
%
\begin{QS}
	\subsection{\z{0x70a} Set Button Lockout Time}
	\begin{BF}
		\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
		\bitbox{1}{\z0} & \bitbox{7}{10}\\
%		\bitbox{1}{\z0} & 
%			\bitbox[b]{1}{\z0} &
%			\bitbox[b]{1}{\z0} &
%			\bitbox[b]{1}{\z0} &
%			\bitbox[b]{1}{\z0} &
%			\bitbox[b]{1}{\z0} &
%			\bitbox[b]{1}{\z0} &
%			\bitbox[br]{1}{\z0} \\
		\wordbox[ltr]{1}{Lockout}\\
		\wordbox[lr]{1}{time (\SI{}{\micro\second})}\\
		\wordbox[lr]{1}{MSB first}\\
		\wordbox[lbr]{1}{(4 bytes)}\\
		\bitbox{1}{\z0} & 
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z1} &
			\bitbox[br]{1}{\z0} \\
		\bitbox{1}{\z0} & 
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z1} &
			\bitbox[br]{1}{\z0} \\
	\end{BF}
	This sets the lock-out duration in microseconds. Any button pressed
	while the scanner is off will be locked out for this duration of time
	\emph{after the button is released} before it is eligible for being
	counted as pressed again. Setting the lockout time to 0 (zero) disables
	the lockout feature entirely.

	\subsection{\z{0x70b} Set Button Masks}
	\begin{BF}
		\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
		\bitbox{1}{\z0} & \bitbox{7}{11} \\
		\bitbox{1}{\z0} & 
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z0} &
			\bitbox[br]{1}{\z0} &
			\bitbox{4}{\Var*{player}}\\
		\bitbox{1}{\z0} &
			\bitbox{1}{\z0} &
			\bitbox{1}{\Var{\strut d}} &
			\bitbox{1}{\Var{\strut c}} &
			\bitbox{1}{\Var{\strut b}} &
			\bitbox{1}{\Var{\strut a}} &
			\bitbox{1}{\Var{\strut l}} &
			\bitbox{1}{\Var{\strut x}} \\
		\bitbox{1}{\z0} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z0} &
			\bitbox[b]{1}{\z1} &
			\bitbox[b]{1}{\z1} &
			\bitbox[br]{1}{\z0} \\
	\end{BF}
	Sets the button masks for player \Var*{player}. For each button
	\Var*{a}, \Var*{b}, etc., a 1 means to mask out the button so it
	is ignored, while a 0 returns the button to normal operation.
	\newpage

	\subsection{\z{0x70c} Player Setup}
	\begin{BF}
		\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
		\bitbox{1}{\z0} & \bitbox{7}{12} \\
		\bitbox{1}{\z0} & \bitbox{7}{\Var*{n}}\\
		\begin{rightwordgroup}{Repeat \Var*{n} times}
		\bitbox{1}{\z0} & \bitbox{1}{\color{lightgray}\rule{\width}{\height}}
			& \bitbox{1}{\Var{m}}
			& \bitbox{1}{\Var{e}}
			& \bitbox{4}{\Var*{paddr}}\\
		\wordbox[]{1}{$\vdots$ \\[1ex]}
		\end{rightwordgroup}\\
		\bitbox{1}{\z0} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tbr]{1}{\z0} \\
	\end{BF}
	Assigns Lumos device addresses for the first \Var*{n} player positions.
	You may, but are not required to, include the player positions directly
	controlled by the \acronym{QSMC} unit unless you wish to disable their
	lockout signalling.

	Players starting at \Var*{n}+1 will be given a default behavior of 
	direct signalling for players controlled by the \acronym{QSMC} and no
	signalling for the others.

	If the flag \Var{m}=\z1, this player is controlled by a
	\acronym{QSXT} unit plugged into the external bus of the \acronym{QSMC}.
	As such, this and all following players up to, but not including, player \#8
	are mapped to player \#0--\#7 of the \acronym{QSXT} unit.

	If your system consists of 16 players using simple button devices, you
	would plug a \acronym{QSXT} unit as the only player device on the external bus.
	This means players \#0--\#7 are controlled by the \acronym{QSXT} and \#8--\#15
	are controlled by the \acronym{QSMC}.

	If you have, say, three \acronym{QSCC} units followed by a \acronym{QSXT} on the 
	external bus, then players \#0--\#2 are controlled by the three \acronym{QSCC} units,
	players \#3--\#7 are controlled by the \acronym{QSXT} (which it will locally consider
	to be its player \#0--\#4), and as always the last 8 players will be controlled
	by the \acronym{QSMC}.

	If flag \Var{e}=\z1, lockout signalling is enabled for this player. The Lumos device
	with address \Var*{paddr} will be notified to carry out the signal in case a button
	for that player is locked out. If \Var{e}=\z0, no lockout signalling will be sent
	for that player.

\begin{table}
	\begin{QS*}
		\begin{center}
			\begin{tabular}{rlll}\\\toprule
				\bfseries Channel &
				\bfseries \acronym{QSMC} &
				\bfseries \acronym{QSXT} &
				\bfseries \acronym{QSCC} \\\midrule
				0 & player 8 X red  & player 0 X red & X red \\
				1 & player 8 X green  & player 0 X green & X green \\
				2 & player 8 X blue  & player 0 X blue & X blue \\
				3 & player 8 L light  & player 0 L light & L red \\
				4 & player 9 X red  & player 1 X red & L green \\
				5 & player 9 X green  & player 1 X green & L yellow \\
				6 & player 9 X blue  & player 1 X blue & nameplate red \\
				7 & player 9 L light  & player 1 L light & nameplate green \\
				8 & player 10 X red  & player 2 X red & nameplate blue \\
				9 & player 10 X green  & player 2 X green & A light \\
				10& player 10 X blue  & player 2 X blue & B light \\
				11& player 10 L light  & player 2 L light & C light \\
				12& player 11 X red  & player 3 X red & D light \\
				13& player 11 X green  & player 3 X green & spare output \\
				14& player 11 X blue  & player 3 X blue \\
				15& player 11 L light  & player 3 L light \\
				16& player 12 X red  & player 4 X red \\
				17& player 12 X green  & player 4 X green \\
				18& player 12 X blue  & player 4 X blue \\
				19& player 12 L light  & player 4 L light \\
				20& player 13 X red  & player 5 X red \\
				21& player 13 X green  & player 5 X green \\
				22& player 13 X blue  & player 5 X blue \\
				23& player 13 L light  & player 5 L light \\
				24& player 14 X red  & player 6 X red \\
				25& player 14 X green  & player 6 X green \\
				26& player 14 X blue  & player 6 X blue \\
				27& player 14 L light  & player 6 L light \\
				28& player 15 X red  & player 7 X red \\
				29& player 15 X green  & player 7 X green \\
				30& player 15 X blue  & player 7 X blue \\
				31& player 15 L light  & player 7 L light \\
				32& spare output 38 & spare output 38 \\
				33& spare output 39 & spare output 39 \\
				34& spare output 40 & spare output 40 \\\bottomrule
			\end{tabular}
			\caption{QS* Device Lumos Channel Assignments\label{tbl:qslumoschannels}}
		\end{center}
	\end{QS*}
\end{table}
				
\subsection{\z{0x70d} Reserve Display Space}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{13} \\
	\bitbox{1}{$\gamma$} &
	\bitbox{1}{\strut\Var{g}} &
	\bitbox{1}{\strut\Var{f}} &
	\bitbox{1}{\strut\Var{e}} &
	\bitbox{1}{\strut\Var{d}} &
	\bitbox{1}{\strut\Var{c}} &
	\bitbox{1}{\strut\Var{b}} &
	\bitbox{1}{\strut\Var{a}} \\
	\bitbox{1}{$\delta$} &
	\bitbox{1}{\strut\Var{n}} &
	\bitbox{1}{\strut\Var{m}} &
	\bitbox{1}{\strut\Var{l}} &
	\bitbox{1}{\strut\Var{k}} &
	\bitbox{1}{\strut\Var{j}} &
	\bitbox{1}{\strut\Var{i}} &
	\bitbox{1}{\strut\Var{h}} \\
	\bitbox{1}{$\epsilon$} &
	\bitbox{1}{\strut\Var{u}} &
	\bitbox{1}{\strut\Var{t}} &
	\bitbox{1}{\strut\Var{s}} &
	\bitbox{1}{\strut\Var{r}} &
	\bitbox{1}{\strut\Var{q}} &
	\bitbox{1}{\strut\Var{p}} &
	\bitbox{1}{\strut\Var{o}} \\
	\bitbox{1}{$\zeta$} &
	\bitbox{1}{$\beta$} &
	\bitbox{1}{$\alpha$} &
	\bitbox{1}{\strut\Var{z}} &
	\bitbox{1}{\strut\Var{y}} &
	\bitbox{1}{\strut\Var{x}} &
	\bitbox{1}{\strut\Var{w}} &
	\bitbox{1}{\strut\Var{v}} \\
	\bitbox{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tbr]{1}{\z1} \\
\end{BF}
Reserves characters in the \acronym{QSMC}'s alphanumeric display for
use by the game software. The \acronym{QSMC} firmware will avoid overwriting
those character positions as it normally would, so the host computer may
write into them using the Lumos commands documented in this section.

Each character is represented here with a single bit, with the leftmost character
shown as \Var{a} and so on to $\zeta$ as the rightmost character. If the corresponding
bit is \z1, that character is reserved for host computer use; if \z0, then the \acronym{QSMC}
may use it to indicate its own operational status.

Note that regardless of this reservation, the leftmost digit will always
be overwritten to show error status.
\end{QS}

\subsection{\z{0x70e} Enter Configuration Mode}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{14} \\
	\bitbox{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tbr]{1}{\z1} \\
	\bitbox{1}{\z0} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tbr]{1}{\z0} \\
	\bitbox{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z1} &
		\bitbox[tb]{1}{\z0} &
		\bitbox[tbr]{1}{\z0} \\
\end{BF}
Enables configuration mode, unless a previous command forbade the unit
from doing this. 

{\bfseries This command appeared starting with Protocol 1.}

\begin{QS*}
\subsection{\z{0x70f} Signal Button Lockout}
\begin{BF}
	\bitbox{1}{\z1} &
	\bitbox{3}{7} &
	\bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} &
	\bitbox{7}{15} \\
	\bitbox{1}{\z0} & \bitbox{3}{\color{lightgray}\rule{\width}{\height}}&
	\bitbox{4}{\Var*{player}} \\
	\bitbox{1}{\z0} &
	\bitbox{1}{\z0} &
	\bitbox{1}{\Var{\strut\Var{d}}} &
	\bitbox{1}{\Var{\strut\Var{c}}} &
	\bitbox{1}{\Var{\strut\Var{b}}} &
	\bitbox{1}{\Var{\strut\Var{a}}} &
	\bitbox{1}{\Var{\strut\Var{l}}} &
	\bitbox{1}{\Var{\strut\Var{x}}} &
\end{BF}

This command instructs the unit to signal to the player that one or more
of their buttons have been locked out due to pressing or holding them
before buttons are legally in play. 

The \Var*{player} will be \z0 for single-player devices, or the local
player number for multi-player devices. The bits \Var{a}--\Var{d},
\Var{l}, and \Var{x} are \z1 if that button is locked out or \z0 if
it is not.

The expected behavior is for one or more of these commands to be received
when the lockout status is detected, and eventually another which clears
the status when the lockout period has expired.
\end{QS*}

\subsection{Reserved Command Codes}
Codes \z{0x70a}--\z{0x70d} and \z{0x70f}--\z{0x71d} are reserved for future commands.  \z{0x71e}--\z{0x71f} are currently used
for response packets from the Lumos controller.
\begin{QS*}
	\z{0x70a}--\z{0x70d} and \z{0x70f} are used for QS-specific commands.
	\z{0x71b}--\z{0x71d} are used for the response packet for QS query commands.
\end{QS*}

Lumos 48-channel power controllers reserve codes \z{0x720}--\z{0x73F} for internal use.

Codes \z{0x740}--\z{0x77F} are for configuration-mode commands.
\newpage
\begin{QS}
\subsection{\z{0x71b} [reply] Button Query Full Status Response}
	\begin{BF}
		\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
		\bitbox{1}{\z0} & \bitbox{7}{27}\\
		\bitbox{1}{\z0} & \bitbox{1}{\strut\Var{s}} & \bitbox{1}{\strut\Var{D}}
			& \bitbox{5}{\Var*{n}} \\
		\begin{rightwordgroup}{Repeat \Var*{n} times}
			\wordbox[ltr]{1}{X button}\\
			\wordbox[lr]{1}{timestamp}\\
			\wordbox[lr]{1}{(4 bytes,}\\
			\wordbox[lrb]{1}{MSB first)}\\
			\wordbox[ltr]{1}{L button}\\
			\wordbox[lr]{1}{timestamp}\\
			\wordbox[lr]{1}{(4 bytes,}\\
			\wordbox[lrb]{1}{MSB first)}\\
			\wordbox[ltr]{1}{A button}\\
			\wordbox[lr]{1}{timestamp}\\
			\wordbox[lr]{1}{(4 bytes,}\\
			\wordbox[lrb]{1}{MSB first)}\\
			\wordbox[ltr]{1}{B button}\\
			\wordbox[lr]{1}{timestamp}\\
			\wordbox[lr]{1}{(4 bytes,}\\
			\wordbox[lrb]{1}{MSB first)}\\
			\wordbox[ltr]{1}{C button}\\
			\wordbox[lr]{1}{timestamp}\\
			\wordbox[lr]{1}{(4 bytes,}\\
			\wordbox[lrb]{1}{MSB first)}\\
			\wordbox[ltr]{1}{D button}\\
			\wordbox[lr]{1}{timestamp}\\
			\wordbox[lr]{1}{(4 bytes,}\\
			\wordbox[lrb]{1}{MSB first)}
		\end{rightwordgroup}\\
		\bitbox{1}{\z0} & \bitbox{1}{\Var{s}} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tbr]{1}{\z1}
	\end{BF}
	This packet is sent upon request to indicate the full current
	status of all buttons in play.  For each button, a 32-bit big-endian
	value is sent, giving the time in microseconds from the start of the
	button scan to the time the button was pressed. 

	There are a few special values for the timestamp value as listed
	in Table~\ref{tbl:buttontimestamps}.
	\begin{table}
		\begin{center}
			\begin{QS*}
			\begin{tabular}{rl}\toprule
				\bfseries Timestamp & \bfseries Meaning \\\midrule
				\z{0x00000000} & button not pressed \\
				\z{0x00000001} & button masked out \\
				\z{0x00000002} & button was locked out at time of scan \\
				\z{0x00000003} & reserved \\
				\z{0x00000004} & reserved \\
				\z{0x00000005} & reserved \\
				\z{0x00000006} & reserved \\
				\z{0x00000007} & reserved \\
				$>$\z{0x00000007}& button press time in \SI{}{\micro\second} \\\bottomrule
			\end{tabular}
			\caption{Special Timestamp Values\label{tbl:buttontimestamps}}
			\end{QS*}
		\end{center}
	\end{table}

	(If a button was somehow miraculously pressed in less than \SI{8}{\micro\second},
	it will be reported as 8 to distinguish it from the special cases; a
	button pressed after the maximum time possible to represent in 32 bits---just
	over 71.5 minutes---it will be given a maximum time value of
	\z{0xFFFFFFFF}.)

	If \Var*{s}=1, the button scanner is still running; otherwise it has
	stopped and these results represent the final state of the buttons.
	(The results won't be cleared until the next scan is started, so another
	query may still be made to get the results again, until that happens.)

	If \Var*{D}=1, the button scanner is entirely disabled (so it cannot scan
	for illegal button presses to enforce the lockout time).

\subsection{\z{0x71c} [reply] Button Query ``Ping'' Response}
	\begin{BF}
		\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}}\\
		\bitbox{1}{\z0} & \bitbox{7}{28}\\
		\bitbox{1}{\z0} & \bitbox{1}{\strut\Var{s}} & \bitbox{1}{\strut\Var{D}}
			& \bitbox{5}{\Var*{n}} \\
		\begin{rightwordgroup}{Repeat \Var*{n} times}
		\bitbox{1}{\z0} & \bitbox{1}{\z0}
			& \bitbox{1}{\Var{\strut d}}
			& \bitbox{1}{\Var{\strut c}}
			& \bitbox{1}{\Var{\strut b}}
			& \bitbox{1}{\Var{\strut a}}
			& \bitbox{1}{\Var{\strut l}}
			& \bitbox{1}{\Var{\strut x}}\\
		\wordbox[]{1}{$\vdots$ \\[1ex]}
		\end{rightwordgroup}\\
		\bitbox{1}{\z0} & \bitbox{1}{\Var{s}} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tb]{1}{\z0} &
			\bitbox[tb]{1}{\z1} &
			\bitbox[tbr]{1}{\z0}
	\end{BF}
	This packet is sent by the button controller upon request to show
	which buttons have been pressed so far. This is a shorter report
	than the full button status response (above) which does not indicate
	which buttons were pressed first or in what order.

	If \Var*{s}=1, the button scanner is still running. The button
	values \Var*{a}, \Var*{b}, etc., are 1 if the button was pressed
	or 0 if it was not.

	If \Var*{D}=1, the button scanner is entirely disabled (so it cannot scan
	for illegal button presses to enforce the lockout time).

\subsection{\z{0x71d} [reply] Button Status \acronym{NAK}}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{29}
\end{BF}
	The host PC may request that these packets be sent while waiting
	for button presses to avoid a communications timeout.
\end{QS}

\subsection{\z{0x71e} [reply] Query \acronym{NAK}}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{30}
\end{BF}
When the host PC sends a ``query'' command to the Lumos controller, the ultimate response will be
the reply packet documented on page~\pageref{bb:query-reply}.  However, if there will be a delay
before the Lumos controller is ready to provide that response, it may send this ``\acronym{NAK}''
packet to indicate that it's not yet ready to reply.  This keeps the host PC from timing out and
abandoning the controller's reply.

The PC should assume that the full query response is forthcoming and should 
continue waiting for it.  No additional poll is required.  Any number of
\acronym{NAK} packets may be sent by the Lumos controller between the PC's
query request and the Lumos board's full query response packet.  [Currently
(\acronym{ROM} version 3.1) the Lumos board never sends \acronym{NAK} packets,
but may do so in the future.]


\section{\z{0x720}--\z{0x73f}: Reserved}
These codes are reserved for internal use by the Lumos system and may not be used externally.

\section{\z{0x740}--\z{0x77f}: Configuration-Mode Commands}
These commands make changes to the state of the device in some manner which requires the device to
be in configuration mode.  If these are encountered outside configuration mode, they will be 
rejected.

\subsection{\z{0x74}$x$ [config] Set Phase Offset}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{3}{4} & \bitbox{2}{\color{lightgray}\rule{\width}{\height}} & \bitbox{2}{\Var*{P$_1$}}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{P$_0$}}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z0}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[br]{1}{\z1}
\end{BF}
Sets the controller's phase offset to \Var*{P}, which is a 9-bit value in the range 0--511:
		\begin{center}\begin{bytefield}{9}
			\bitheader{0,6,7,8}\\
			\bitbox{2}{\Var*{P$_1$}} & \bitbox{7}{\Var*{P$_0$}}\\
		\end{bytefield}\end{center}
This affects the internal timing mechanism within the Lumos controller used to synchronize
dimmer pulses to the AC waveform (for AC controllers).  It shouldn't need to be changed.
{\bfseries This command is only recognized if the controller is in configuration mode.}
\begin{QS*}Not implemented on QS* devices.\end{QS*}

\subsection{\z{0x76}$x$ [config] Set Device Address}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{3}{6} & \bitbox{4}{\Var*{addr$'$}}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z1}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z1}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z0}
\end{BF}
Changes the address of unit from \Var*{addr} to \Var*{addr$'$}.  This is effective immediately, so the
very next command must be addressed to \Var*{addr$'$} for this unit to respond to it.
{\bfseries This command is only recognized if the controller is in configuration mode.}

\subsection{\z{0x770} [config] Cancel Configuration Mode}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{112}
\end{BF}
Cancel configuration mode and return to normal operating mode.  From this point forward,
commands marked ``[config]'' will no longer be recognized.
{\bfseries This command is only recognized if the controller is in configuration mode.}

\subsection{\z{0x771} [config] Configure Device}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{113}\\
	\bitbox{1}{\z0} 
		& \bitbox{1}{\Var{A}}
		& \bitbox{1}{\Var{B}}
		& \bitbox{1}{\Var{C}}
		& \bitbox{1}{\Var{D}}
		& \bitbox{1}{\Var{d}}
		& \bitbox{2}{\Var*{C$_1$}}\\
	\bitbox{1}{\z0} 
		\bitbox{7}{\Var*{C$_0$}}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[br]{1}{\z0}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z1}
\end{BF}
Sets general configuration parameters not already covered elsewhere in this command set.
Flags \Var{A}--\Var{D} control whether a given sensor input line is an input (1) or output (0).
If configured as inputs, the Lumos controller does not drive a voltage on them but watches for
a signal there to which the Lumos board will respond if programmed to do so.  If configured as outputs,
the Lumos controller assumes they are connected to diagnostic \acronym{LED}s and will drive them
with +5\,V to turn on the corresponding \acronym{LED}s and 0\,V to turn them off.

If flag \Var{d} is set (\Var{d}=1), the Lumos controller will operate in \acronym{DMX512} mode 
(however,
note that anytime it is in configuration mode, \acronym{DMX512} command reception is disabled and the
Lumos commands described here are recognized).  When \Var{d}=1, the first \acronym{DMX512} channel
claimed by this controller is channel \Var*{C}+1, which is a 9-bit value in the range 1--512:
		\begin{center}\begin{bytefield}{9}
			\bitheader{0,6,7,8}\\
			\bitbox{2}{\Var*{C$_1$}} & \bitbox{7}{\Var*{C$_0$}}\\
		\end{bytefield}\end{center}
This corresponds to Lumos controller channel 0.
{\bfseries This command is only recognized if the controller is in configuration mode.}

\subsection{\z{0x772} [config] Set Baud Rate}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{114}\\
	\bitbox{1}{\z0} & \bitbox{7}{\Var*{speed}}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[br]{1}{\z0}
\end{BF}
Sets the Lumos controller's baud rate as indicated by \Var*{speed}, according to the following
table:
\begin{center}
	\begin{tabular}{|r|r|}\hline
		{\bfseries \Var*{speed}} & {\bfseries Bits per Second}\\\hline\hline
		0 & 300\\\hline
		1 & 600  \\\hline
		2 & 1,200\\\hline
		3 & 2,400\\\hline
		4 & 4,800\\\hline
		5 & 9,600\\\hline
		6 & 19,200\\\hline
		7 & 38,400\\\hline
		8 & 57,600\\\hline
		9 & 115,200\\\hline
		10& 250,000\\\hline
	\end{tabular}
\end{center}
This setting does not affect \acronym{DMX512} mode, which always uses a fixed speed of
250,000\,bps.  
{\bfseries This command is only recognized if the controller is in configuration mode.}

\emph{Note that for 48-channel controllers, this also sets the intra-processor communication
speed (which the two microcontrollers use to coordinate their actions).  Setting this to a low
speed is not recommended.}

\subsection{\z{0x773} [config] Restore Factory Defaults}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{115}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z0}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[br]{1}{\z0}
\end{BF}
Restores the device to its original factory settings.  Note that, among other things, this
will change the device's address to 0 and its speed to 19,200\,bps.
{\bfseries This command is only recognized if the controller is in configuration mode.}

{\color{red}
\subsection{\z{0x774} [config] Forbid Configuration Mode}\label{cmd:xprivold}
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{116}
\end{BF}
Cancels configuration mode, returning to normal operating mode.  Additionally, this
command prevents the device from re-entering configuration mode from this point forward
until it is reset or power-cycled.
{\bfseries This command is only recognized if the controller is in configuration mode,}
but see command \z{0x709} on page~\pageref{cmd:xpriv}.

{\bfseries This command is deprecated in favor of command \z{0x709}, which is generally preferred since it can be used
in either run mode or configuration mode.  This command is only implemented on Protocol~0 devices.}
}

\subsection{\z{0x775} [config] Update Firmware Image}
\NotInQS
\begin{BF}
	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
	\bitbox{1}{\z0} & \bitbox{7}{117} \\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[br]{1}{\z1}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z0}\\
	\bitbox{1}{\z0} 
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z0}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z1}
		& \bitbox[b]{1}{\z0}
		& \bitbox[br]{1}{\z0}
\end{BF}
Initiates firmware update mode on the Lumos controller.  From this point forward, the controller
expects to receive the new firmware image using a special protocol.  If the board is reset during
this process, it remains in firmware update mode, since it may have an unusable firmware image
at this point.

See page~\pageref{man:lumosupgrade}
for full documentation about the \verb+lumosupgrade+ command used to perform this operation.

The protocol used between the \verb+lumosupgrade+ program and the Lumos board
is documented in section~\ref{sec:flashprogproto} below, starting on 
page~\pageref{sec:flashprogproto}.

{\bfseries This command is only recognized if the controller is in configuration mode.}


\subsection{Reserved Command Codes}
Codes \z{0x776}--\z{0x77f} are reserved for future use as configuration-mode commands.

%\begin{QS}
%\subsection{\z{0x776}: [config] Set QS Parameters}
%\begin{BF}
%	\bitbox{1}{\z1} & \bitbox{3}{7} & \bitbox{4}{\Var*{addr}} \\
%	\bitbox{1}{\z0} & \bitbox{7}{118} \\
%	\wordbox{1}{\Var*{lockout}}\\
%	\bitbox{1}{\z0} 
%		& \bitbox[b]{1}{\z0}
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[b]{1}{\z0}
%		& \bitbox[b]{1}{\z0}
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[br]{1}{\z0}\\
%	\bitbox{1}{\z0} 
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[b]{1}{\z0}
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[b]{1}{\z0}
%		& \bitbox[b]{1}{\z1}
%		& \bitbox[br]{1}{\z0}
%\end{BF}
%Sets QS-specific parameters.  
%
%If \Var*{lockout}>0, then any buttons pressed before the scanner begins
%running will cause an automatic temporary masking for \Var*{lockout} $\times$ \sfrac{1}{120}
%of a second after being released.  The default lockout time upon device power-up
%is \sfrac{1}{2} second.
%\end{QS}
%

\section{Firmware Update Protocol}
\NotInQS
\label{sec:flashprogproto}
Once the Lumos board has been placed in flash program mode via the 
\z{0x775} ``Update Firmware Image'' command (see above), all other 
normal operation of the Lumos board is suspended, including any of its
command protocols (Lumos native or \index{DMX512@\acronym*{DMX512}}\acronym*{DMX}).  In this mode, the
board communicates using a simple bidirectional serial protocol at a fixed
speed of 9600~baud, 8 bits, no parity.  This protocol is designed solely
for the purpose of uploading a new firmware image into the flash memory.

All communication is 7-bit-clean \acronym{ASCII} which won't be confused
as Lumos commands by any other listening units, but since the firmware
update happens at 9600~baud, we recommend disconnecting other units from
the network that aren't configured to run at that speed normally.

\subsection{Encoded Byte Values}\label{ss:flashbytes}
Most of the values sent using this protocol are encoded in a modified
form of hexadecimal---rather than using the characters \z{0123456789ABCDEF}
as the base-16 digits, the character set \z{@ABCDEFGHIJKLMNO} is used instead.
The most significant nybble is sent first, as would normally be the case
with hexadecimal representation of values.

This encoding makes it easier to encode and decode values, since the nybbles
are simply sent with the constant upper nybble value set to \z{0100}:
\begin{BF}
  \bitbox{1}{\z0} 
	& \bitbox{1}{\z1} 
	& \bitbox{1}{\z0} 
	& \bitbox{1}{\z0} 
	& \bitbox{4}{\Var*{value}}
\end{BF}

For example, the value \z{0x00} is encoded as \z{@@}, \z{0x12} as \z{AB},
and \z{0xFF} as \z{OO}.

\subsection{Address Encoding}\label{ss:blockid}
The firmware image is transmitted to the Lumos board in 64-byte blocks.  Each
block must be evenly aligned on a 64-byte address boundary, so
the least significant six bits of the address will always be zeroes.  Because
of this, the least significant nybble is never transmitted and is implied to
be zero.  

The 64-byte blocks are specified in the protocol by their ``block \acronym{ID}'' which is simply the more significant 16 bits of the block's address in
program memory.  Therefore, the block at memory address \z{0x12580}--\z{0x125BF}
would be known here as block \acronym{ID} \z{0x1258}.

When sent using this protocol, the nybbles of the block \acronym{ID} are 
sent from most significant nybble to least, encoded as described above.
For example, block \z{0x1258} would be transmitted as \z{ABEH}.

Valid block \acronym{ID} values may range from \z{0x0000}--\z{0x16FC}.

\subsection{Command Protocol}
Two commands are recognized in this mode: ``query'' and ``data.''

The ``query'' command is sent by the PC as a single character, `\z Q'.
This causes the Lumos board to respond with a result packet with status
code `\z*' (see below).  If the board was just reset and is ready to begin
the process of receiving a new image, it will respond to the query
with ``\z{OOOO@@@@*}''.

The ``data'' command sends a 64-byte block of firmware code to the Lumos
board.  The board will then burn that block into its flash memory and respond
with a result packet as described in the next section.  The data command
packet is always 137~bytes and has the form:
\begin{center}
\begin{bytefield}[endianness=little,bitwidth=2em]{8}
 \bitheader{0-7}\\
  \begin{rightwordgroup}{128 bytes\\for \Var*{data}}
  \bitbox{1}{\z>} &
  \bitbox{4}{\Var*{block \acronym{ID}}} &
  \bitbox{1}{\z|} &
  \bitbox[lrt]{2}{\Var*{data}}\\
  \wordbox[lr]{1}{}\\
  \skippedwords\\
  \wordbox[lr]{1}{}
  \end{rightwordgroup}\\
  \bitbox[lbr]{6}{} & \bitbox{2}{\Var*{check}}\\
  \bitbox{1}{\z.}
\end{bytefield}
\end{center}
The `\z>', `\z|', and `\z.' bytes are literal \acronym{ASCII} characters.
The other fields are described individually below:
\begin{description}
  \item[\Var*{block \acronym{ID}}] identifies the block being sent, encoded
	as described %in section~\ref{ss:blockid} 
	above.  The blocks may be 
	sent in any order, except for the requirement that block \z{0x0000}
	(encoded as \acronym{ID} \z{@@@@}) \emph{must be the very last block
	to be sent}.  Overwriting this block changes the boot vector for the
	microcontroller which then enables the device to execute the new
	firmware image the next time it is reset, so it is important that this
	be the last block written. 

	The act of successfully sending and burning block \acronym{ID} zero
	ends flash program mode.  Once that block is written, the device will
	automatically reset and resume normal Lumos controller board operation.
  \item[\Var*{data}] is the block of 64 bytes starting at the address implied
	by the block \acronym{ID}.  Since it's encoded as described %in section~\ref{ss:flashbytes} 
	above, it is transmitted as 128 
	\acronym{ASCII} characters.
  \item[\Var*{checksum}] is a one-byte checksum, encoded as two
	\acronym{ASCII} characters. %per \S\ref{ss:flashbytes}.  
	The checksum
	is a running 8-bit total of the two bytes of 
	\Var*{block \acronym{ID}} and each byte of \Var*{data}.  The two's
	complement of this total is encoded and sent in this field of the
	command.  Only the least significant 8~bits of the total are
	used for any part of this calculation. For example, if the 8-bit total
	of the block~\acronym{ID} and data bytes comes out to \z{0x47}, then
	we calculate its two's complement by inverting and adding one:
	\begin{center}
 	  \begin{tabular}{ccl}
	    \z{0x47} & =             & \z{01000111} \\
	    invert   & $\rightarrow$ & \z{10111000} \\
	    +1       & $\rightarrow$ & \z{10111001}
	  \end{tabular}
	\end{center}
	The checksum sent in this example would be \z{0xB9}, encoded into
	\acronym{ASCII} as ``\z{KI}''.
\end{description}

\subsection{Response Codes}
The response to the query or data commands is always a nine-byte packet
of the form:
\begin{center}
  \begin{bytefield}[endianness=little,bitwidth=2em]{8}
    \bitheader{0-7}\\
    \bitbox{4}{\Var*{block \acronym{ID}}} &
    \bitbox{2}{\Var*{x}} &
    \bitbox{2}{\Var*{y}} \\
    \bitbox{1}{\Var*{st}}
  \end{bytefield}
\end{center}
where:
\begin{description}
  \item[\Var*{block \acronym{ID}}] is the last-known block \acronym{ID}
	processed by the Lumos board.  If no block has been processed yet,
	this value will be \z{0xFFFF} (encoded as ``\z{OOOO}'') which is 
	never a valid block \acronym{ID}.
  \item[\Var*{x} and \Var*{y}] are extra data bytes 
	(encoded as two \acronym{ASCII} characters each) which provide
	additional information relevant to the particular \Var*{status}
	code being reported.
  \item[\Var*{st}] is a code indicating the result of the command.
	The possible status results are summarized in Figure~\ref{fig:flromstat}.
\end{description}
\begin{figure}
  \begin{center}
    \begin{tabular}{|c|c|c|l|}\hline
	\bfseries \Var*{st} & \bfseries\Var*{x} & \bfseries\Var*{y} & 
	\bfseries Description\\\hline\hline
	\z !& --- & --- & Invalid block \acronym{ID} given\\\hline
	\z *& --- & --- & Response to query command; board ready\\\hline
	\z b& --- & --- & Burn error writing to flash memory\\\hline
	\z k& --- & --- & Data received and burned successfully\\\hline
	\z n&\z{0x00}&\z{0x00}& Data packet format error\\\hline
	\z n& $x$    &\z{0x00}& Checksum error, calculated to be $x$\\\hline
	\z n& $x$    &\z{0x40}& Illegal character $x$ received\\\hline
	\z n&\z{0xFF}&\z{0xFF}& Unrecognized command packet\\\hline
	\z v& $x$ & $y$ & Verification error: value $y$ read $x$ bytes from end\\\hline
    \end{tabular}
  \end{center}
  \caption{Firmware Update Protocol Response Codes\label{fig:flromstat}}
\end{figure}

For example, after successfully burning block \z{0x045C}, the Lumos board
will send the result ``\z{@DEL@@@@k}''.

\index{command protocol|)}

\chapter{DMX512 Command Structure}\label{ch:dmx}
\begin{NotImplemented*}{Support for \acronym{DMX512} is included in the Lumos firmware but has not
been tested to be reliable yet, and in fact may not function at all.  The information that follows
is experimental.  If you have \acronym{DMX512} equipment, expertise, and willingness to help develop
this feature of Lumos further, contact the author.}
When configured in \acronym{DMX512} mode, none of the Lumos commands documented in Chapter~\ref{ch:proto}
are recognized. The Lumos controller will be only looking for \acronym{DMX512} command packets.
To use the Lumos commands for configuration of the board (e.g., to turn off \acronym{DMX512} mode or change
the starting channel number), activate configuration mode using the \acronym{OPTION} button.  That will disable \acronym{DMX512} mode for the time the device is in configuration mode.

The \acronym*{DMX} protocol always uses a fixed speed of 250,000 baud.  There is only one packet type 
recognized by a Lumos controller.  All other packets are silently ignored.

A packet begins with a ``break'' condition on the line.  Immediately following the break is a sequence
of one or more bytes of data.  The first byte must be a zero (other values for this initial byte are used
to send other kinds of \acronym{DMX512} packets, but we're not interested in those so they are simply
ignored).

After the zero byte there will be up to 512 channel value bytes.  (It is permissible for the packet to end
before all 512 channel values have been sent.)  The Lumos controller is configured to have a starting address
within the \acronym{DMX512} ``universe.'' This corresponds to Channel~0 of the Lumos controller.  For example,
if a Lumos controller were configured to \acronym{DMX512} channel 10, then it would ignore the first nine
bytes of channel values in each packet.  The tenth byte would set the output value of the controller's Channel~0, the next byte would set the output level for Channel~1, and so on, up to the thirty-forth byte
which sets Channel~23 (for a 24-channel controller), or the fifty-eighth byte which sets Channel~47 (for
a 48-channel controller).

If the packet ends before the Lumos controller has received enough bytes to set all of its channels,
the remaining channels simply keep their previously-known output values.

The bytes in these packets are 8-bit values, directly giving the channel output values of 0--255, with 0
being fully off and 255 being fully on.

A packet has the general form shown in Figure~\ref{fig:dmx}. Note that \acronym{DMX512} 
channel numbers start with 1.
\begin{figure}
 \begin{BF}
%  \wordbox[tlr]{1}{Break}\\
%  \skippedwords\\
%  \wordbox[lrb]{1}{($\ge$92\,$\mu$S)}\\
%  \wordbox[tlr]{1}{Mark}\\
%  \skippedwords\\
%  \wordbox[lrb]{1}{($\ge$12\,$\mu$S)}\\
  \begin{rightwordgroup}{Start signal}
	  \wordbox{1}{Break ($\ge$\SI{92}{\micro\second})}\\
	  \wordbox{1}{Mark ($\ge$\SI{12}{\micro\second})}\\
  \end{rightwordgroup}\\
  \begin{rightwordgroup}{Data packet}
  \wordbox{1}{0}\\
  \wordbox{1}{\Var*{value$_1$}}\\
  \wordbox{1}{\Var*{value$_2$}}\\
  \wordbox{1}{\Var*{value$_3$}}\\
  \wordbox[]{1}{$\vdots$ \\[1ex]} \\
  \wordbox{1}{\Var*{value$_{512}$}}
  \end{rightwordgroup}
 \end{BF}
 \caption{DMX Packet\label{fig:dmx}}
\end{figure}
\end{NotImplemented*}
\chapter{Theory of Operation}\label{ch:too}
\LLstart{T}{he}{Lumos controller boards} provide 256 levels of dimmer control on their
output channels by using \ix{pulse width modification} (\acronym{PWM}).  That is, each output
is always either fully ``on'' (0\,V output) or ``off'' (+5\,V output) at any instant in
time, but cycles between on and off states so that, for example, if a channel is set
to 50\%, it will be fully on half the time and fully off half the time.  This is
illustrated in Figure~\ref{fig:dutycycle}.
\input dutycycle

Each half-wave period (1/120\,s for the 60\,Hz power frequency standard
used in many countries such as the \acronym{USA})\footnote{The AC-powered Lumos boards 
are not designed to work in environments where the power frequency is not 60\,Hz.  DC-powered
boards will work regardless, since they never see the AC power directly.} is divided
into 260 ``slices'' of approximately 0.000032051\,s each.  (See Figure~\ref{fig:slices}.)
An output channel may change
state at one of those slice boundaries.  This provides for 256 different output levels 
to be supported, plus a couple of idle slices at the beginning and end to make 
sure the \acronym{TRIAC}s are fully off before the next zero-crossing point begins.
(You'll note in the timing diagrams that the outputs are always turned off a very tiny fraction
of a second before the start of the next output cycle.)
\input slices


For the intended application of these controllers---incandescent lamps for the AC
boards and \acronym{LED}s for the DC boards---this produces the visual effect of the light
being dimmed.  Note that not all devices can tolerate being supplied power like this,
so you need to make an informed decision about what to plug into a Lumos 
controller.\footnote{You might think it's an acceptable risk to attach one of these loads, such as a
``non-dimmable'' \acronym{CFL} light, if you tell the Lumos board to only turn it on
or off, and never use the dimmer settings.  In theory, that might be ok, all other things
being equal, but you're trusting that your host PC software won't accidentally command
the board to do something to fade that output, or a stored sequence won't do that,
or a glitch in communications won't be misinterpreted as such, or even that a firmware
bug on the controller won't cause this. It's an informed risk you can decide whether to take, but
we don't officially recommend it.} This is similar to many household dimmers, so as a general
rule of thumb, a light (such as a \acronym{CFL}) marked as ``non-dimmable'' should not
be dimmed by a Lumos board.  Damage to the Lumos board and the lamp may result.

For DC loads, this \acronym{PWM} signal appears as-is on the output channel (although
inverted).  Note that the frequency of these pulses is 1/120\,s, which should be
sufficient to avoid visible ``flicker'' for both incandescent and \acronym{LED} lights.
This is shown in Figure~\ref{fig:dcdutycycle}.
\input dcdutycycle

Dimming AC loads works along similar lines, but the \acronym{TRIAC} outputs on those
controllers require that these timing pulses be synchronized to the points where the AC
power waveform crosses the 0\,V line.  The reason for this is that \acronym{TRIAC}s, once
turned on, stay on as long as power is applied to them, even if the controlling gate signal
turns off.  So the only opportunity to delay them from switching on is at a zero-crossing
point.  The 48-channel controller board uses its built-in power supply to sense the
AC zero-crossing point and makes that available to the on-board logic, which will base its channel outputs
on that timing signal.

This means that the AC waveform which appears at the output of the relay board starts part-way
into each half-cycle, as shown in Figure~\ref{fig:acdutycycle}.
\input acdutycycle

The DC controllers produce a 120\,Hz timing pulse internally so they are consitent with the
AC controllers, but this doesn't need to be synchronized with anything external.

\section{Phase Offset}
There is an obscure device setting called ``\ix{phase offset}'' on the Lumos controllers which adds a
delay between the receipt of the zero-crossing signal and the time of the actual zero-crossing
event.  This compensates for the effect of the controller's AC supply being out of phase with the
load AC supply.  (In the very first prototype Lumos design, the detector circuit needed this but
that is no longer the case.)  
In practice, there shouldn't be any phase difference between the controller's
supply and the load supply which would require changing this offset.  Note that being 180$^\circ$
out of phase---such as being supplied from separate ``sides'' of a residential AC breaker panel---doesn't 
matter here, since they have the same zero-crossing point.)

We will now describe how the phase offset works in the internal timing chain of the Lumos
controller firmware, in case you should find yourself in some strange circumstance where you need
to change this setting.  Otherwise, use the normal setting for this value (2).

The timing diagram for the controller's output update cycle is shown in Figure~\ref{fig:timingchain}.
Note the green AC waveform as perceived by the zero-crossing detector vs.\ the blue actual waveform
present at the loads.  The phase offset is compensating for this difference.
\input timingchain

When the \ix{zero-crossing} detector senses 0\,V on the incoming power line, it triggers an interrupt
on the Lumos microcontroller (\mc{INT} on the diagram).  This starts the phase delay timer which
counts down a number of slices equal to the ``phase offset'' setting (normally~2).  Once that many
slices have gone by, the ``working slices'' begin.  During each of these slices, various output
channels are turned on in order for each of them to generate the desired \acronym{PWM}
duty cycle.

Assuming that the interrupt arrives at the actual zero-crossing event, as it ideally should,
the default phase offset delay of 2 means that we get two
idle slices before the 256 working slices begin, and two idle slices at the end.  This compensates for
any slight timing errors thay may creep into the cycle as well as ensuring the \acronym{TRIAC}s 
settle as already described.  This is shown in Figure~\ref{fig:timingideal}.
\input timingideal

\section{Output Relay Circuits}
The output solid-state relays (\acronym{SSR}s) used by the Lumos boards are variations of the standard
\acronym{SSR} design used within the \acronym{DIY} animated lighting community over the years (see p.~\pageref{sec:legacy}).  For DC boards, this is a high-power \acronym{MOSFET} circuit, while for AC boards, this is a \acronym{TRIAC}.
In both cases, the relay is intended to control a simple \index{load, resistive}resistive load 
(typically incandescent and \acronym{LED}
lights).  They are not designed to control inductive loads (e.g., motors or flourescent lights).  If you intend
to use those types of loads with these \acronym{SSR}s, you will need to add protective circuitry (such as an
additional, higher-power \acronym{SSR} or a ``\ix{snubber}'' circuit) to the Lumos circuit, which is outside the
design scope of the Lumos board.  Such a modification requires qualified engineering design and should not be
attempted by the end user.

%The specific circuit needed depends on your load, determined by a qualified electrician or other
%appropriately qualified person.  The general idea is to place an appropraitely-sized resistor
%and capacitor across the \acronym{SSR} output like so:
%
%XXX figure needed XXX
%% R=100 C=.1 across MT1, MT2 of triac or across driving pins of mosfet
%\begin{figure}
%\caption{Example Snubber Circuit (adapt as needed)\label{fig:snubber}}
%\end{figure}

\backmatter
\appendix
\renewcommand\thechapter{A}
\counterwithin{figure}{chapter}
\counterwithin{table}{chapter}

\chapter{Diagnostic Codes}
\section{Decoding \acronym{LED} Patterns}
The front panel \acronym{LED}s provide an indication of the state of the Lumos controller.
During boot, they rapidly change to indicate the phase of the initialization process being
performed.  If the device gets stuck during that process, the \acronym{LED} pattern will indicate
where the problem occurred.  During normal runtime operation, they inform the user of the
mode and status of the system, errors encountered, etc.

The various codes are summarized in Figure~\ref{fig:leds}.  4-channel controllers use the same 
pattern as the 24-channel controllers.
\begin{figure}
 \begin{tikzpicture}
  \node [above right] at (2,11) {\strut Description of Condition/Fault Indicated};
  \node [above right] at (0,11) {\strut 48-ch};
  \node [above right] at (1,11) {\strut 24-ch};
  \draw (0,11) -- (10,11);
  \def\y{10}
  \light{A}{off}\light{G}{off}\light{Y}{off}\light{R}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[boot] Boot process not yet started};
  \def\y{9}
  \light{A}{off}\light{G}{off}\light{Y}{off}\light{R}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[boot] \acronym{EEPROM} setup stage};
  \def\y{8}
  \light{A}{off}\light{G}{off}\light{Y}{on}\light{R}{on}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[boot] \acronym{EEPROM} write operation};
  \def\y{7}
  \light{A}{off}\light{G}{off}\light{Y}{on}\light{R}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[boot] \acronym{EEPROM} read operation / system initialization};
  \def\y{6}
  \light{A}{off}\light{G}{on}\light{Y}{on}\light{R}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[boot] system initialization};
  \def\y{5}
  \light{A}{off}\light{G}{on}\light{Y}{off}\light{R}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[boot] system initialized but main loop/timing system non-functional};
  \def\y{4}
  \light{A}{ffl}\light{G}{ffl}\light{Y}{ffl}\light{R}{ffl}\light{G2}{ffl}\light{Y2}{ffl}\light{R2}{ffl}
  \node [right] at (2,\y) {[run] factory defaults restored (will now reboot)};
  \def\y{3}
  \light{A}{off}\light{G}{sfd}\light{Y}{off}\light{R}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[run] normal run mode};
  \def\y{2}
  \light{A}{blk}\light{G}{sfd}\light{Y}{x}\light{R}{x}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[run] received command addressed to this unit};
  \def\y{1}
  \light{A}{off}\light{G}{ffl}\light{Y}{off}\light{R}{off}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[config] configuration mode};
  \def\y{0}
  \light{A}{x}\light{G}{x}\light{Y}{blk}\light{R}{x}\light{G2}{x}\light{Y2}{blk}\light{R2}{x}
  \node [right] at (2,\y) {[run] intra-processor communication activity};
  \def\y{-1}
  \light{A}{x}\light{G}{x}\light{Y}{x}\light{R}{on}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[run] command rejected (invalid, bad arguments, disallowed, etc.)};
  \def\y{-2}
  \light{A}{x}\light{G}{x}\light{Y}{on}\light{R}{ffl}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[run] communications error (framing error)};
  \def\y{-3}
  \light{A}{x}\light{G}{x}\light{Y}{ffl}\light{R}{ffl}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[run] communications error (overrun error)};
  \def\y{-4}
  \light{A}{x}\light{G}{x}\light{Y}{sfd}\light{R}{ffl}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[run] communications error (device buffer overflow)};
  \def\y{-5}
  \light{A}{ffl}\light{G}{sfd}\light{Y}{ffl}\light{R}{off}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[run] internal fault detected};
  \def\y{-6}
  \light{A}{off}\light{G}{sfl}\light{Y}{sfl}\light{R}{sfl}\light{G2}{sfl}\light{Y2}{sfl}\light{R2}{sfl}
  \node [right] at (2,\y) {[sleep] in sleep mode};
  \def\y{-7}
  \light{A}{off}\light{G}{off}\light{Y}{off}\light{R}{sss}\light{G2}{off}\light{Y2}{off}\light{R2}{sss}
  \node [right] at (2,\y) {[halt] system halted (shutdown) normally};
  \def\y{-8}
  \light{A}{ffl}\light{G}{off}\light{Y}{ffl}\light{R}{ffl}\light{G2}{off}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {[halt] system failure while trying to halt};
  \def\y{-9}
  \light{A}{x}\light{G}{x}\light{Y}{x}\light{R}{ffl}\light{G2}{x}\light{Y2}{x}\light{R2}{x}
  \node [right] at (2,\y) {[halt] system failure (exact error on other \acronym{LED}s)};
  
    
%  \def\ON#1#2#3{\CO{#1}{#2}{#3} \draw (#1,#2) circle (.1);}
%  \def\CO#1#2#3{\draw [fill, color=#3] (#1,#2) circle (.1);}
%   \ON{.0}{.0}{yellow}\ON{.3}{.0}{green}\ON{.6}{.0}{yellow}\ON{.6}{.0}{red}
 \end{tikzpicture}
 \caption{Diagnostic \acronym{LED} Patterns\label{fig:leds}}
\end{figure}

\begin{figure}
 \begin{tikzpicture}
  \node [above right] at (2,10) {\strut Description of Condition/Fault Indicated};
  \node [above right] at (0,10) {\strut 48-ch};
  \node [above right] at (1,10) {\strut 24-ch};
  \draw (0,10) -- (10,10);
 \def\y{9}
  \light{A}{ffl}\light{G}{x}\light{Y}{ffl}\light{R}{off}\light{G2}{ffl}\light{Y2}{off}\light{R2}{off}
  \node [right] at (2,\y) {Dispatch table overrun};
 \def\y{8}
  \light{A}{ffl}\light{G}{x}\light{Y}{ffl}\light{R}{off}\light{G2}{x}\light{Y2}{off}\light{R2}{on}
  \node [right] at (2,\y) {Input validator failure};
 \def\y{7}
  \light{A}{ffl}\light{G}{x}\light{Y}{ffl}\light{R}{off}\light{G2}{ffl}\light{Y2}{ffl}\light{R2}{ffl}
  \node [right] at (2,\y) {Reset failure};
 \def\y{6}
  \light{A}{ffl}\light{G}{x}\light{Y}{ffl}\light{R}{off}\light{G2}{x}\light{Y2}{off}\light{R2}{ffl}
  \node [right] at (2,\y) {Hardware fault};
 \def\y{5}
  \light{A}{ffl}\light{G}{x}\light{Y}{ffl}\light{R}{off}\light{G2}{x}\light{Y2}{off}\light{R2}{sfd}
  \node [right] at (2,\y) {Internal command error};
 \def\y{4}
  \light{A}{ffl}\light{G}{x}\light{Y}{ffl}\light{R}{off}\light{G2}{off}\light{Y2}{ffl}\light{R2}{off}
  \node [right] at (2,\y) {Other/unknown failure};
 \end{tikzpicture}
 \caption{Internal Fault Condition Codes\label{fig:leds-errors}}
\end{figure}

\begin{figure}
 \begin{tikzpicture}
 \def\y{5}
  \light{Y2}{on} \node [right] at (1,\y) {steady on};
 \def\y{4.5}
  \light{Y2}{off} \node [right] at (1,\y) {steady off };
 \def\y{4}
  \light{Y2}{sfd} \node [right] at (1,\y) {slowly fading up/down};
 \def\y{3.5}
  \light{Y2}{ffd} \node [right] at (1,\y) {quickly fading up/down};
 \def\y{3}
  \light{Y2}{sfl} \node [right] at (1,\y) {slowly flashing};
 \def\y{2.5}
  \light{Y2}{ffl} \node [right] at (1,\y) {quickly flashing};
 \def\y{2}
  \light{Y2}{blk} \node [right] at (1,\y) {blink then fade once};
 \def\y{1.5}
  \light{Y2}{sss} \node [right] at (1,\y) {super-slow flashing};
 \def\y{1}
  \light{Y2}{x} \node [right] at (1,\y) {not involved or affected; may have any value};
 \end{tikzpicture}
\caption{Key to \acronym{LED} Patterns\label{fig:leds-key}}
\end{figure}

\begin{figure}
 \begin{tabular}{rl}
  \z{0x01} & Command interpreter dispatch overrun \\
  \z{0x02} & Pass-down command in non-master \acronym{ROM} (set level)\\
  \z{0x03} & Pass-down command in non-master \acronym{ROM} (bulk update)\\
  \z{0x05} & Command interpreter dispatch overrun (in state 6)\\
  \z{0x06} & Pass-down command in non-master \acronym{ROM} (ramp level)\\
  \z{0x07} & Command interpreter dispatch overrun (in state 9)\\
  \z{0x08} & Command interpreter dispatch overrun (in state 10, non-slave)\\
  \z{0x0A} & Bad sentinel byte in internal command\\
  \z{0x0B} & Command interpreter dispatch overrun (internal commands)\\
  \z{0x0C} & Command interpreter dispatch overrun (internal commands)\\
  \z{0x0D} & Command interpreter dispatch overrun (state 13)\\
  \z{0x0E} & Command interpreter dispatch overrun (state 17)\\
  \z{0x0F} & Could not determine \acronym{ROM} type (query)\\
  \z{0x10} & Operation on wrong \acronym{ROM} type (query)\\
  \z{0x11} & Device does not support T/$\overline{\hbox{R}}$ operation \\
  \z{0x12} & Code executed on wrong \acronym{ROM} (M/S communication) \\
  \z{0x20} & Invalid command\\
  \z{0x21} & Configuration-mode command outside configuration mode\\
  \z{0x22} & Command not implemented\\
  \z{0x23} & Command incomplete\\
  \z{0x70} & Failed to reset following factory default restore\\
 \end{tabular}
 \caption{Error Condition Codes Reported Via Query Command\label{fig:errcodes}}
\end{figure}



%\section{Numeric Error Codes}
\chapter{Lumos CLI Command Manual Entries}\label{ch:lumosctl}
This chapter provides the documentation for the \z{lumosasm}, \z{lumosctl}, and \z{lumosupgrade} commands.  
This same information is also
provided to the \acronym{CLI} user on Unix, Linux, or Macintosh systems via the \z{man} command.  

In this documentation, the following typographical conventions are used:
\begin{itemize}
	\item	\Var*{Variables}, which indicate values to be replaced with suitable values when you
		invoke the program, are shown in Italic type inside angle brackets.  (The angle brackets
		are not typed as part of the command syntax.)
	\item	\z{Literal text} which should be typed as-is, as well as the names of commands, is set
		in fixed-width text.
	\item	\emph{File names} are set in Italics.  Italics are also used for general points of emphasis.
	\item	{}[Optional values] are enclosed in square brackets.  These may be omitted if appropriate.
		(The brackets themselves are not typed as part of the command syntax.)
\end{itemize}
References to other program manual entries look like ``\z{lumosctl}(1)'' which indicates that the
\z{lumosctl} command is documented in section~1 of the manual, which is the section for general 
user commands on Unix-like systems.
\newpage
\index{lumosasm@\z{lumosasm}}
\section{NAME}
\noindent lumosasm -- Assemble stored sequences for download to a Lumos board

\medskip

\begin{NotImplemented*}{The \z{lumosasm} program is used to assemble descriptions of stored
sequences into the internal binary format recognized by the Lumos boards.  Since that feature is
not yet supported by Lumos boards, this section of the manual is blank until that feature is
fully defined.}
%\input lumosasm
\end{NotImplemented*}
\newpage
\index{lumosctl@\z{lumosctl}}
\input lumosctl
\newpage
\index{lumosupgrade@\z{lumosupgrade}}
\label{man:lumosupgrade}
\input lumosupgrade
\chapter{Troubleshooting}
While we anticipate the Lumos board will provide many hours of worry-free operation,
as with any device (particularly one built as a \acronym{DIY} project), sometimes things don't go
quite as planned.  Here are a few common problems and their solutions.

\begin{longtable}{|p{1.5in}|p{1.5in}|p{2in}|}\hline
\bfseries Symptom & \bfseries Likely Cause(s) & \bfseries Solution \\\hline\hline
\endhead
An entire block of outputs does not turn on 
	& No power to the block 
	& If the \mc{BLOCK PWR} light is off, check the fuse for that block, 
	  the connection from the power supply to the block, and that the power supply is powered on.\\
\cline{2-3}
	& Power supply not told to wake up (\mc{ATX}-style supplies only).
	& Check that the power supply's green wire is attached to the $\overline{\hbox{\mc{PWR CTL}}}$
	  terminal. \\
\cline{3-3}
	&& If the \acronym{LED}s on the board show that it is in sleep mode,  send it a ``wake'' command
	from the PC or just command it to turn on any output channel.
\\\hline
Some outputs don't work, or are erratic.
	& Loose % opto-isolator 
chip.
	& Lightly press chips back into their sockets.\\
\cline{2-3}
	& Bad solder connection or loose chip.
	& Re-check all solder connections on the board, re-solder any which are cold, broken, or
	  incomplete.\\\hline
No units in serial network respond to commands.
	& Missing terminator
	& Replace terminators on both ends of the daisy chain (note the PC's RS485 converter
	  may include a built-in terminator for that position).\\\hline
One unit does not respond to commands.
	& Wrong address.
	& Use the \verb+lumosctl+ program to reconfigure the board to have
	  the correct address.\\
\cline{2-3}
	& Blown communication fuse.
	& Replace fuse F3 (24-channel boards).\\\hline
\end{longtable}

If all else fails, try performing a factory reset as described in section \ref{ss:factoryreset} (page~\pageref{ss:factoryreset}).

\chapter{Glossary}\label{ch:glossary}
\begin{description}
	\item[Address:]
		The \mc{ID} number assigned to a particular device to uniquely distinguish it from the other
		devices plugged into the same serial connection.  The commands sent to Lumos boards all contain
		a ``target address'' which identifies the particular Lumos board which is to act on that command.
		All the other Lumos boards will ignore it.
	\item[Baud Rate:]
		The speed, in bits per second, of data that is transferred over a serial cable.  The term
		``baud'' refers to the number of electrical state changes per second made to perform the signalling.
		For the kind of signalling done by Lumos boards, the baud rate is the same as the bit-per-second rate,
		although for other applications such as high-speed modems, it would be more correct to refer to the
		bit-per-second (\acronym{BPS}) rate only.  Depending on the exact protocol settings used, one character
		takes approximately 10~bits to send, so a data rate of 9600~baud would send about 960 characters (bytes)
		per second.
	\item[Active Low:]
		A logic signal which is considered ``on'' when the signal is ``low'' (binary 0 or 0\,V),
		and ``off'' when the signal is ``high'' (binary 1 or +5\,V).  Lumos relay circuits are 
		triggered with active-low signals.
	\item[\acronym{CLI}]
		Command-line interface.  A program launched on the command-line, or ``shell,'' interface of the computer---the
		\z{cmd} window on Microsoft Windows, or the shell in a Mac \acronym{OSX} or Unix/Linux terminal window or
		\z{xterm}.  Typically \acronym{CLI} tools interact with the user via keyboard, often using a combination of
		``options'' or ``switches'' to control the program's behavior rather than using a mouse or other graphical
		interfaces.  Generally, \acronym{CLI} tools are easier to automate (to have the computer run them autonomously
		on a schedule or as needed) since most of them are designed to be run unattended, specifying all of the parameters needed right on the command line.
	\item[\acronym{DIY}:] ``Do-It-Yourself.''
	\item[Duplex:]
		a feature of a serial line.  On a full-duplex connection, separate data wires are present
		to carry data in both directions, so one device can send and receive data at the same time.
		On a half-duplex connection, only a single set of data wires is present, so devices must
		take turns transmitting over them.
	\item[Factory reset:]
		The process of resetting all user-configurable options on a device to their original state, as the
		device presumably was shipped ``in the box'' from its factory.  Lumos boards can be reset in this manner
		as described on page~\pageref{ss:factoryreset}.
	\item[Jumper Block:]
		A series of pins mounted to the \acronym{PCB}.  Different options are configured for the
		circuit by placing a \ix{jumper} over certain pairs of pins, shorting them together.
	\item[\acronym{LED} (Light Emitting Diode):]
		A special kind of diode which emits light when current passes from its anode to its cathode.
	\item[\acronym{MOSFET}:]
		The type of transistor which forms the major part of a Lumos DC relay channel.  The name
		is an acronym for Metal Oxide Semiconductor Field Effect Transistor.
	\item[\acronym{PCB} (Printed Circuit Board):]
		The board where electronic components are mounted to form a complete circuit.  Metal
		traces are ``printed'' (actually etched) onto the surface of the board itself to make the
		connections between components.
	\item[Power Cycle:]
		To turn the power off, then on, thus resetting the state of the device.  On a Lumos board,
		the same effect can be had by pressing the \acronym{RESET} button momentarily, although
		power cycling works, too.  Note that this does not undo any permanent settings such as device
		address or baud rate.  To return all settings to their original values, you must perform a
		full factory reset.
	\item[RS-232:]
		A standard hardware protocol for sending serial data between two devices (such as a computer
		and a modem or a single Lumos board).  Shielded cable should be used for best results, and
		the cable length should not exceed 25\,ft.
	\item[RS-485:]
		A standard hardware protocol for sending serial data between multiple devices on a single
		cable length (electrically it is a single cable which each device ``taps into'' along the
		line; physically it is typically a ``daisy chain'' arrangement where a short cable connects
		one device to the next, another cable to the next, and so on). Unshielded twisted-pair cable
		is used (like Ethernet cable), and the cable lengths should not exceed a total of 4,000\,ft
		(1,200\,m).
	\item[\acronym{SSR} (Solid-State Relay):] A device which controls an external power load.  In
		contrast to a mechanical relay, an \acronym{SSR} has no moving parts, but does its switching
		electronically.
	\item[Terminator Plug:]
		An RS-485 network requires a terminator at each end.  This is a small plug which plugs into
		the last unit in the daisy chain.
	\item[\acronym{TTL} (Transistor-Transistor Logic):] One of the ways digital logic circuits can be
		constructed.  For our purposes here, we consider a ``\acronym{TTL}-level'' signal to be a
		logic input or output where a voltage near +5\,V is ``high'' (binary 1 or ``true'') and a
		voltage near 0\,V is ``low'' (binary 0 or ``false'').  The inputs should never be above
		+5 nor below 0 volts.
\end{description}

\input acknowledgements

\indexintoc
\printindex
\clearpage

\input colophon

\end{document}
